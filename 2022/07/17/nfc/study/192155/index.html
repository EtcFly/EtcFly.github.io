<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top             概述 首先说明几个概念:   RFID: 无线射频识别即射频识别技术（Radio Frequency Identification，RFID），是自动识别技术的一种，通过无线射频方式进行非接触双向数据通信，利用无线射频方式对记录媒体（电子标"><meta property="og:type" content="article"><meta property="og:title" content="NFC学习之协议基础"><meta property="og:url" content="http://example.com/2022/07/17/nfc/study/192155/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top             概述 首先说明几个概念:   RFID: 无线射频识别即射频识别技术（Radio Frequency Identification，RFID），是自动识别技术的一种，通过无线射频方式进行非接触双向数据通信，利用无线射频方式对记录媒体（电子标"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/NFC.png"><meta property="article:published_time" content="2022-07-17T19:21:55.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="NFC"><meta property="article:tag" content="协议"><meta property="article:tag" content="近场通讯"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/NFC.png"><title>NFC学习之协议基础 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="NFC学习之协议基础"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-07-17 19:21" pubdate>2022年7月17日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6.2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 52 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">NFC学习之协议基础</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><h1 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h1><p>首先说明几个概念:</p><blockquote><ul><li><strong>RFID</strong>: 无线射频识别即射频识别技术（Radio Frequency Identification，RFID），是自动识别技术的一种，通过无线射频方式进行非接触双向数据通信，利用无线射频方式对记录媒体（电子标签或射频卡）进行读写，从而达到识别目标和数据交换的目的，其被认为是21世纪最具发展潜力的信息技术之一。</li></ul></blockquote><blockquote><ul><li><strong>NFC</strong>： NFC=Near Field Communication, 中文术语是近距离无线通信, 是一种采用13.56MHz频带的近距离无线通信技术，允许电子设备之间进行非接触式点对点式数据传输与交换(在10cm内)。这个技术由RFID技术演变而来，并向下兼容RFID，从这个概念来说：NFC属于RFID，NFC是RFID技术里的一个类别。</li></ul></blockquote><hr><h1 id="rfid卡类型"><a class="markdownIt-Anchor" href="#rfid卡类型"></a> RFID卡类型</h1><h2 id="卡类型"><a class="markdownIt-Anchor" href="#卡类型"></a> 卡类型</h2><p>关于卡的类型, 最常见的是<strong>IC卡</strong>, <strong>ID卡</strong></p><ul><li>IC卡: <code>IC卡</code>是一大类,其可以根据不同的分类标准继续细分。</li></ul><blockquote><ul><li>根据卡中所镶嵌的集成电路芯片的不同可以分成两大类，分别是 <strong>存储器卡</strong> 和 <strong>CPU卡(智能卡)</strong> .</li></ul><blockquote><p><strong>存储器卡</strong> 采用存储器芯片作为卡芯，只有“硬件”组成，包括<strong>数据存储器</strong>和<strong>安全逻辑控制</strong>等；<strong>智能卡</strong> 采用 <strong>微处理器芯片</strong> 作为卡芯，由硬件和软件共同组成，属于卡上单片机系统。</p></blockquote></blockquote><blockquote><ul><li>按卡上数据的读写方法来分类，有 <strong>接触型IC卡</strong> 和 <strong>非接触型IC卡</strong> 两种。</li></ul><blockquote><p>当前使用广泛的是 <strong>接触型IC卡</strong> ，其表面可以看到一个方型镀金接口，共有八个或六个镀金触点，用于与读写器接触，通过电流信号完成读写。读写操作（称为刷卡）时须将IC卡插入读写器，读写完毕，卡片自动弹出，或人为抽出。接触式IC卡刷卡相对慢，但可靠性高，多用于存储信息量大，读写操作复杂的场合。</p></blockquote></blockquote><blockquote><blockquote><p><strong>非接触型IC卡</strong> 具有接触式IC卡同样的芯片技术和特性，最大的区别在于卡上设有射频信号或红外线收发器，在一定距离内即可收发读写器的信号，因而和读写设备之间无机械接触。在前述IC卡的电路基础上带有射频收发及相关电路的非接触IC卡被称作“射频卡”或“RF卡”。 这种IC卡常用于身份验证，电子门禁等场合。卡上记录信息简单，读写要求不高，卡型变化也较大，可以作成徽章等形式。<br>因此，不但可以存储大量信息，具有极强的保密性能，并且抗干扰、无磨损、寿命长。因此在广泛的领域中得到应用</p></blockquote></blockquote><ul><li>ID卡: 只存储了<code>ID</code>号，设备识别ID号，没有算法可言，容易复制，安全性低；</li></ul><hr><h2 id="ic和id卡图片"><a class="markdownIt-Anchor" href="#ic和id卡图片"></a> IC和ID卡图片</h2><h3 id="ic卡存储卡"><a class="markdownIt-Anchor" href="#ic卡存储卡"></a> IC卡存储卡</h3><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213102.png" srcset="/img/loading.gif" lazyload alt="IC卡"></p><h3 id="ic智能卡cpu卡"><a class="markdownIt-Anchor" href="#ic智能卡cpu卡"></a> IC智能卡(CPU卡)</h3><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213159.png" srcset="/img/loading.gif" lazyload alt="image"></p><h3 id="id卡"><a class="markdownIt-Anchor" href="#id卡"></a> ID卡</h3><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213228.png" srcset="/img/loading.gif" lazyload alt="image"></p><hr><h2 id="nfc标签"><a class="markdownIt-Anchor" href="#nfc标签"></a> NFC标签</h2><p><strong>NFC标签</strong> 是一种基于IC存储卡上(采用<code>13.56MHz RFID</code>技术), 通过约定的存储格式和访问接口, 实现对NFC设备的标准化存取的一种设备。目前其支持 <code>ISO14443-A</code>, <code>ISO14443-B</code> 以及飞利浦的<code>MIFARE</code>标准。<br>故常称之为 <code>NFC-A</code>,<code>NFC-B</code> 以及 <code>NFC-F</code>类型, 其主要是表面链路层的编码方式。</p><p>目前 <strong>NFC标签</strong> 主要有如下几种类型:</p><blockquote><ul><li>第1类标签：简称<code>Type 1 Tag</code> 此类型基于ISO14443A标准。此类标签具有可读、重新写入的能力，用户可将其配置为只读。存储能力为96字节，用来存网址URL或其他小量数据富富有余。然而，内存可被扩充到2k字节。此类NFC标签的通信速度为106 kbit/s。此类标签简洁，故成本效益较好，适用于许多NFC应用</li></ul></blockquote><blockquote><ul><li>第2类标签：此类标签也是基于ISO14443A，具有可读、重新写入的能力，用户可将其配置为只读。其基本内存大小为48字节，但可被扩充到2k字节。通信速度也是106 kbit/s。</li></ul></blockquote><blockquote><ul><li>第3类标签：此类标签基于Sony FeliCa体系。目前具有2k字节内存容量，数据通讯速度为212 kbit/s。故此类标签较为适合较复杂的应用，尽管成本较高。</li></ul></blockquote><blockquote><ul><li>第4类标签：此类标签被定义为与ISO14443A、B标准兼容。制造时被预先设定为可读/可重写、或者只读。内存容量可达32k字节，通信速度介于106 kbit/s和424 kbit/s之间。</li></ul></blockquote><p>具体的NFC标签 协议标准, 参考</p><ul><li><em>&lt;NFC Forum Type 1 Tag Operation Specification 2.0.pdf&gt;</em></li><li><em>&lt;ISO14443 1-4(2008).pdf&gt;</em></li></ul><h1 id="标准和协议"><a class="markdownIt-Anchor" href="#标准和协议"></a> 标准和协议</h1><p>目前市面上使用的NFC卡主要是基于<code>ISO14443</code>协议标准, 因此主要有<code>TypeA</code>以及<code>TypeB</code> 型卡， <code>TypeA</code>和<code>TypeB</code>的区别在于链路层的编码方案不同。具体的后面再讲, 如下是·ISO14443`协议文档的分布。</p><blockquote><ul><li><em>Part 1: Physical characteristics</em> 主要的物理特性 比如卡、天线等的尺寸要求</li><li><em>Part 2: Radio frequency power and signal interface</em> 主要是调制频率, 信号调制比例等接口特性描述</li><li><em>Part 3: Initialization and anticollision</em> 主要是卡的冲撞检测 卡通讯等描述</li><li><em>Part 4 Transmission protocol</em> 主要是对新卡的一些协议支持 比如支持RATS以及PPS自动频率匹配</li></ul></blockquote><hr><h3 id="pcd-picc-方向进行数据传输时"><a class="markdownIt-Anchor" href="#pcd-picc-方向进行数据传输时"></a> <code>PCD ---&gt; PICC</code> 方向进行数据传输时</h3><p><code>TypeA</code>编码方案采用的是 <strong>米勒编码</strong>， <code>TypeB</code> 采用的是 <strong>不归零编码</strong><br>如下<br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213351.png" srcset="/img/loading.gif" lazyload alt="image"></p><h3 id="picc-pcd-方向进行数据传输时"><a class="markdownIt-Anchor" href="#picc-pcd-方向进行数据传输时"></a> <code>PICC ---&gt; PCD</code> 方向进行数据传输时</h3><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213437.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213541.png" srcset="/img/loading.gif" lazyload alt="image"></p><blockquote><p><strong>Note:</strong> 从上图可知, 不同类型的卡片是无法相互读取, 比如一个支持 <code>ISO14443-A</code>类型的读卡器是无法读取一张<code>TypeB</code> 类型的卡的，这个是物理层决定的。</p></blockquote><hr><p><code>ISO14443-3</code>协议数据交互帧主要有三种:</p><ul><li><p><em>short frames</em><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213629.png" srcset="/img/loading.gif" lazyload alt="image"></p></li><li><p><em>standard frames</em></p></li></ul><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213707.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213828.png" srcset="/img/loading.gif" lazyload alt="image"></p><ul><li><em>bit oriented anticollision frame</em><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213903.png" srcset="/img/loading.gif" lazyload alt="image"></li></ul><p>上述的三种帧的功能各不相同</p><blockquote><ul><li><strong>短帧</strong>: 主要用于设备通讯初期的初始化工作(因为接触初期数据非常不稳定, 所以数据量通讯较少, 确保通讯时长短, 增加寻卡的成功率)</li><li><strong>标准帧</strong>: 用于数据的交换， 主要是寻卡和选卡完成后的操作</li><li><strong>冲突帧</strong>：主要是用于当在感应区出现两个及以上PICC设备时冲突检测。</li></ul></blockquote><hr><h4 id="短帧的编码"><a class="markdownIt-Anchor" href="#短帧的编码"></a> 短帧的编码</h4><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213925.png" srcset="/img/loading.gif" lazyload alt="image"><br>如上图:</p><blockquote><p><code>REQA</code>：用于搜索感应区未睡眠的TypeA类型卡, 及请求卡数据(卡存在需要回应<code>ATQA</code>)。<br><code>WUPA</code>: 用于搜索感应区所有TypeA卡<br>其他均不常用</p></blockquote><p><strong>ATQA响应编码格式</strong>:<br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528213946.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://i.loli.net/2020/05/19/NStWjuHRGli5qvX.png" srcset="/img/loading.gif" lazyload alt="image"></p><h3 id="设备的初始化流程"><a class="markdownIt-Anchor" href="#设备的初始化流程"></a> 设备的初始化流程</h3><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214008.png" srcset="/img/loading.gif" lazyload alt="image"></p><p>主要分为如下几个步骤:</p><blockquote><p><strong>1、卡检测</strong>: 主要发生<code>REQA</code>和<code>WAUPA</code>类短帧命令, 如果接受到设备的<code>ATQA</code>响应, 那么可以进入步骤二来进行冲突检测。否则继续步骤1</p></blockquote><blockquote><p><strong>2、冲突检测</strong>: 冲突检测有三种情况, 对于不同卡情况不一样, 对于M1类型卡, 及通常的<code>MIFARE MINI</code> <code>MIFARE 1K</code> <code>MIFARE 4K</code>等加密卡, 其ID为4byte, 冲撞检测为一层, 但是对于<code>MIFARE Ultralight/Ultralight C</code>类型, 其ID为7byte，冲突检测为两层, 最该为3层,ID为10Byte。</p></blockquote><blockquote><p><strong>3、选卡</strong>: 发送特定命令选中感应区中的特定卡, 选中卡片后, 对于一些非加密卡, 这个时候就可以通过标准帧进行数据的读取, 但是如果是读取M1卡此类的具有硬件加密单元的，还需要进行密钥的验证。</p></blockquote><h3 id="冲突检测"><a class="markdownIt-Anchor" href="#冲突检测"></a> 冲突检测</h3><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214031.png" srcset="/img/loading.gif" lazyload alt="image"><br>上图为<code>PCD</code>进行冲突检测的步骤。可描述如下</p><blockquote><p><strong>1、一阶冲突检测</strong> : 及图中的1、2、3, 这个阶段发送冲突帧&lt;编码为0X93,0X20&gt;<br><strong>2、检测产生冲突点</strong>: 这个过程主要是读卡器硬件给出<br><strong>3、循环冲突检测</strong>: 通过对冲突点递增0X20，重新发生冲突帧进行检测&lt;编码为0X95/0X97, NVB, 卡ID&gt;<br><strong>4、选卡</strong>: 通过传输&lt;编码为0X3/0X95/0X97, NVB, ID&gt;进行选卡, 并返回卡类型<code>SAK</code></p></blockquote><p>那如何确定是几级冲突呢？ 其定义如下,其和设备的ID长度密切相关。<br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214054.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214113.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214222.png" srcset="/img/loading.gif" lazyload alt="image"></p><p><strong>此时我们就完成了设备的选择, 可以确定设备的类型</strong><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214248.png" srcset="/img/loading.gif" lazyload alt="image"><br>但是就单单从上图无法确定是什么类型的卡片，这是由于本协议<code>iso14443-3</code>协议较老。下面是我从其他地方摘取的类型代码。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">sak &amp;= <span class="hljs-number">0x7F</span>;<br>switch (sak) &#123;<br>	case <span class="hljs-number">0x04</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_NOT_COMPLETE;	<span class="hljs-comment">// UID not complete</span><br>	case <span class="hljs-number">0x09</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_MIFARE_MINI;<br>	case <span class="hljs-number">0x08</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_MIFARE_1K;<br>	case <span class="hljs-number">0x18</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_MIFARE_4K;<br>	case <span class="hljs-number">0x00</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_MIFARE_UL;<br>	case <span class="hljs-number">0x10</span>:<br>	case <span class="hljs-number">0x11</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_MIFARE_PLUS;<br>	case <span class="hljs-number">0x01</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_TNP3XXX;<br>	case <span class="hljs-number">0x20</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_ISO_14443_4;<br>	case <span class="hljs-number">0x40</span>:	<span class="hljs-keyword">return</span> PICC_TYPE_ISO_18092;<br>	default:	<span class="hljs-keyword">return</span> PICC_TYPE_UNKNOWN;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>对于M1加密卡类型,此时不能进行数据的读取, 还需要验证密钥来保证安全。</p></blockquote><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214339.png" srcset="/img/loading.gif" lazyload alt="image"></p><p>如图, 可以看到<code>Select Card</code>后还需要进行密钥的认证。才能进行读写块。如下为M1卡操作的常用命令<br>定义</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// Commands sent <span class="hljs-keyword">to</span> the PICC.<br>enum PICC_Command &#123;<br>    // The commands used <span class="hljs-keyword">by</span> the PCD <span class="hljs-keyword">to</span> manage communication <span class="hljs-keyword">with</span> several PICCs (ISO <span class="hljs-number">14443</span><span class="hljs-number">-3</span>, <span class="hljs-keyword">Type</span> A, section <span class="hljs-number">6.4</span>)<br>    PICC_CMD_REQA			= <span class="hljs-number">0x26</span>,		// REQuest command, <span class="hljs-keyword">Type</span> A. Invites PICCs <span class="hljs-keyword">in</span> state IDLE <span class="hljs-keyword">to</span> go <span class="hljs-keyword">to</span> READY <span class="hljs-keyword">and</span> <span class="hljs-keyword">prepare</span> <span class="hljs-keyword">for</span> anticollision <span class="hljs-keyword">or</span> selection. <span class="hljs-number">7</span> <span class="hljs-type">bit</span> frame.<br>    PICC_CMD_WUPA			= <span class="hljs-number">0x52</span>,		// Wake-UP command, <span class="hljs-keyword">Type</span> A. Invites PICCs <span class="hljs-keyword">in</span> state IDLE <span class="hljs-keyword">and</span> HALT <span class="hljs-keyword">to</span> go <span class="hljs-keyword">to</span> READY(*) <span class="hljs-keyword">and</span> <span class="hljs-keyword">prepare</span> <span class="hljs-keyword">for</span> anticollision <span class="hljs-keyword">or</span> selection. <span class="hljs-number">7</span> <span class="hljs-type">bit</span> frame.<br>    PICC_CMD_CT				= <span class="hljs-number">0x88</span>,		// <span class="hljs-keyword">Cascade</span> Tag. <span class="hljs-keyword">Not</span> really a command, but used during anti collision.<br>    PICC_CMD_SEL_CL1		= <span class="hljs-number">0x93</span>,		// Anti collision/<span class="hljs-keyword">Select</span>, <span class="hljs-keyword">Cascade</span> <span class="hljs-keyword">Level</span> <span class="hljs-number">1</span><br>    PICC_CMD_SEL_CL2		= <span class="hljs-number">0x95</span>,		// Anti collision/<span class="hljs-keyword">Select</span>, <span class="hljs-keyword">Cascade</span> <span class="hljs-keyword">Level</span> <span class="hljs-number">2</span><br>    PICC_CMD_SEL_CL3		= <span class="hljs-number">0x97</span>,		// Anti collision/<span class="hljs-keyword">Select</span>, <span class="hljs-keyword">Cascade</span> <span class="hljs-keyword">Level</span> <span class="hljs-number">3</span><br>    PICC_CMD_HLTA			= <span class="hljs-number">0x50</span>,		// HaLT command, <span class="hljs-keyword">Type</span> A. Instructs an ACTIVE PICC <span class="hljs-keyword">to</span> go <span class="hljs-keyword">to</span> state HALT.<br>    PICC_CMD_RATS           = <span class="hljs-number">0xE0</span>,     // Request command <span class="hljs-keyword">for</span> Answer <span class="hljs-keyword">To</span> <span class="hljs-keyword">Reset</span>.<br>    // The commands used <span class="hljs-keyword">for</span> MIFARE Classic (<span class="hljs-keyword">from</span> http://www.mouser.com/ds/<span class="hljs-number">2</span>/<span class="hljs-number">302</span>/MF1S503x<span class="hljs-number">-89574.</span>pdf, Section <span class="hljs-number">9</span>)<br>    // Use PCD_MFAuthent <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">access</span> <span class="hljs-keyword">to</span> a sector, <span class="hljs-keyword">then</span> use these commands <span class="hljs-keyword">to</span> <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span>/modify the blocks <span class="hljs-keyword">on</span> the sector.<br>    // The <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span> commands can <span class="hljs-keyword">also</span> be used <span class="hljs-keyword">for</span> MIFARE Ultralight.<br>    PICC_CMD_MF_AUTH_KEY_A	= <span class="hljs-number">0x60</span>,		// <span class="hljs-keyword">Perform</span> authentication <span class="hljs-keyword">with</span> Key A<br>    PICC_CMD_MF_AUTH_KEY_B	= <span class="hljs-number">0x61</span>,		// <span class="hljs-keyword">Perform</span> authentication <span class="hljs-keyword">with</span> Key B<br>    PICC_CMD_MF_READ		= <span class="hljs-number">0x30</span>,		// Reads one <span class="hljs-number">16</span> byte block <span class="hljs-keyword">from</span> the authenticated sector <span class="hljs-keyword">of</span> the PICC. <span class="hljs-keyword">Also</span> used <span class="hljs-keyword">for</span> MIFARE Ultralight.<br>    PICC_CMD_MF_WRITE		= <span class="hljs-number">0xA0</span>,		// Writes one <span class="hljs-number">16</span> byte block <span class="hljs-keyword">to</span> the authenticated sector <span class="hljs-keyword">of</span> the PICC. <span class="hljs-keyword">Called</span> &quot;COMPATIBILITY WRITE&quot; <span class="hljs-keyword">for</span> MIFARE Ultralight.<br>    PICC_CMD_MF_DECREMENT	= <span class="hljs-number">0xC0</span>,		// Decrements the contents <span class="hljs-keyword">of</span> a block <span class="hljs-keyword">and</span> stores the result <span class="hljs-keyword">in</span> the <span class="hljs-type">internal</span> data register.<br>    PICC_CMD_MF_INCREMENT	= <span class="hljs-number">0xC1</span>,		// Increments the contents <span class="hljs-keyword">of</span> a block <span class="hljs-keyword">and</span> stores the result <span class="hljs-keyword">in</span> the <span class="hljs-type">internal</span> data register.<br>    PICC_CMD_MF_RESTORE		= <span class="hljs-number">0xC2</span>,		// Reads the contents <span class="hljs-keyword">of</span> a block <span class="hljs-keyword">into</span> the <span class="hljs-type">internal</span> data register.<br>    PICC_CMD_MF_TRANSFER	= <span class="hljs-number">0xB0</span>,		// Writes the contents <span class="hljs-keyword">of</span> the <span class="hljs-type">internal</span> data register <span class="hljs-keyword">to</span> a block.<br>    // The commands used <span class="hljs-keyword">for</span> MIFARE Ultralight (<span class="hljs-keyword">from</span> http://www.nxp.com/documents/data_sheet/MF0ICU1.pdf, Section <span class="hljs-number">8.6</span>)<br>    // The PICC_CMD_MF_READ <span class="hljs-keyword">and</span> PICC_CMD_MF_WRITE can <span class="hljs-keyword">also</span> be used <span class="hljs-keyword">for</span> MIFARE Ultralight.<br>    PICC_CMD_UL_WRITE		= <span class="hljs-number">0xA2</span>		// Writes one <span class="hljs-number">4</span> byte page <span class="hljs-keyword">to</span> the PICC.<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="iso14443-4协议类型卡"><a class="markdownIt-Anchor" href="#iso14443-4协议类型卡"></a> ISO14443-4协议类型卡</h3><p><code>ISO14443-4</code>是对<code>ISO14443-3</code>的扩展, 以让读卡器和接收器能够自动的进行参数的协调，匹配，减少人为干预的步骤。</p><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214422.png" srcset="/img/loading.gif" lazyload alt="image"></p><p>如上图, 其和<code>ISO14443-3</code>协议的流程主要区别在与完成选卡后<code>ISO14443-4</code>多了一个发送RATS请求的过程,这个过程用于请求设备端的ATS响应。其仅仅适用于支持<code>ISO14443-4</code>协议的设备。然后得到确认后通过ATS响应来确认设备支持的选项，以最优的设置通过PPS下发完成通讯参数的设置。</p><p>如下为<strong>RATS指令编码</strong></p><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214537.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214555.png" srcset="/img/loading.gif" lazyload alt="1.png"></p><p>设备端响应的**ATS编码 **<br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214615.png" srcset="/img/loading.gif" lazyload alt="screenShot.png"><br>ATS的部分域描述</p><blockquote><p><code>TL</code> 描述后面的数据长度 其包含自身长度, 比如如果为5 表示包含TL T0 TA TB TC<br><code>T0</code> 表明是否支持TA TB TC以及设备端的FSCI长度(FSCI编码可以参照ISO14443-4协议)<br><code>TA</code> 表明设备的接收和发送波特率</p></blockquote><p>具体内容可以参照<code>ISO14443-4</code>协议</p><p><strong>PPS指令编码</strong></p><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214643.png" srcset="/img/loading.gif" lazyload alt="screenShot.png"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214702.png" srcset="/img/loading.gif" lazyload alt="screenShot.png"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214735.png" srcset="/img/loading.gif" lazyload alt="screenShot.png"></p><p><strong>PPS响应</strong></p><h2 id="screenshotpng"><a class="markdownIt-Anchor" href="#screenshotpng"></a> <img src="https://etcfly.top/Images/picture/old_image/markdown20220528214756.png" srcset="/img/loading.gif" lazyload alt="screenShot.png"></h2><h1 id="ic存储卡的内存布局"><a class="markdownIt-Anchor" href="#ic存储卡的内存布局"></a> IC存储卡的内存布局</h1><h2 id="加密m1卡内存布局"><a class="markdownIt-Anchor" href="#加密m1卡内存布局"></a> 加密M1卡内存布局</h2><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214818.png" srcset="/img/loading.gif" lazyload alt="image"><br>每一个块大小为16Byte<br>对于其权限控制,如下<br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214844.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528214908.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528215044.png" srcset="/img/loading.gif" lazyload alt="image"><br><img src="https://etcfly.top/Images/picture/old_image/markdown20220528215111.png" srcset="/img/loading.gif" lazyload alt="image"></p><h2 id="ic存储卡类型"><a class="markdownIt-Anchor" href="#ic存储卡类型"></a> IC存储卡类型</h2><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528215158.png" srcset="/img/loading.gif" lazyload alt="image"><br>可以看到 其相当于内存的访问, 及一片EEPROM空间。</p><h2 id="nfc-type2-tag内存布局"><a class="markdownIt-Anchor" href="#nfc-type2-tag内存布局"></a> NFC Type2 Tag内存布局</h2><p><img src="https://etcfly.top/Images/picture/old_image/markdown20220528215221.png" srcset="/img/loading.gif" lazyload alt="screenShot.png"></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/NFC%E5%85%A5%E9%97%A8/" class="category-chain-item">NFC入门</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/NFC/">#NFC</a> <a href="/tags/%E5%8D%8F%E8%AE%AE/">#协议</a> <a href="/tags/%E8%BF%91%E5%9C%BA%E9%80%9A%E8%AE%AF/">#近场通讯</a></div></div><div class="license-box my-3"><div class="license-title"><div>NFC学习之协议基础</div><div>http://example.com/2022/07/17/nfc/study/192155/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年7月17日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/07/17/oss/server/config/203450/" title="工具篇之使用阿里云OSS搭建图床服务"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">工具篇之使用阿里云OSS搭建图床服务</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/07/17/vscode/nopasswd191402/" title="linux学习之vscode免密码登陆"><span class="hidden-mobile">linux学习之vscode免密码登陆</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>