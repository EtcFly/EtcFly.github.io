<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              概述  RT-Thread虚拟文件系统的目的是为了统一各文件系统的接口,并为RTT的应用层程序提供独立不依赖任何具体文件系统的抽象层接口。 rt_thread DevFs的目录结构  dfs_file.c 实现文件操作接口的抽象、如rea"><meta property="og:type" content="article"><meta property="og:title" content="DevFs虚拟文件系统实现原理"><meta property="og:url" content="http://example.com/2023/01/07/devfs/theory011354/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              概述  RT-Thread虚拟文件系统的目的是为了统一各文件系统的接口,并为RTT的应用层程序提供独立不依赖任何具体文件系统的抽象层接口。 rt_thread DevFs的目录结构  dfs_file.c 实现文件操作接口的抽象、如rea"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/rtos.jpg"><meta property="article:published_time" content="2023-01-07T01:13:54.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="命令行"><meta property="article:tag" content="RTOS"><meta property="article:tag" content="文件系统"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/rtos.jpg"><title>DevFs虚拟文件系统实现原理 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="DevFs虚拟文件系统实现原理"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-01-07 01:13" pubdate>2023年1月7日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6.2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 52 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">DevFs虚拟文件系统实现原理</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h1 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h1><blockquote><p><code>RT-Thread</code>虚拟文件系统的目的是为了统一各文件系统的接口,并为RTT的应用层程序提供独立不依赖任何具体文件系统的抽象层接口。</p><p><code>rt_thread DevFs</code>的目录结构</p><ul><li><strong>dfs_file.c</strong> 实现文件操作接口的抽象、如read、write等接口，这个阶段主要通过文件描述符索引</li><li><strong>dfs_fs.c</strong> 实现文件系统相关接口的抽象，如Mount、Unmount等文件系统密切相关的接口。</li><li><strong>dfs_posix</strong> 基于dfs_file和dfs_fs实现标准posix接口</li><li><strong>dfs.c</strong> 实现基础服务 包括fd描述符管理、文件名的索引、拼接等</li><li><strong>Poll.c</strong></li><li><strong>select.c</strong></li><li><strong>Devfs.c</strong> 实现设备相关的文件系统</li><li><strong>Dfs_net.c</strong> 实现网络socket相关套接字描述符的管理</li></ul><p>通过<code>dfs</code>层的抽象, <code>rtt</code>整个文件管理, 包括<strong>设备文件</strong>, <strong>网卡</strong>, <strong>其他文件</strong> 及 <strong>目录</strong> 呈现明显的分层结构. 如下:</p></blockquote><table><thead><tr><th style="text-align:center">应用层</th></tr></thead><tbody><tr><td style="text-align:center">POSIX 接口抽象层</td></tr><tr><td style="text-align:center">DFS 虚拟文件系统</td></tr><tr><td style="text-align:center">Fatfs Ramfs Romfs Uffs 网卡</td></tr><tr><td style="text-align:center">SD卡 Nand Nor Flash</td></tr></tbody></table><p><strong>那么DFS如何实现对文件系统的封装的呢？</strong></p><h3 id="11-结构"><a class="markdownIt-Anchor" href="#11-结构"></a> 1.1 结构</h3><blockquote><p>DFS为了实现其抽象特性, 设计了一些管理结构。</p></blockquote><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gauss">const <span class="hljs-keyword">struct</span> <span class="hljs-type">dfs_filesystem_ops</span> *filesystem_operation_table[DFS_FILESYSTEM_TYPES_MAX];  <span class="hljs-comment">/* 用于管理各文件系统的自身属性, 比如FATFS系统本身的读写，挂载, Lssek等函数特性, 每一类文件系统都会在这个表中注册。*/</span><br><span class="hljs-keyword">struct</span> <span class="hljs-type">dfs_filesystem</span> filesystem_table[DFS_FILESYSTEMS_MAX]; <span class="hljs-comment">/* 挂载具体的文件系统 记录文件系统的挂载点, 硬盘设备名等 */</span><br>static <span class="hljs-keyword">struct</span> <span class="hljs-type">dfs_fdtable</span> _fdtab; <span class="hljs-comment">//用于管理文件操作的句柄</span><br></code></pre></td></tr></table></figure><p>以上就是<code>rtt</code>非常关键的<code>dfs</code>管理变量。如下是其对应的数据结构</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dfs_filesystem_ops</span> <span class="hljs-comment">/* 各文件系统的操作结构 管理结构*/</span><br>&#123;<br>    <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">uint32_t</span> flags;      <span class="hljs-comment">/* flags for file system operations */</span><br><br>    <span class="hljs-comment">/* operations for file */</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dfs_file_ops</span> *fops;<br><br>    <span class="hljs-comment">/* mount and unmount file system */</span><br>    <span class="hljs-built_in">int</span> (*mount)    (<span class="hljs-keyword">struct</span> dfs_filesystem *fs, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rwflag, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data);<br>    <span class="hljs-built_in">int</span> (*unmount)  (<span class="hljs-keyword">struct</span> dfs_filesystem *fs);<br><br>    <span class="hljs-comment">/* make a file system */</span><br>    <span class="hljs-built_in">int</span> (*mkfs)     (<span class="hljs-type">rt_device_t</span> devid);<br>    <span class="hljs-built_in">int</span> (*statfs)   (<span class="hljs-keyword">struct</span> dfs_filesystem *fs, <span class="hljs-keyword">struct</span> statfs *buf);<br><br>    <span class="hljs-built_in">int</span> (*unlink)   (<span class="hljs-keyword">struct</span> dfs_filesystem *fs, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname);<br>    <span class="hljs-built_in">int</span> (*stat)     (<span class="hljs-keyword">struct</span> dfs_filesystem *fs, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-keyword">struct</span> stat *buf);<br>    <span class="hljs-built_in">int</span> (*rename)   (<span class="hljs-keyword">struct</span> dfs_filesystem *fs, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *oldpath, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *newpath);<br>&#125;;<br><br><br><span class="hljs-comment">/* Mounted file system */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dfs_filesystem</span> <span class="hljs-comment">/*文件系统挂载结构 */</span><br>&#123;<br>    <span class="hljs-type">rt_device_t</span> dev_id;     <span class="hljs-comment">/* Attached device */</span><br><br>    <span class="hljs-type">char</span> *path;             <span class="hljs-comment">/* File system mount point */</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dfs_filesystem_ops</span> *ops; <span class="hljs-comment">/* Operations for file system type */</span><br><br>    <span class="hljs-type">void</span> *data;             <span class="hljs-comment">/* Specific file system data */</span><br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dfs_fdtable</span>  <span class="hljs-comment">/* 文件/网卡 句柄管理结构*/</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> maxfd;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dfs_fd</span> **fds;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>rtt</code>就是通过其他的一些方式, 将不同文件系统接口注册到<code>struct dfs_filesystem_ops</code>中, 然后通过<code>dfs_file.c</code>实现统一的接口访问。</p><p><strong>那么<code>RTT</code>是如何进行结构注册的呢？ 注册是在那里进行的?</strong></p><h3 id="12-rtt文件系统结构的注册"><a class="markdownIt-Anchor" href="#12-rtt文件系统结构的注册"></a> 1.2 rtt文件系统结构的注册</h3><blockquote><p><code>rtt</code>通过每一个文件系统都提供 <strong>dfs_文件系统.c</strong> 的文件来对接口注册进行实现。比如对于Fatfs就有一个<code>dfs_elm.c</code>, 对于<code>romfs</code>就有一个<code>dfs_romfs.c</code>来注册。</p></blockquote><p><strong>如Fatfs:</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_mount(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_filesystem</span> <span class="hljs-operator">*</span><span class="hljs-params">fs</span>, <span class="hljs-params">unsigned</span> <span class="hljs-params">long</span> <span class="hljs-params">rwflag</span>, <span class="hljs-params">const</span> <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">data</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_unmount(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_filesystem</span> <span class="hljs-operator">*</span><span class="hljs-params">fs</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_mkfs(<span class="hljs-params">rt_device_t</span> <span class="hljs-params">dev_id</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_statfs(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_filesystem</span> <span class="hljs-operator">*</span><span class="hljs-params">fs</span>, <span class="hljs-params">struct</span> <span class="hljs-params">statfs</span> <span class="hljs-operator">*</span><span class="hljs-params">buf</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_open(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_close(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_ioctl(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>, <span class="hljs-params">int</span> <span class="hljs-params">cmd</span>, <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">args</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_read(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>, <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">buf</span>, <span class="hljs-params">size_t</span> <span class="hljs-params">len</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_write(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>, <span class="hljs-params">const</span> <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">buf</span>, <span class="hljs-params">size_t</span> <span class="hljs-params">len</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_flush(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>)</span>;<br><span class="hljs-built_in">int</span> dfs<span class="hljs-constructor">_elm_lseek(<span class="hljs-params">struct</span> <span class="hljs-params">dfs_fd</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>, <span class="hljs-params">rt_off_t</span> <span class="hljs-params">offset</span>)</span>;<br></code></pre></td></tr></table></figure><p><code>fatfs</code> 在<code>dfs_file.c</code>实现了以上接口, 该接口是对<code>fatfs</code>操作接口的<code>api</code>封装, 是具有<code>fatfs</code>依赖的, 但是与应用层独立。</p><p>通过以上层的工作, 我们就可以将接口统一注册到DFS文件系统中去。</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">static const struct dfs_file_ops dfs_elm_fops =<br>&#123;<br><span class="hljs-built_in">    dfs_elm_open,</span><br><span class="hljs-built_in">    dfs_elm_close,</span><br><span class="hljs-built_in">    dfs_elm_ioctl,</span><br><span class="hljs-built_in">    dfs_elm_read,</span><br><span class="hljs-built_in">    dfs_elm_write,</span><br><span class="hljs-built_in">    dfs_elm_flush,</span><br><span class="hljs-built_in">    dfs_elm_lseek,</span><br><span class="hljs-built_in">    dfs_elm_getdents,</span><br><span class="hljs-built_in">    RT_NULL,</span> <span class="hljs-comment">/* poll interface */</span><br>&#125;<span class="hljs-comment">;</span><br><br>static const struct dfs_filesystem_ops dfs_elm =<br>&#123;<br>    <span class="hljs-string">&quot;elm&quot;</span>,<br><span class="hljs-built_in">    DFS_FS_FLAG_DEFAULT,</span><br>    &amp;dfs_elm_fops,<br><span class="hljs-built_in"></span><br><span class="hljs-built_in">    dfs_elm_mount,</span><br><span class="hljs-built_in">    dfs_elm_unmount,</span><br><span class="hljs-built_in">    dfs_elm_mkfs,</span><br><span class="hljs-built_in">    dfs_elm_statfs,</span><br><span class="hljs-built_in"></span><br><span class="hljs-built_in">    dfs_elm_unlink,</span><br><span class="hljs-built_in">    dfs_elm_stat,</span><br><span class="hljs-built_in">    dfs_elm_rename,</span><br>&#125;<span class="hljs-comment">;</span><br><br><span class="hljs-comment">/* 系统启动后就将其注册到了 filesystem_operation_table 数组中去 */</span><br>int elm_init(void)<br>&#123;<br>    <span class="hljs-comment">/* register fatfs file system */</span><br>    dfs_register(&amp;dfs_elm)<span class="hljs-comment">;</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>&#125;<br>INIT_COMPONENT_EXPORT(elm_init)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h3 id="13-挂载文件系统"><a class="markdownIt-Anchor" href="#13-挂载文件系统"></a> 1.3 挂载文件系统</h3><blockquote><p>通过上面的描述, 我们已经可以将一个文件系统抽象到DFS中, 那么, 我们如何完成对应文件系统的挂载的呢？</p></blockquote><p>在rtt中, 设备挂载存在两种形式.</p><ul><li>通过手动进行挂载 <code>dfs_mount</code> 接口进行挂载</li><li>自动挂载, 及通过挂载表进行挂载</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">int</span> dfs_mount_table(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (mount_table[<span class="hljs-keyword">index</span>].path == <span class="hljs-keyword">NULL</span>) break;<br><br>        <span class="hljs-keyword">if</span> (dfs_mount(mount_table[<span class="hljs-keyword">index</span>].device_name,<br>                      mount_table[<span class="hljs-keyword">index</span>].path,<br>                      mount_table[<span class="hljs-keyword">index</span>].filesystemtype,<br>                      mount_table[<span class="hljs-keyword">index</span>].rwflag,<br>                      mount_table[<span class="hljs-keyword">index</span>].data) != <span class="hljs-number">0</span>)<br>        &#123;<br>            LOG_E(&quot;mount fs[%s] on %s failed.\n&quot;, mount_table[<span class="hljs-keyword">index</span>].filesystemtype,<br>                       mount_table[<span class="hljs-keyword">index</span>].path);<br>            <span class="hljs-keyword">return</span> -RT_ERROR;<br>        &#125;<br><br>        <span class="hljs-keyword">index</span> ++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>INIT_ENV_EXPORT(dfs_mount_table);<br></code></pre></td></tr></table></figure><p>如此一来, 我们已经完成了文件的挂载, 在rtt中, 不同文件系统都是通过统一的<code>posix</code>接口进行访问的, <strong>那么对于标准的posix接口, 底层如何知道我们操作的是那个文件系统呢？</strong><br>答案是 <strong>路径</strong>, rtt使用统一的linux/unix 根目录结构进行文件管理, 不同文件系统的挂载目录是不一样的。</p><p><strong>现在我们已经可以对文件系统进行挂载, 读写了, 那么是不是应该结束了？ 等等, 咋么应用层open一个文件返回的一个int型的 数据? 这个怎么标明要操作的文件呢？</strong></p><h3 id="14-文件读写的内幕"><a class="markdownIt-Anchor" href="#14-文件读写的内幕"></a> 1.4 文件读写的内幕</h3><blockquote><p>通过上面的描述, 应该可以理解如何通过dfs来抽象挂载各类文件系统了， 现在就来讲讲文件句柄的相关概念</p><p>为了简化应用层的操作, 有的人提出将文件相关指针直接暴露给应用层, 那如果写应用层的人水平一般或者很差, 对我们指针的地址胡乱操作一通, 这对于文件系统是灾难性的, 为了提高文件系统的健壮性, 于是大家决定,统一将索引号传回应用层，那你就没法搞破坏了。</p></blockquote><p>文件系统在内部维护了一定数量的句柄, 也就是<code>struct dfs_fd</code>, 当有文件打开的时候, 系统会分配一定一个fd文件句柄给用户, 这个就是内部就是<code>struct dfs_fd</code>结构的索引下标。 打开文件时, dfs根据打开的文件路径会判断时什么文件系统的文件, 然后将这个文件系统相关的操作结构挂在以fd这个下标索引的<code>struct dfs_fd</code>结构上, 那么后面用户对文件的读写就可以通过这个fd下标来完成了。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs xl">int dfs_file_open(struct dfs_fd *fd, const char *<span class="hljs-built_in">path</span>, int flags)<br>&#123;<br>    struct dfs_filesystem *fs;<br>    char *fullpath;<br>    int result;<br><br>    <span class="hljs-comment">/* parameter check */</span><br>    <span class="hljs-keyword">if</span> (fd == NULL)<br>        return -EINVAL;<br><br>    <span class="hljs-comment">/* make sure we have an absolute path */</span><br>    fullpath = dfs_normalize_path(NULL, <span class="hljs-built_in">path</span>);<br>    <span class="hljs-keyword">if</span> (fullpath == NULL)<br>    &#123;<br>        return -ENOMEM;<br>    &#125;<br><br>    LOG_D(<span class="hljs-string">&quot;open file:%s&quot;</span>, fullpath);<br><br>    <span class="hljs-comment">/* find filesystem */</span><br>    fs = dfs_filesystem_lookup(fullpath);  <span class="hljs-comment">/* 查找这路径是什么文件系统  */</span><br>    <span class="hljs-keyword">if</span> (fs == NULL)<br>    &#123;<br>        rt_free(fullpath); <span class="hljs-comment">/* release path */</span><br><br>        return -ENOENT;<br>    &#125;<br><br>    <span class="hljs-comment">/* 将文件系统相关的接口赋值到fd下标对应的结构上  */</span><br>    LOG_D(<span class="hljs-string">&quot;open in filesystem:%s&quot;</span>, <span class="hljs-function"><span class="hljs-title">fs</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">ops</span>-&gt;</span><span class="hljs-keyword">name</span>);<br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>fs    = fs;             <span class="hljs-comment">/* set file system */</span><br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">fops</span>  = fs-&gt;</span><span class="hljs-function"><span class="hljs-title">ops</span>-&gt;</span>fops;  <span class="hljs-comment">/* set file ops */</span><br><br>    <span class="hljs-comment">/* initialize the fd item */</span><br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>type  = FT_REGULAR;<br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>flags = flags;<br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>size  = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>pos   = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-keyword">data</span>  = fs;<br><br>    <span class="hljs-function"><span class="hljs-title">if</span> (!(fs-&gt;</span><span class="hljs-function"><span class="hljs-title">ops</span>-&gt;</span>flags &amp; DFS_FS_FLAG_FULLPATH))<br>    &#123;<br>        <span class="hljs-function"><span class="hljs-title">if</span> (dfs_subdir(fs-&gt;</span><span class="hljs-built_in">path</span>, fullpath) == NULL)<br>            <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-built_in">path</span> = rt_strdup(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">path</span> = rt_strdup(dfs_subdir(fs-&gt;</span><span class="hljs-built_in">path</span>, fullpath));<br>        rt_free(fullpath);<br>        LOG_D(<span class="hljs-string">&quot;Actual file path: %s&quot;</span>, <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-built_in">path</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-built_in">path</span> = fullpath;<br>    &#125;<br><br>    <span class="hljs-comment">/* specific file system open routine */</span><br>    <span class="hljs-function"><span class="hljs-title">if</span> (fd-&gt;</span><span class="hljs-function"><span class="hljs-title">fops</span>-&gt;</span>open == NULL)<br>    &#123;<br>        <span class="hljs-comment">/* clear fd */</span><br>        <span class="hljs-function"><span class="hljs-title">rt_free</span>(fd-&gt;</span><span class="hljs-built_in">path</span>);<br>        <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-built_in">path</span> = NULL;<br><br>        return -ENOSYS;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-title">if</span> ((result = fd-&gt;</span><span class="hljs-function"><span class="hljs-title">fops</span>-&gt;</span>open(fd)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* 利用文件系统接口进行文件的打开  */</span><br>    &#123;<br>        <span class="hljs-comment">/* clear fd */</span><br>        <span class="hljs-function"><span class="hljs-title">rt_free</span>(fd-&gt;</span><span class="hljs-built_in">path</span>);<br>        <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-built_in">path</span> = NULL;<br><br>        LOG_D(<span class="hljs-string">&quot;%s open failed&quot;</span>, fullpath);<br><br>        return result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>flags |= DFS_F_OPEN;<br>    <span class="hljs-keyword">if</span> (flags &amp; O_DIRECTORY)<br>    &#123;<br>        <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>type = FT_DIRECTORY;<br>        <span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>flags |= DFS_F_DIRECTORY;<br>    &#125;<br><br>    LOG_D(<span class="hljs-string">&quot;open successful&quot;</span>);<br>    return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>至此, 我们已经完成了dfs对文件系统抽象的基本原理, 后面我们还将对网卡的抽象进行描述。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/RTOS/" class="category-chain-item">RTOS</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/">#命令行</a> <a href="/tags/RTOS/">#RTOS</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">#文件系统</a></div></div><div class="license-box my-3"><div class="license-title"><div>DevFs虚拟文件系统实现原理</div><div>http://example.com/2023/01/07/devfs/theory011354/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年1月7日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/01/07/gcc/parameter011354/" title="GCC编译参数"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">GCC编译参数</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/01/07/rtos/clockmanage/011354/" title="UCOSII时钟管理"><span class="hidden-mobile">UCOSII时钟管理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>