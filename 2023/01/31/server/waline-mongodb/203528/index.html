<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              前言   由于lerncloud+valine不稳定, 于是切换到Vercel + lernCloud来部署, 但是必须要开代理才能进行访问, 并且很不稳定, 正好自己买了一台云服务器, 于是打算自己搭建MongoDB + Waline服"><meta property="og:type" content="article"><meta property="og:title" content="waline+mongoDb数据库搭建评论系统"><meta property="og:url" content="http://example.com/2023/01/31/server/waline-mongodb/203528/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              前言   由于lerncloud+valine不稳定, 于是切换到Vercel + lernCloud来部署, 但是必须要开代理才能进行访问, 并且很不稳定, 正好自己买了一台云服务器, 于是打算自己搭建MongoDB + Waline服"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/linux.png"><meta property="article:published_time" content="2023-01-31T20:35:28.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="linux"><meta property="article:tag" content="Mongodb"><meta property="article:tag" content="waline"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/linux.png"><title>waline+mongoDb数据库搭建评论系统 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="waline+mongoDb数据库搭建评论系统"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-01-31 20:35" pubdate>2023年1月31日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 12k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 101 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">waline+mongoDb数据库搭建评论系统</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h3 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h3><p>  由于<code>lerncloud+valine</code>不稳定, 于是切换到<code>Vercel + lernCloud</code>来部署, 但是必须要开代理才能进行访问, 并且很不稳定, 正好自己买了一台云服务器, 于是打算自己搭建<code>MongoDB + Waline</code>服务。</p><h3 id="安装mongodb数据库"><a class="markdownIt-Anchor" href="#安装mongodb数据库"></a> 安装MongoDB数据库</h3><p>  <code>MongoDB</code>是一个基于分布式文件存储的数据库。由 <code>C++</code> 语言编写。旨在为 <code>WEB</code> 应用提供可扩展的高性能数据存储解决方案。<br>  <code>MongoDB</code>是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。它支持的数据结构非常松散，是类似<code>json</code>的<code>bson</code>格式，因此可以存储比较复杂的数据类型。<code>Mongo</code>最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p><p>主要有如下特点:</p><ul><li>面向集合存储，易存储对象类型的数据</li><li>模式自由</li><li>支持动态查询</li><li>支持完全索引，包含内部对象</li><li>支持查询</li><li>支持复制和故障恢复</li><li>使用高效的二进制数据存储，包括大型对象（如视频等）</li><li>自动处理碎片，以支持云计算层次的扩展性</li><li>支持 <code>Golang</code>，<code>RUBY</code>，<code>PYTHON</code>，<code>JAVA</code>，<code>C++</code>，<code>PHP</code>，<code>C#</code> 等多种语言</li><li>文件存储格式为<code>BSON</code>（一种<code>JSON</code>的扩展）</li></ul><p>缺点:</p><ul><li>要求高度事务性的系统</li><li>复杂的跨文档（表）级联查询</li></ul><hr><h4 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h4><ul><li>下载二进制安装包</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">wget https:<span class="hljs-comment">//fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-4.2.8.tgz</span><br>tar -zxvf mongodb-linux-x86_64-ubuntu1604<span class="hljs-number">-4.2</span><span class="hljs-number">.8</span>.tgz<br>mv mongodb-src-r4<span class="hljs-number">.2</span><span class="hljs-number">.8</span>  /usr/local/mongodb<br></code></pre></td></tr></table></figure><p>其他版本参考:<a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/community">下载地址</a></p><ul><li>添加环境变量</li></ul><blockquote><p>这里需要添加<code>bin</code>目录路径到<code>.bashrc</code></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">export PATH=/usr/local/mongodb/bin:$PATH<br>source ~/.bashrc<br></code></pre></td></tr></table></figure><ul><li>执行mongod<br>  该工具可以配置相关的参数, 如日志的存储路径, 配置文件路径等等。在<code>mongodb</code>安装根目录下创建<code>log</code>, <code>dates</code>目录, <code>dates</code>用于存储<code>db</code>数据内容, <code>log</code>存放运行日志。<br>运行如下命令:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">╭─root@etcfly-pc /opt/waline-service ‹master›<br>╰─<span class="hljs-meta"># mongod --dbpath /usr/local/mongodb/dates --logpath /usr/local/mongodb/log/mongo.log --fork</span><br></code></pre></td></tr></table></figure><p>否则会出现如下错误:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">connecting to: mongodb:<span class="hljs-comment">//127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br>Error: couldn<span class="hljs-number">&#x27;</span>t connect to server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">27017</span>, connection attempt failed: SocketException: Error connecting to <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">27017</span> :: caused by :: Connection refused :<br>connect@src/mongo/shell/mongo.js:<span class="hljs-number">374</span>:<span class="hljs-number">17</span><br>@(connect):<span class="hljs-number">2</span>:<span class="hljs-number">6</span><br>exception: connect failed<br>exiting with code <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>参考文档:</p><ol><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43531694/article/details/117123230">Error connecting to 127.0.0.1:27017 :: caused by :: Connection refused</a></li></ol><hr><p>如果报如下错误:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">启动Mongo报错: /usr/lib/x86_64-linux-gnu/libcurl.so<span class="hljs-number">.4</span>: version `CURL_OPENSSL_3 not found<br></code></pre></td></tr></table></figure><p>那表示缺少一些必要库, 需要安装如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># sudo apt-get install libgconf-2-4</span><br><span class="hljs-meta"># sudo apt-get install libcurl3</span><br></code></pre></td></tr></table></figure><hr><p><strong>注意</strong>: 如果你的<code>mongodb</code>版本较高的话, 可能在<code>/usr/local/mongodb/bin</code>目录下没有<code>mongo</code>, 此时需要安装<code>mongodb shell</code>。</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/shell">下载地址</a><br>我们可以下载<code>deb</code>包 然后安装：</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">wget https:<span class="hljs-comment">//downloads.mongodb.com/compass/mongodb-mongosh_1.5.4_amd64.deb</span><br>chmod +x mongodb-mongosh_1<span class="hljs-number">.5</span><span class="hljs-number">.4</span>_amd64.deb<br>sudo dpkg -i mongodb-mongosh_1<span class="hljs-number">.5</span><span class="hljs-number">.4</span>_amd64.deb<br></code></pre></td></tr></table></figure><p>此时可以运行<code>mongosh</code>命令进入<code>mongodb</code>数据库管理界面:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">server-etcfly-pc<span class="hljs-meta"># mongosh</span><br>Current Mongosh Log ID: <span class="hljs-number">63</span>c39eae601d1644a9d408c8<br>Connecting to:          mongodb:<span class="hljs-comment">//127.0.0.1:27017/?directConnection=true&amp;serverSelectionTimeoutMS=2000&amp;appName=mongosh+1.5.4</span><br>Using MongoDB:          <span class="hljs-number">6.0</span><span class="hljs-number">.3</span><br>Using Mongosh:          <span class="hljs-number">1.5</span><span class="hljs-number">.4</span><br><br>For mongosh info see: https:<span class="hljs-comment">//docs.mongodb.com/mongodb-shell/</span><br><br>------<br>   The server generated these startup warnings when booting<br>   <span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>T12:<span class="hljs-number">53</span>:<span class="hljs-number">15.998</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine. See http:<span class="hljs-comment">//dochub.mongodb.org/core/prodnotes-filesystem</span><br>   <span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>T12:<span class="hljs-number">53</span>:<span class="hljs-number">18.290</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>: Access control is not enabled <span class="hljs-keyword">for</span> the database. Read and write access to data and configuration is unrestricted<br>   <span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>T12:<span class="hljs-number">53</span>:<span class="hljs-number">18.290</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>: vm.max_map_count is too low<br>------<br><br>------<br>   Enable MongoDB<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> cloud-based monitoring service, which will then receive and display<br>   metrics about your <span class="hljs-title function_">deployment</span> <span class="hljs-params">(disk utilization, CPU, operation statistics, etc)</span>.<br><br>   The monitoring data will be available on a MongoDB website with a unique URL accessible to you<br>   and anyone you share the URL with. MongoDB may use this information to make product<br>   improvements and to suggest MongoDB products and deployment options to you.<br><br>   To enable <span class="hljs-built_in">free</span> monitoring, run the following command: db.<span class="hljs-title function_">enableFreeMonitoring</span><span class="hljs-params">()</span><br>   To permanently disable this reminder, run the following command: db.<span class="hljs-title function_">disableFreeMonitoring</span><span class="hljs-params">()</span><br>------<br><br>test&gt;<br></code></pre></td></tr></table></figure><p>版本如果较低, 可以运行<code>mongo</code>工具, 其一般位于<code>mongodb/bin</code>目录。</p><hr><ul><li>运行<code>mongo</code><br>  这一步是手动创建<code>DB</code>数据库, 设置用户以及访问密码等等。执行显示如下:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c">╭─etcfly@etcfly-pc /usr/local/mongodb/bin<br>╰─$ mongo<br>MongoDB shell version v4<span class="hljs-number">.2</span><span class="hljs-number">.8</span><br>connecting to: mongodb:<span class="hljs-comment">//127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br>Implicit session: session &#123; <span class="hljs-string">&quot;id&quot;</span> : UUID(<span class="hljs-string">&quot;05bf2140-c3d4-4b0a-beca-9cea4951d20e&quot;</span>) &#125;<br>MongoDB server version: <span class="hljs-number">4.2</span><span class="hljs-number">.8</span><br>Welcome to the MongoDB shell.<br>For interactive help, type <span class="hljs-string">&quot;help&quot;</span>.<br>For more comprehensive documentation, see<br>        http:<span class="hljs-comment">//docs.mongodb.org/</span><br>Questions? Try the support group<br>        http:<span class="hljs-comment">//groups.google.com/group/mongodb-user</span><br>Server has startup warnings:<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">24.870</span>+<span class="hljs-number">0800</span> I  STORAGE  [initandlisten]<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">24.870</span>+<span class="hljs-number">0800</span> I  STORAGE  [initandlisten] ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">24.870</span>+<span class="hljs-number">0800</span> I  STORAGE  [initandlisten] **          See http:<span class="hljs-comment">//dochub.mongodb.org/core/prodnotes-filesystem</span><br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten]<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="hljs-keyword">for</span> the database.<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, which is not recommended.<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten]<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] ** WARNING: This server is bound to localhost.<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] **          Remote systems will be unable to connect to this server.<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] **          Start the server with --bind_ip &lt;address&gt; to specify which IP<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] **          addresses it should serve responses from, or with --bind_ip_all to<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] **          bind to all interfaces. If this behavior is desired, start the<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten] **          server with --bind_ip <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> to disable this warning.<br><span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T16:<span class="hljs-number">12</span>:<span class="hljs-number">26.601</span>+<span class="hljs-number">0800</span> I  CONTROL  [initandlisten]<br>---<br>Enable MongoDB<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> cloud-based monitoring service, which will then receive and display<br>metrics about your <span class="hljs-title function_">deployment</span> <span class="hljs-params">(disk utilization, CPU, operation statistics, etc)</span>.<br><br>The monitoring data will be available on a MongoDB website with a unique URL accessible to you<br>and anyone you share the URL with. MongoDB may use this information to make product<br>improvements and to suggest MongoDB products and deployment options to you.<br><br>To enable <span class="hljs-built_in">free</span> monitoring, run the following command: db.<span class="hljs-title function_">enableFreeMonitoring</span><span class="hljs-params">()</span><br>To permanently disable this reminder, run the following command: db.<span class="hljs-title function_">disableFreeMonitoring</span><span class="hljs-params">()</span><br>---<br>&gt;<br><br></code></pre></td></tr></table></figure><blockquote><p><code>Mongo</code>是 <code>MongoDB</code> 自带的交互式 <code>Javascript shell</code>,用来对<code>MongoDB</code>进行操作和管理的交互式环境。</p></blockquote><p>如显示版本:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; db.version()<br><span class="hljs-number">4.2</span><span class="hljs-number">.8</span><br></code></pre></td></tr></table></figure><hr><h5 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h5><ul><li>如果出现</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">libcrypto.so.1.0.0: cannot open shared object file: No such file or directory<br></code></pre></td></tr></table></figure><p>这表示运行没有对应的库, 可以全局搜索一下有没有类似的库, 如果存在, 可以建立一个符号链接到<code>/lib</code>目录, 没有则需要安装, 如果存在但是版本不对m 这个是<code>mongodb</code>版本太低或者太高的问题, 需要切换版本。</p><p>**如果出现如下, 可能是数据库配置有问题。</p><p><img src="/2023/01/31/server/waline-mongodb/203528/MongoDB%E6%8A%A5%E9%94%99.png" srcset="/img/loading.gif" lazyload alt="MongoDB报错.png"></p><p>常见于应用接口调用数据库进行增删改查, 但是数据库配置存在问题, 导致应用重试进而导致线程池操作出错。</p><p><strong>参考资料</strong>:</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/sequelize/sequelize/issues/7884">TimeoutError: ResourceRequest timed out #7884</a></li></ul><h4 id="创建数据库"><a class="markdownIt-Anchor" href="#创建数据库"></a> 创建数据库</h4><h5 id="数据库基本操作"><a class="markdownIt-Anchor" href="#数据库基本操作"></a> 数据库基本操作</h5><ul><li>数据库创建</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; use waline<br>switched to db waline<br></code></pre></td></tr></table></figure><p><code>waline</code>表示数据库名称, <code>use</code>可以切换不同数据库, 没有则默认创建。</p><ul><li>数据库显示</li></ul><blockquote><p>  用于显示当前有几个<code>DB</code>数据库</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; show dbs<br>admin   <span class="hljs-number">0.000</span>GB<br>config  <span class="hljs-number">0.000</span>GB<br>local   <span class="hljs-number">0.000</span>GB<br>&gt;<br></code></pre></td></tr></table></figure><ul><li>数据库删除<br>数据库删除需要首先切到对于数据库, 然后执行<code>db.dropDatabase()</code>删除，如下:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; use waline<br>switched to db waline<br>&gt; db.dropDatabase()<br>&#123; <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span> &#125;<br>&gt;<br></code></pre></td></tr></table></figure><p>还有其他一些手动插入数据库的节点的, 这里就不演示了。</p><hr><h5 id="waline-mongodb配置"><a class="markdownIt-Anchor" href="#waline-mongodb配置"></a> waline mongodb配置</h5><p>  上面已经讲了<code>MongoDB</code>数据库的基本操作, 现在我们来真实创建一个用于<code>waline</code>上的<code>db</code>数据库。<br>  我们使用系统默认的<code>admin</code>数据库。并添加用户和密码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; use admin<br>switched to db admin<br>&gt; db.createUser(&#123;<br>...   user: <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>...   pwd: <span class="hljs-string">&#x27;xxxxxxx&#x27;</span>,<br>...   roles:[&#123;<br>...     role: <span class="hljs-string">&#x27;root&#x27;</span>,<br>...     db: <span class="hljs-string">&#x27;admin&#x27;</span><br>...   &#125;]<br>... &#125;)<br>Successfully added user: &#123;<br>        <span class="hljs-string">&quot;user&quot;</span> : <span class="hljs-string">&quot;vvd&quot;</span>,<br>        <span class="hljs-string">&quot;roles&quot;</span> : [<br>                &#123;<br>                        <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;root&quot;</span>,<br>                        <span class="hljs-string">&quot;db&quot;</span> : <span class="hljs-string">&quot;数据库名&quot;</span><br>                &#125;<br>        ]<br>&#125;<br></code></pre></td></tr></table></figure><p>这里<code>user</code>是我们的用户名, <code>pwd</code>表示密码, <code>db</code>是数据库名称。这样我们的数据库就已经创建好了。可以使用如下来查看数据库下的用户</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; show users<br>&#123;<br>        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;admin.vdd&quot;</span>,<br>        <span class="hljs-string">&quot;userId&quot;</span> : UUID(<span class="hljs-string">&quot;80c7d46a-0a48-4903-a672-ad4407bf9048&quot;</span>),<br>        <span class="hljs-string">&quot;user&quot;</span> : <span class="hljs-string">&quot;vdd&quot;</span>,<br>        <span class="hljs-string">&quot;db&quot;</span> : <span class="hljs-string">&quot;admin&quot;</span>,<br>        <span class="hljs-string">&quot;roles&quot;</span> : [<br>                &#123;<br>                        <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;root&quot;</span>,<br>                        <span class="hljs-string">&quot;db&quot;</span> : <span class="hljs-string">&quot;admin&quot;</span><br>                &#125;<br>        ],<br>        <span class="hljs-string">&quot;mechanisms&quot;</span> : [<br>                <span class="hljs-string">&quot;SCRAM-SHA-1&quot;</span>,<br>                <span class="hljs-string">&quot;SCRAM-SHA-256&quot;</span><br>        ]<br>&#125;<br></code></pre></td></tr></table></figure><p>如果创建是包如下错误:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"> [js] uncaught exception: Error: couldn<span class="hljs-number">&#x27;</span>t add user: No role named root@leanote :<br>_getErrorWithCode@src/mongo/shell/utils.js:<span class="hljs-number">25</span>:<span class="hljs-number">13</span><br></code></pre></td></tr></table></figure><p>这个是由于<code>root</code>角色只有<code>admin</code>数据库才有, 其他数据不存在该角色。</p><blockquote><ul><li><code>Read</code>：允许用户读取指定数据库</li><li><code>readWrite</code>：允许用户读写指定数据库</li><li><code>dbAdmin</code>：允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问<code>system.profile</code></li><li><code>userAdmin</code>：允许用户向<code>system.users</code>集合写入，可以找指定数据库里创建、删除和管理用户</li><li><code>clusterAdmin</code>：只在<code>admin</code>数据库中可用，赋予用户所有分片和复制集相关函数的管理权限。</li><li><code>readAnyDatabase</code>：只在<code>admin</code>数据库中可用，赋予用户所有数据库的读权限</li><li><code>readWriteAnyDatabase</code>：只在<code>admin</code>数据库中可用，赋予用户所有数据库的读写权限</li><li><code>userAdminAnyDatabase</code>：只在<code>admin</code>数据库中可用，赋予用户所有数据库的<code>userAdmin</code>权限</li><li><code>dbAdminAnyDatabase</code>：只在<code>admin</code>数据库中可用，赋予用户所有数据库的<code>dbAdmin</code>权限。</li><li><code>root</code>：只在<code>admin</code>数据库中可用。超级账号，超级权限</li></ul></blockquote><p>插入数据:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt; db.leanote.insert(&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;W3Cschool教程&quot;</span>&#125;)<br>WriteResult(&#123; <span class="hljs-string">&quot;nInserted&quot;</span> : <span class="hljs-number">1</span> &#125;)<br></code></pre></td></tr></table></figure><h5 id="配置数据库自启动"><a class="markdownIt-Anchor" href="#配置数据库自启动"></a> 配置数据库自启动</h5><p>  在<code>/etc/systemd/system</code>目录下创建一个<code>mongodb.service</code>文件, 并将如下内容写入。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span> = Service to start mongod<br><span class="hljs-attr">After</span> = network.target<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">ExecStart</span> = /usr/local/mongodb/bin/mongod<br><span class="hljs-attr">StandardOutput</span> = inherit<br><span class="hljs-attr">StandardError</span> = inherit<br><span class="hljs-attr">Restart</span> = always<br><span class="hljs-attr">User</span> = lighthouse<br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><ul><li>启动</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">sudo systemctl start mongodb.service<br>sudo systemctl enable mongodb.service<br></code></pre></td></tr></table></figure><hr><h4 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h4><ul><li><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/kdxuu8/3xovjozt.html">The Little MongoDB Book 中文版</a></li><li><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/mongodb/">MongoDB 教程</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/">MongoDB官方文档</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/community">官方下载地址</a></li><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/coding/dataset/mongodb/MongoDB/#6-0-1-%E7%89%88%E6%9C%AC">MongoDB 简易教程</a></li></ul><hr><h3 id="waline下载和配置"><a class="markdownIt-Anchor" href="#waline下载和配置"></a> waline下载和配置</h3><ul><li>使用npm安装</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">npm install @waline/vercel<br>node node_modules/@waline/vercel/vanilla.js<br></code></pre></td></tr></table></figure><p>正常情况下会返回如下信息:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">waline$ node node_modules/@waline/vercel/vanilla.js<br>[<span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-31</span>T17:<span class="hljs-number">17</span>:<span class="hljs-number">30.583</span>] [<span class="hljs-number">296133</span>] [INFO] - Server running at http:<span class="hljs-comment">//127.0.0.1:8360</span><br>[<span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-31</span>T17:<span class="hljs-number">17</span>:<span class="hljs-number">30.585</span>] [<span class="hljs-number">296133</span>] [INFO] - ThinkJS version: <span class="hljs-number">3.2</span><span class="hljs-number">.14</span><br>[<span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-31</span>T17:<span class="hljs-number">17</span>:<span class="hljs-number">30.586</span>] [<span class="hljs-number">296133</span>] [INFO] - Environment: production<br>[<span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-31</span>T17:<span class="hljs-number">17</span>:<span class="hljs-number">30.586</span>] [<span class="hljs-number">296133</span>] [INFO] - Workers: <span class="hljs-number">1</span><br>[<span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-31</span>T17:<span class="hljs-number">22</span>:<span class="hljs-number">07.683</span>] [<span class="hljs-number">296140</span>] [INFO] -<br></code></pre></td></tr></table></figure><p>此时可以通过<code>http://127.0.0.1:8360</code>进行本地测试, 结果如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">[<span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T21:<span class="hljs-number">26</span>:<span class="hljs-number">02.815</span>] [<span class="hljs-number">2005</span>] [INFO] - Server running at http:<span class="hljs-comment">//127.0.0.1:8360</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T21:<span class="hljs-number">26</span>:<span class="hljs-number">02.818</span>] [<span class="hljs-number">2005</span>] [INFO] - ThinkJS version: <span class="hljs-number">3.2</span><span class="hljs-number">.14</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T21:<span class="hljs-number">26</span>:<span class="hljs-number">02.818</span>] [<span class="hljs-number">2005</span>] [INFO] - Environment: production<br>[<span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>T21:<span class="hljs-number">26</span>:<span class="hljs-number">02.818</span>] [<span class="hljs-number">2005</span>] [INFO] - Workers: <span class="hljs-number">1</span><br>Error: Not initialized<br>    at <span class="hljs-title function_">request</span> <span class="hljs-params">(/home/etcfly/Blog/Tencent-blog/node_modules/@waline/vercel/node_modules/leancloud-storage/dist/node/request.js:<span class="hljs-number">156</span>:<span class="hljs-number">11</span>)</span><br>    at AV.Query._<span class="hljs-title function_">createRequest</span> <span class="hljs-params">(/home/etcfly/Blog/Tencent-blog/node_modules/@waline/vercel/node_modules/leancloud-storage/dist/node/query.js:<span class="hljs-number">388</span>:<span class="hljs-number">14</span>)</span><br>    at AV.Query.<span class="hljs-title function_">count</span> <span class="hljs-params">(/home/etcfly/Blog/Tencent-blog/node_modules/@waline/vercel/node_modules/leancloud-storage/dist/node/query.js:<span class="hljs-number">562</span>:<span class="hljs-number">26</span>)</span><br>    at module.exports.<span class="hljs-title function_">count</span> <span class="hljs-params">(/home/etcfly/Blog/Tencent-blog/node_modules/@waline/vercel/src/service/storage/leancloud.js:<span class="hljs-number">250</span>:<span class="hljs-number">23</span>)</span><br>    at module.exports.<span class="hljs-title function_">getAction</span> <span class="hljs-params">(/home/etcfly/Blog/Tencent-blog/node_modules/@waline/vercel/src/controller/comment.js:<span class="hljs-number">270</span>:<span class="hljs-number">53</span>)</span><br>    at /home/etcfly/Blog/Tencent-blog/node_modules/think-controller/index.js:55:32<br>    at <span class="hljs-title function_">processTicksAndRejections</span> <span class="hljs-params">(node:internal/process/task_queues:<span class="hljs-number">96</span>:<span class="hljs-number">5</span>)</span><br>[2023-01-14T21:26:59.112] [2040] [DEBUG] - Post Comment Start!<br>Error: Not initialized<br></code></pre></td></tr></table></figure><p>上面打印了<code>Error: Not initialized</code>的错误, 这是因为没有数据库与其进行关联, 此时在界面上评论也会报错<code>Not initialized</code>。如下图<br><img src="/2023/01/31/server/waline-mongodb/203528/waline%E6%8A%A5%E9%94%99.png" srcset="/img/loading.gif" lazyload alt="waline报错.png"></p><p>关于怎么将数据库与<code>waline</code>进行关联, 作者也不是很清楚，好在有一些网友已经在在这方面做好了一键部署。</p><hr><ul><li>waline一键部署<br>使用一键部署就比较简单, 首先下载相关的代码仓库。<a target="_blank" rel="noopener" href="https://github.com/loclink/waline-service.git">地址</a></li></ul><p>在<code>/opt</code>目录下克隆新项目</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> https://github.com/loclink/waline-service.git<br></code></pre></td></tr></table></figure><p><strong>安装相关依赖</strong>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> waline-service<br>npm install<br></code></pre></td></tr></table></figure><p>默认的配置文件在根目录下<code>.env</code>文件, 没有的话可以自己创建。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm run init:<span class="hljs-built_in">env</span><br></code></pre></td></tr></table></figure><p>这时候会生成<code>.env</code>默认配置。可以将一些全局的变量配置到里面, 避免在环境变量的全局污染。这里主要有:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">MONGO_DB=数据库名<br>MONGO_USER=用户名<br>MONGO_PASSWORD=密码<br>ADMIN_URL=https://etcfly.top<br>BLOGGER_EMAIL=etcflywy@126.com<br>SENDER_EMAIL=etcflywy@126.com<br>SENDER_NAME=EtcFly<br>SITE_NAME=仗剑走天涯<br>SITE_URL=https://etcfly.top<br>SMTP_PASS=<br>SMTP_SERVICE=126<br>SMTP_USER=etcflywy@126.com<br>AUTHOR_EMAIL=etcflywy@126.com<br>TEMPLATE_NAME=rainbow<br></code></pre></td></tr></table></figure><p><strong>注意</strong>:</p><ul><li>这里<code>AUTHOR_EMAIL</code>必须填写, 如果会发送邮件报错。</li></ul><p><img src="/2023/01/31/server/waline-mongodb/203528/waline%E9%82%AE%E4%BB%B6%E6%8A%A5%E9%94%99.png" srcset="/img/loading.gif" lazyload alt="waline邮件报错.png"></p><h4 id="waline测试和部署"><a class="markdownIt-Anchor" href="#waline测试和部署"></a> waline测试和部署</h4><p>  进入<code>/opt/waline-service</code>目录, 执行<code>npm run dev</code>, 可以进行测试。展示如下:<br><img src="/2023/01/31/server/waline-mongodb/203528/waline%E8%AF%84%E8%AE%BA.png" srcset="/img/loading.gif" lazyload alt="waline评论.png"></p><p>如果你配置了<code>nginx</code>代理, 并配置了<code>ssl</code>, 那么你同样可以通过:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">https://域名或IP:端口<br></code></pre></td></tr></table></figure><p>这样的格式进行访问。</p><p>具体这些变量是怎么来的, 可以参考:</p><ol><li><a target="_blank" rel="noopener" href="https://waline.js.org/guide/deploy/vps.html">waline 独立部署</a></li><li><a target="_blank" rel="noopener" href="https://waline.js.org/guide/database.html">waline 多数据库服务支持</a></li></ol><h5 id="设置系统自启动"><a class="markdownIt-Anchor" href="#设置系统自启动"></a> 设置系统自启动</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install -g pm2<br>pm2 start src/main.js<br>pm2 save<br>pm2 startup<br>systemctl <span class="hljs-built_in">enable</span> pm2-root.service<br></code></pre></td></tr></table></figure><p>参考资料:</p><ul><li><a target="_blank" rel="noopener" href="https://blog.51cto.com/mouday/5056524">pm2启动npm run dev和开机自启</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/mouday/article/details/104551215/">Node.js：pm2管理进程启动npm run dev和开机自启</a></li></ul><hr><h3 id="nginx代理配置"><a class="markdownIt-Anchor" href="#nginx代理配置"></a> Nginx代理配置</h3><p>  在<code>nginx</code>配置文件下新建一个<code>waline.conf</code>, 然后修改<code>nginx.conf</code>, 在<code>http</code>配置块中加入<code>include waline.conf</code>。默认使用<code>8360</code>端口进行部署，在<code>waline.conf</code>加入如下配置:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">server &#123;<br>    listen       8500 ssl;<br>    listen  [::]:8500 ssl;<br>    <span class="hljs-comment"># server_name localhost;</span><br><br>    ssl_certificate     /ssl/server.crt;<br>    ssl_certificate_key /ssl/server.key;<br><br>    location / &#123;<br>        proxy_set_header    X-FORWARDED-FOR <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header    X-FORWARDED-PROTO <span class="hljs-variable">$scheme</span>;<br>        proxy_set_header    Host   <span class="hljs-variable">$http_host</span>;<br>        proxy_pass          http://127.0.0.1:8360;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果没有使用<code>https</code>, <code>ssl</code>相关配置可以去掉。<br><code>ps</code>:这里我发现如果对外端口和代理端口是一个端口会出一些莫名其妙的错误。其次如果是<code>ECS</code>, 记得去<code>web</code>页面修改开放端口策略。</p><h3 id="fluid主题配置"><a class="markdownIt-Anchor" href="#fluid主题配置"></a> fluid主题配置</h3><p>  修改主题下的<code>_config.yaml</code>, 配置<code>serverURL</code>修改如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">waline:<br>  serverURL: <span class="hljs-string">&#x27;https://域名:port&#x27;</span><br></code></pre></td></tr></table></figure><p>这时候就可以正常部署了。</p><p>测试如下:<br><img src="/2023/01/31/server/waline-mongodb/203528/waline%E8%AF%84%E8%AE%BA.png" srcset="/img/loading.gif" lazyload alt="waline评论.png"></p><p><img src="/2023/01/31/server/waline-mongodb/203528/waline%E6%B5%8B%E8%AF%95.png" srcset="/img/loading.gif" lazyload alt="waline测试.png"></p><h3 id="其他问题"><a class="markdownIt-Anchor" href="#其他问题"></a> 其他问题</h3><ul><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/kucoll/article/details/97908666">CentOS Connecting to failed: No route to host</a><br>该问题是防火墙打开了, 导致有些主机端口无法打开访问。</li></ul><hr><h3 id="参考资料-2"><a class="markdownIt-Anchor" href="#参考资料-2"></a> 参考资料</h3><ul><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-my-waline/my-waline/#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-358">Fluid -25- 独立部署基于 MongoDB 的 Waline</a></li><li><a target="_blank" rel="noopener" href="https://www.tj520.top/views/articles/back-end/waline-service.html#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93">Waline 服务端一键独立部署解决方案</a></li><li><a target="_blank" rel="noopener" href="https://waline.js.org/guide/database.html#postgresql">waline官方文档</a></li><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/tools/nginx/nginx-usage/">反向代理服务器Nginx</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" class="category-chain-item">博客搭建</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/linux/">#linux</a> <a href="/tags/Mongodb/">#Mongodb</a> <a href="/tags/waline/">#waline</a></div></div><div class="license-box my-3"><div class="license-title"><div>waline+mongoDb数据库搭建评论系统</div><div>http://example.com/2023/01/31/server/waline-mongodb/203528/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年1月31日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/01/31/linux/cloud/frp/225000/" title="基于公有云+frp搭建内网穿透服务"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">基于公有云+frp搭建内网穿透服务</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/01/31/server/umami-mysql/203139/" title="搭建umami+mysql流量统计系统"><span class="hidden-mobile">搭建umami+mysql流量统计系统</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>