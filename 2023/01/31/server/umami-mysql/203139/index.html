<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介   当我们建立一个网站时，对访问流量的统计往往具有较重要的意义，一般对于hexo生成的静态博客, 很多都使用leancloud来做数据统计, 但是国际版leancloud在国内访问经常出现问题，因此，随着评论系统被迁出后，流量统计也"><meta property="og:type" content="article"><meta property="og:title" content="搭建umami+mysql流量统计系统"><meta property="og:url" content="http://example.com/2023/01/31/server/umami-mysql/203139/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介   当我们建立一个网站时，对访问流量的统计往往具有较重要的意义，一般对于hexo生成的静态博客, 很多都使用leancloud来做数据统计, 但是国际版leancloud在国内访问经常出现问题，因此，随着评论系统被迁出后，流量统计也"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/linux.png"><meta property="article:published_time" content="2023-01-31T20:31:39.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="linux"><meta property="article:tag" content="mysql"><meta property="article:tag" content="Umami"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/linux.png"><title>搭建umami+mysql流量统计系统 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="搭建umami+mysql流量统计系统"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-01-31 20:31" pubdate>2023年1月31日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 19k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 163 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">搭建umami+mysql流量统计系统</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3><p>  当我们建立一个网站时，对访问流量的统计往往具有较重要的意义，一般对于<code>hexo</code>生成的静态博客, 很多都使用<code>leancloud</code>来做数据统计, 但是国际版<code>leancloud</code>在国内访问经常出现问题，因此，随着评论系统被迁出后，流量统计也打算自己部署。<br>  自己部署流量统计, 流量统计工具也有很多: 如<code>umami</code>、<code>Shynet</code>、<code>Plausible</code>、<code>Fathom</code>、<code>Ackee</code>等等, 这里我们选择<code>Umami</code>工具来进行说明。<br>独立部署流量统计系统有很多的优点:</p><ul><li>统计数据安全</li><li>不容易被一些广告拦截器拦截</li><li>可以仅仅统计你感兴趣的指标</li><li>开源</li><li>轻量级</li><li>隐私安全, 对敏感信息不手机</li></ul><hr><h3 id="mysql数据库安装"><a class="markdownIt-Anchor" href="#mysql数据库安装"></a> mysql数据库安装</h3><p>  由于<code>umami</code>的统计数据这里使用<code>mysql</code>作为数据库来记录, 因此在安装部署<code>umami</code>之前需要准备<code>mysql</code>环境。</p><h4 id="mysql安装"><a class="markdownIt-Anchor" href="#mysql安装"></a> mysql安装</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt update<br>sudo apt install mysql-server<br><br>service mysql start <span class="hljs-comment"># 启动服务</span><br>sudo netstat -tap | grep mysql <span class="hljs-comment">#检查服务是否启动(默认端口号时3306)</span><br></code></pre></td></tr></table></figure><p>显示如下表示服务正常启动:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">╭─ubuntu@server-etcfly-pc ~<br>╰─$ sudo netstat -tap | grep mysql                                                                                130 ↵<br>tcp        0      0 localhost:33060         0.0.0.0:*               LISTEN      1155/mysqld<br>tcp        0      0 localhost:mysql         0.0.0.0:*               LISTEN      1155/mysqld<br></code></pre></td></tr></table></figure><h4 id="数据库基本语法"><a class="markdownIt-Anchor" href="#数据库基本语法"></a> 数据库基本语法</h4><p>  创建一个新的数据库, 以<code>root</code>用户进入<code>mysql</code>, 如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">╭─ubuntu@server-etcfly-pc /opt/umami<br>╰─$ sudo mysql<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 346<br>Server version: 8.0.31-0ubuntu0.20.04.2 (Ubuntu)<br><br>Copyright (c) 2000, 2022, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt;<br></code></pre></td></tr></table></figure><ul><li><strong>显示所有数据库</strong></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>| umami              |<br>+--------------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><ul><li><strong>创建数据库</strong></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; create database bag;<br>Query OK, 1 row affected (0.03 sec)<br><br>mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| bag                |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>| umami              |<br>+--------------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><ul><li><strong>删除数据库</strong></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; drop database bag;<br>Query OK, 0 rows affected (0.14 sec)<br><br>mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>| umami              |<br>+--------------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><ul><li><strong>切换数据库</strong></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; use umami<br>Reading table information <span class="hljs-keyword">for</span> completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br>mysql&gt;<br></code></pre></td></tr></table></figure><ul><li><p><strong>用户创建</strong></p><ul><li><p>内网访问用户</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; create user <span class="hljs-string">&#x27;admin&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure></li><li><p>外网访问用户创建</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; create user <span class="hljs-string">&#x27;admin&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure><p>其中<code>admin</code>就是用户名, <code>123456</code>就是密码</p></li></ul></li><li><p><strong>用户删除</strong></p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">DROP USER &lt;用户1&gt; [ , &lt;用户2&gt; ]…<br></code></pre></td></tr></table></figure><p>示例:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; drop user <span class="hljs-string">&#x27;test_user&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>Query OK, 0 rows affected (0.08 sec)<br></code></pre></td></tr></table></figure><p><code>test_user</code>是用户名,<code>localhost</code>表示本地</p><ul><li><p><strong>用户授权</strong></p><ul><li><p>内网授权:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 格式</span><br>mysql&gt; grant [权限1，权限2...] on 某库.某表 to 新用户名@<span class="hljs-string">&#x27;主机名/IP地址&#x27;</span> identified by <span class="hljs-string">&#x27;密码&#x27;</span>;<br></code></pre></td></tr></table></figure></li><li><p>外网授权</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 例子:增加一个用户为admin，密码为123456，让所有外网IP都能访问。</span><br><span class="hljs-comment"># 使admin用户获得所有数据库中所有表的(*.*)select、insert、update、delete权限</span><br>mysql&gt; grant select,insert,update,delete on *.* to <span class="hljs-string">&#x27;admin&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><span class="hljs-comment"># 使admin用户获得所有权限。</span><br>mysql&gt; grant all privileges on *.* to <span class="hljs-string">&#x27;admin&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br><span class="hljs-comment"># 如果只想让该用户访问某一个库，只需要将上面的*.*改成 数据库名.*。例如，只让admin用户访问csdn这个数据库下的所有表，当然也可以指定某个表，自己试试吧。</span><br>mysql&gt; grant all privileges on csdn.* to <span class="hljs-string">&#x27;admin&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure><p>当<code>mysql</code>版面较低的时候, 使用上面的命令会出现:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt;  grant select,insert,update,delete on *.* to <span class="hljs-string">&#x27;test_user_ext&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>ERROR 1064 (42000): You have an error <span class="hljs-keyword">in</span> your SQL syntax; check the manual that corresponds to your MySQL server version <span class="hljs-keyword">for</span> the right syntax to use near <span class="hljs-string">&#x27;identified by &#x27;</span>123456<span class="hljs-string">&#x27;&#x27;</span> at line 1<br></code></pre></td></tr></table></figure><p>显示<code>'identified by '123456''</code>是无效的, 因此我们使用<code>root</code>权限登录到<code>mysql</code>, 执行如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">grant [权限1，权限2...] on 某库.某表 to 新用户名@<span class="hljs-string">&#x27;主机名/IP地址</span><br></code></pre></td></tr></table></figure><p>如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; grant all on <span class="hljs-built_in">test</span>.* to <span class="hljs-string">&#x27;test_user&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>Query OK, 0 rows affected (0.02 sec)<br></code></pre></td></tr></table></figure><p>开放<code>test</code>数据库所有的权限给<code>test_user</code>用户。</p><p><strong>参考资料</strong></p></li><li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43802625/article/details/127686015">You are not allowed to create a user with GRANT 错误出现原因及解决方法</a></p></li></ul></li><li><p><strong>刷新权限</strong></p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; flush privileges;<br></code></pre></td></tr></table></figure><hr><h4 id="mysql数据库创建"><a class="markdownIt-Anchor" href="#mysql数据库创建"></a> mysql数据库创建</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; create database umami;<br></code></pre></td></tr></table></figure><p>创建成功显示:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">Query OK, 1 row affected (0.01 sec)<br></code></pre></td></tr></table></figure><h4 id="创建数据库用户"><a class="markdownIt-Anchor" href="#创建数据库用户"></a> 创建数据库用户</h4><ol><li>创建数据库</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt;create database <span class="hljs-built_in">test</span>;<br>Query OK, 0 rows affected (0.30 sec)<br></code></pre></td></tr></table></figure><ol start="2"><li>创建访问用户</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; create user <span class="hljs-string">&#x27;test_user&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.30 sec)<br></code></pre></td></tr></table></figure><p><code>test_user</code>是用户名, 密码是<code>123456</code></p><ol start="3"><li>设置访问权限</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; grant all on <span class="hljs-built_in">test</span>.* to <span class="hljs-string">&#x27;test_user&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>Query OK, 0 rows affected (0.02 sec)<br></code></pre></td></tr></table></figure><p><code>test</code>是数据库名, <code>test_user</code>是用户名, 表示该用户获取该数据库所有权限。</p><ol start="4"><li>刷新用户权限</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; flush privileges;<br></code></pre></td></tr></table></figure><ol start="5"><li>测试用户登录</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -u 用户名 -p -D 数据库名<br></code></pre></td></tr></table></figure><p>使用密码登录即可。如果可以登录进去说明已经设置好了<code>mysql</code>以及对应的用户。</p><p><strong>参考资料</strong></p><ul><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yhnet/articles/16540358.html">Ubuntu安装mysql<br></a></li><li><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/2415.html">MySQL教程</a></li><li><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/mysql/mysql-2i4k2owh.html">ubuntu安装mysql数据库教程</a></li><li><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/7488.html">MySQL删除用户</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/besmarterbestronger/article/details/101020440">Mysql系列之创建用户、删除用户、修改密码</a></li></ul><h4 id="mysql相关报错"><a class="markdownIt-Anchor" href="#mysql相关报错"></a> mysql相关报错</h4><ol><li><code>Access denied for user ‘root‘@‘localhost‘(using password:YES)</code>, 一般出现这类错误都是因为用户不存在, 或者密码错误导致的, 可以重新设置密码或者重新创建用户。</li><li><code>You are not allowed to create a user with GRANT</code>, 出现这个一般是权限的问题，需要检查用户的权限，需要新增权限。可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43802625/article/details/127686015">You are not allowed to create a user with GRANT”错误出现原因及解决方法</a></li></ol><hr><h3 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h3><ul><li>执行<code>mysql</code>时报<code>Access denied for user ‘root‘@‘localhost‘ (using password: NO)</code><br>这是登陆<code>mysql</code>密码不对导致的, 可以切换到<code>root</code>权限, 然后在修改<code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>文件并添加<code>skip-grant-tables</code>, 如下：</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">[mysqld]<br>skip-grant-tables<br>datadir=/var/lib/mysql<br>...<br></code></pre></td></tr></table></figure><p>保存并退出</p><ul><li><code>ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock' (2)</code><br>一般这个错误需要重启<code>mysql</code>, 执行如下：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl stop mysql.service<br>systemctl start mysql.service<br></code></pre></td></tr></table></figure><ul><li><code>ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement</code><br>这个错误一般是由于加了<code>--skip-grant-tables</code>参数, 但是没有刷新权限, 执行如下:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">flush privileges;<br></code></pre></td></tr></table></figure><p><strong>参考资料</strong></p><ul><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36822217/article/details/103156327">Can’t connect to local MySQL server through socket ‘/var/run/mysqld/mysqld.sock’</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenlengshao/article/details/124081872">Linux中连接MySQL出现“Access denied for user ‘root‘@‘localhost‘ (using password: NO)”</a></li></ul><hr><h3 id="umami安装"><a class="markdownIt-Anchor" href="#umami安装"></a> umami安装</h3><ul><li>官网网站: <a target="_blank" rel="noopener" href="https://umami.is/">https://umami.is/</a></li><li>官网文档: <a target="_blank" rel="noopener" href="https://umami.is/docs/">https://umami.is/docs/</a></li><li><code>github</code>源码: <a target="_blank" rel="noopener" href="https://github.com/umami-software/umami">https://github.com/umami-software/umami</a></li></ul><p>安装<code>umami</code>需要<code>nodejs</code>和<code>npm</code>环境, 具体可以参考相关文档和资料。<br>下载<code>Umami</code>源码:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> https://github.com/mikecao/umami.git<br><span class="hljs-built_in">cd</span> umami<br>npm install<br></code></pre></td></tr></table></figure><p>通过刚刚建立的<code>mysql</code>数据库, 执行如下命令。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -u username -p databasename &lt; sql/schema.mysql.sql<br></code></pre></td></tr></table></figure><p><code>username</code>是我们刚刚验证的合法数据库用户名, <code>databasename</code>是创建的数据库名。如刚刚创建的数据库和用户名如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -u test_user -p <span class="hljs-built_in">test</span> &lt;  sql/schema.mysql.sql<br></code></pre></td></tr></table></figure><p>在<code>Umami</code>目录下新建一个<code>.env</code>配置文件, 写入:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">DATABASE_URL=(connection url)<br>HASH_SALT=(any random string)<br></code></pre></td></tr></table></figure><p><code>connection url</code>需要按照如下格式:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql://username:mypassword@localhost:3306/mydb<br></code></pre></td></tr></table></figure><p><code>username</code>合法用户名, <code>mypassword</code>用户访问密码, <code>mydb</code>数据库名。<br><code>any random string</code>是一个随机的字符串, 可以随便写。最终如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">DATABASE_URL=mysql://test_user:123456@localhost:3306/test<br>HASH_SALT=123456789<br></code></pre></td></tr></table></figure><p>编译:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm run build<br></code></pre></td></tr></table></figure><p>启动过程中可能会有其他报错, 按照提示依次解决。如果按照上面启动<code>ssh</code>推出后<code>umami</code>进程就结束了, 可以配置自启动。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> umami<br>pm2 start npm --name umami -- start<br>pm2 startup<br>pm2 save<br></code></pre></td></tr></table></figure><p>这时候可以通过<code>127.0.0.1:3000</code>来访问测试, 如果进入如下页面, 表示正常</p><p><img src="https://etcfly.top/Images/picture/old_image/markdown/blog/umami%E7%99%BB%E5%BD%95.png" srcset="/img/loading.gif" lazyload alt="umami登录.png"></p><p>此时表示<code>Umami</code>安装配置完成, 默认用户名是<code>admin</code>, 密码<code>umami</code></p><hr><h4 id="nginx配置"><a class="markdownIt-Anchor" href="#nginx配置"></a> nginx配置</h4><p>在<code>nginx</code>根目录<code>conf</code>目录下新建一个<code>umami.conf</code>配置文件, 内容如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"> server &#123;<br>        listen       8600 ssl;<br>        listen   [::]:8600 ssl;<br><br>        ssl_certificate      /usr/local/nginx/cert/love-chai.top_bundle.crt;<br>        ssl_certificate_key  /usr/local/nginx/cert/love-chai.top.key;<br><br>        location / &#123;<br>            proxy_pass http://localhost:3000;<br>            proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>            proxy_set_header Host <span class="hljs-variable">$host</span>;<br>            proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>  此时可以通过<code>https://域名:8600</code>来访问。现在<code>mysql</code>和<code>umami</code>已经都完成了单独部署。<code>umami</code>可以向数据库成功写入统计数据, 但是要想站点可以展示出来, 测试需要设置前后端代码来使二者建立连接。</p><h4 id="插入统计代码"><a class="markdownIt-Anchor" href="#插入统计代码"></a> 插入统计代码</h4><ol><li>登录<code>umami</code>后台, 在设置中点击添加站点，配置名称和域名。</li></ol><blockquote><p>这是站点监控端就顺利完成了，查看监控数据可以发现访问人数并不会增加，这是因为我们需要在我们监控的站点中插入反馈信息的代码。</p></blockquote><ol start="2"><li><p>获取跟踪代码<br><img src="https://etcfly.top/Images/picture/old_image/markdown/blog/umami%E8%8E%B7%E5%8F%96%E8%B7%9F%E8%B8%AA%E4%BB%A3%E7%A0%81.png" srcset="/img/loading.gif" lazyload alt="umami获取跟踪代码.png"></p></li><li><p>复制跟踪代码，将这部分代码放到我们需要监控网站的 html 代码中即可监控该站点, 在主题根目录下新建一个<code>umami_header.ejs</code>的文件, 然后将共享连接复制过去就可以, 注意修改代理端口。</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">&lt;script async defer data-website-id=<span class="hljs-string">&quot;xxxxxxxxxxxxxx&quot;</span><br>    src=<span class="hljs-string">&quot;domain:port/umami.js&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><ol start="4"><li>此时刷新可以看到统计数据</li></ol><hr><h3 id="umami相关api"><a class="markdownIt-Anchor" href="#umami相关api"></a> Umami相关API</h3><p>  到这里已经完成了<code>umami</code>的单独部署, 那么如何将数据展示到页面, 并实时展示访问状态呢？这就需要相应的前后端代码配置。</p><p><strong>准备条件</strong>:</p><ul><li>已经完成了<code>Umami</code>部署</li><li>已经完成了博客的基本部署(我这里基于<code>fluid</code>主题)</li><li><code>python</code> 环境</li><li><code>nodejs</code> 环境</li><li><code>mysql</code> 数据库环境</li></ul><ol><li>认证</li></ol><ul><li>在执行大部分 <code>API</code> 之前需要向 <code>Umami</code> 做身份认证，拿到相应身份的 <code>token</code></li><li>使用该 <code>token</code> 执行 <code>API</code>，因此认证是前提</li></ul><p>新建<code>python</code>文件<code>login.py</code>。复制如下内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br>url = <span class="hljs-string">&quot;http://&lt;your.umami.website&gt;/api/auth/login&quot;</span><br>requestData=&#123;<br>    <span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;admin&quot;</span>,<br>    <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;xxxxxxxx&quot;</span><br>&#125;<br>header = &#123;<br>            <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>        &#125;<br>res = requests.post(url=url, data=json.dumps(requestData), headers=header)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><p>将 <code>&lt;your.umami.website&gt;</code> 替换成你的 <code>Umami url</code>, 结果返回:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">&#123;<br>token: <span class="hljs-string">&#x27;eyJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwiYWsadfkjasldkfj23405ujSDF654GD654asas6fdGSDGIUHOI453zTxZ0RMmJribpKsPAULlxDaiZQIUlrHU7Bo1S8u8hBrNUQ.Q2N4QfMFqHd7W2Pn0CYSNw.ps2KCcN4jnNVngJymTeHmUVhV9PBeMOmAH1Z3Qf11gKEMvQrSXGcWfgHJV188HmLZF_K3AlTIMl7Kf22HG8UI8VjwreMNQ_8BJ6s4zi8xB3ogBUr_DxXFqItRBnmNQH_fpS6AQvtgNA3mRq9ibOQMxCVio07R175BR2QzzxpeyDnhpMmqpW7cuZCD5DiiM4EOhXOaCnYkjRbl6NiXyQ.thwo7wexr3Vk3PSnSEXgyQ&#x27;</span>,<br>user: &#123; user_id: 1, username: <span class="hljs-string">&#x27;admin&#x27;</span>, is_admin: <span class="hljs-literal">true</span> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>  拿到<code>token</code>以后, 这是其他<code>API</code>访问认证的基础，于是可以访问其他接口，具体<code>API</code>接口有那些，可以参考<a target="_blank" rel="noopener" href="https://umami.is/docs/api">官方文档</a></p><ul><li><code>Websites</code></li></ul><blockquote><p>该 <code>API</code> 可以返回 <code>Umami</code> 追踪的网站列表, 创建一个<code>websites.py</code>文件内容如下:</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">import requests<br>import json<br>url = <span class="hljs-string">&quot;http://&lt;your.umami.website&gt;/api/websites&quot;</span><br>data = &#123;&#125;<br>header=&#123;<br>    <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>    <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Bearer eyJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwiYWsadfkjasldkfj23405ujSDF654GD654asas6fdGSDGIUHOI453zTxZ0RMmJribpKsPAULlxDaiZQIUlrHU7Bo1S8u8hBrNUQ.Q2N4QfMFqHd7W2Pn0CYSNw.ps2KCcN4jnNVngJymTeHmUVhV9PBeMOmAH1Z3Qf11gKEMvQrSXGcWfgHJV188HmLZF_K3AlTIMl7Kf22HG8UI8VjwreMNQ_8BJ6s4zi8xB3ogBUr_DxXFqItRBnmNQH_fpS6AQvtgNA3mRq9ibOQMxCVio07R175BR2QzzxpeyDnhpMmqpW7cuZCD5DiiM4EOhXOaCnYkjRbl6NiXyQ.thwo7wexr3Vk3PSnSEXgyQ&quot;</span><br>&#125;<br>res = requests.get(url=url, data=json.dumps(data), headers=header)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><p>将 <code>&lt;your.umami.website&gt;</code> 替换成你的 <code>Umami url</code>, 成功执行返回如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">[<br>  &#123;<br>    website_id: 1,<br>    website_uuid: <span class="hljs-string">&#x27;e674kgfh1-xxxx-xxxx-xxxx-yu9f8uc0&#x27;</span>,<br>    name: <span class="hljs-string">&#x27;仗剑走天涯&#x27;</span>,<br>    created_at: <span class="hljs-string">&#x27;2022-12-25T05:16:31.266Z&#x27;</span>,<br>    user_id: 1,<br>    domain: <span class="hljs-string">&#x27;love-chai.top&#x27;</span>,<br>    share_id: <span class="hljs-string">&#x27;xxxxxx&#x27;</span><br>  &#125;<br>]<br></code></pre></td></tr></table></figure><ul><li><code>website/&#123;uuid&#125;/stats</code></li></ul><blockquote><p>该 <code>API</code> 可以返回站点统计信息，也就是核心需求, 创建一个<code>stats.py</code>文件, 内容如下：</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">import requests<br>import json<br>url = <span class="hljs-string">&quot;http://127.0.0.1:3000/api/website/uuid/stats?start_at=1350679719687&amp;end_at=1990039038644&quot;</span><br>data = &#123;&#125;<br>header=&#123;<br>    <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>    <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Bearer eyJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwiYWsadfkjasldkfj23405ujSDF654GD654asas6fdGSDGIUHOI453zTxZ0RMmJribpKsPAULlxDaiZQIUlrHU7Bo1S8u8hBrNUQ.Q2N4QfMFqHd7W2Pn0CYSNw.ps2KCcN4jnNVngJymTeHmUVhV9PBeMOmAH1Z3Qf11gKEMvQrSXGcWfgHJV188HmLZF_K3AlTIMl7Kf22HG8UI8VjwreMNQ_8BJ6s4zi8xB3ogBUr_DxXFqItRBnmNQH_fpS6AQvtgNA3mRq9ibOQMxCVio07R175BR2QzzxpeyDnhpMmqpW7cuZCD5DiiM4EOhXOaCnYkjRbl6NiXyQ.thwo7wexr3Vk3PSnSEXgyQ&quot;</span><br>&#125;<br>res = requests.get(url=url, data=json.dumps(data), headers=header)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><p>将 <code>&lt;your.umami.website&gt;</code> 替换成你的 <code>Umami url</code>, 运行成功后返回 <code>start_at</code> 到 <code>end_at</code> 时间段内的站点访问数量, 时间以 <code>1970</code>年<code>1</code>月<code>1</code>日起算的毫秒数计量, 运行成功后返回</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">&#123;<span class="hljs-string">&quot;pageviews&quot;</span>:&#123;<span class="hljs-string">&quot;value&quot;</span>:648,<span class="hljs-string">&quot;change&quot;</span>:648&#125;,<span class="hljs-string">&quot;uniques&quot;</span>:&#123;<span class="hljs-string">&quot;value&quot;</span>:143,<span class="hljs-string">&quot;change&quot;</span>:143&#125;,<span class="hljs-string">&quot;bounces&quot;</span>:&#123;<span class="hljs-string">&quot;value&quot;</span>:129,<span class="hljs-string">&quot;change&quot;</span>:129&#125;,<span class="hljs-string">&quot;totaltime&quot;</span>:&#123;<span class="hljs-string">&quot;value&quot;</span>:27774,<span class="hljs-string">&quot;change&quot;</span>:27774&#125;&#125;<br></code></pre></td></tr></table></figure><p>以上是统计主页的访问量，如果想获取其他子页面的访问量，需要加上&quot;&amp;url=相对地址&quot;的方式来获取。如:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:3000/api/website/uuid/stats?start_at=1350679719687&amp;end_at=1990039038644&amp;url=tags&quot;</span><br></code></pre></td></tr></table></figure><p>表示请求tags页面访问量。</p><ul><li>当前活跃用户数量</li></ul><blockquote><p>访问的<code>url</code>修改为<code>http://&lt;your.umami.website&gt;/api/website/&lt;uuid&gt;/active</code>, 新建<code>active.py</code>文件写入如下内容:</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment">#!/bin/python3</span><br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br>url = <span class="hljs-string">&quot;http://127.0.0.1:3000/api/websites/uuid/active&quot;</span><br>data = &#123;&#125;<br>header=&#123;<br>    <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>    <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Bearer YQ1wYkmo3wmpBsssIvw66bH9WvrOv7pGaIDDM55fPzhct9D/hDHcj6mUSFj/4177LYc8EQPYiLUedrjlRAZmiri90/TZeK1xBvRJ1DG1KiwydpMXrCiRxkNQmtQ/igwYSLsBbVsxZwY6IX8bf0QGopuujYh8eQpDT1zL+7e9ur9g8S8RepWYZ4Hg3IAj/IRebWDB9LvGAKAMcFsVFjP2HTBrt2VjxWMantKvP3A7PjEblIpx1bJc1bdFU2pSX2gtJVgfrCYJruObX7tEe2zoTw5jOx2+F/07Ip3DFlOtSbD0XANZBajVlLk3yfye4B7bvUnUjN0QFx5PH7mBUsOzEnbU22Au9ra7ssss&quot;</span><br>res = requests.get(url=url, data=json.dumps(data), headers=header)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><p>成功执行返回:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[&#123;<span class="hljs-string">&quot;x&quot;</span>:1&#125;]<br></code></pre></td></tr></table></figure><p>我们可以单独对上面的<code>python</code>文件进行测试, 观察每一个<code>api</code>是否访问正常。</p><h5 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h5><ul><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/tools/umami/umami-api/umami-api/#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-329">Umami API 使用方法</a></li><li><a target="_blank" rel="noopener" href="https://umami.is/docs/api">官网文档</a></li><li><a target="_blank" rel="noopener" href="https://github.com/umami-software/umami/issues/1751">github umami</a></li></ul><h4 id="后端程序"><a class="markdownIt-Anchor" href="#后端程序"></a> 后端程序</h4><p>新建一个<code>umami_server.py</code>程序，输入如下内容：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs sh">from flask import Flask, request<br>from flask_cors import CORS<br>import mtutils as mt<br><br>import requests<br>import json<br>import mtutils as mt<br>from pathlib import Path<br><br><br>class Statistic:<br>    root_url = <span class="hljs-string">&quot;http://127.0.0.1:3000/api/websites/[ Your uuid]/&quot;</span><br>    header=&#123;<br>        <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>        <span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>: <span class="hljs-string">&#x27;*&#x27;</span>,<br>        <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Bearer [Your Token]&quot;</span><br>    &#125;<br><br>    def __init__(self):<br>        conter_path = Path(__file__).with_name(<span class="hljs-string">&#x27;conter.json&#x27;</span>)<br><br>    @staticmethod<br>    def make_json_str(pv, uv, act):<br>        res_str = <span class="hljs-string">&quot;(function vvdstatistics()&#123;&quot;</span>+\<br>                <span class="hljs-string">&quot;var PVstatic=&#x27;&quot;</span> +\<br>                str(pv) +\<br>                <span class="hljs-string">&quot;&#x27;;var dom=document.querySelector(&#x27;#PVstatic&#x27;);Array.isArray(dom)?dom[0].innerText=PVstatic:dom.innerText=PVstatic;&quot;</span>+\<br>                <span class="hljs-string">&quot;var UVstatic=&#x27;&quot;</span> +\<br>                str(uv) +\<br>                <span class="hljs-string">&quot;&#x27;;var dom=document.querySelector(&#x27;#UVstatic&#x27;);Array.isArray(dom)?dom[0].innerText=UVstatic:dom.innerText=UVstatic;&quot;</span>+\<br>                <span class="hljs-string">&quot;var ACTstatic=&#x27;&quot;</span> +\<br>                str(act) +\<br>                <span class="hljs-string">&quot;&#x27;;var dom=document.querySelector(&#x27;#ACTstatic&#x27;);Array.isArray(dom)?dom[0].innerText=ACTstatic:dom.innerText=ACTstatic;&quot;</span>+\<br>                <span class="hljs-string">&quot;&#125;)()&quot;</span><br><br>        <span class="hljs-built_in">return</span> res_str<br><br>    def active_num(self):<br>        url = self.root_url + <span class="hljs-string">&#x27;active&#x27;</span><br>        res = requests.get(url=url, data=json.dumps(&#123;&#125;), headers=self.header)<br>        res_dict = json.loads(res.text)<br>        act_str = max(1, res_dict[0][<span class="hljs-string">&#x27;x&#x27;</span>])<br>        <span class="hljs-built_in">return</span> act_str<br><br>    def PVUV_num(self):<br>        url = self.root_url + <span class="hljs-string">&#x27;stats?start_at=1350679719687&amp;end_at=1990039038644&#x27;</span><br>        res = requests.get(url=url, data=json.dumps(&#123;&#125;), headers=self.header)<br>        res_dict = json.loads(res.text)<br>        pv = res_dict[<span class="hljs-string">&#x27;pageviews&#x27;</span>][<span class="hljs-string">&#x27;value&#x27;</span>]<span class="hljs-comment"># + self.conter_dict[&#x27;site-pv&#x27;]</span><br>        uv = res_dict[<span class="hljs-string">&#x27;uniques&#x27;</span>][<span class="hljs-string">&#x27;value&#x27;</span>] <span class="hljs-comment">#+ self.conter_dict[&#x27;site-uv&#x27;]</span><br>        <span class="hljs-built_in">return</span> pv, uv<br><br>    def js_str(self):<br>        pv, uv = self.PVUV_num()<br>        act = self.active_num()<br>        <span class="hljs-built_in">return</span> self.make_json_str(pv, uv, act)<br><br>    def post_pv(self, sub_url):<br>        url = self.root_url + <span class="hljs-string">&#x27;stats?start_at=1350679719687&amp;end_at=1990039038644&#x27;</span> + <span class="hljs-string">&#x27;&amp;url=&#x27;</span> + sub_url<br>        res = requests.get(url=url, data=json.dumps(&#123;&#125;), headers=self.header)<br>        res_dict = json.loads(res.text)<br>        pv = res_dict[<span class="hljs-string">&#x27;pageviews&#x27;</span>][<span class="hljs-string">&#x27;value&#x27;</span>] <span class="hljs-comment">#+ self.conter_dict.get(sub_url, 0)</span><br>        uv = res_dict[<span class="hljs-string">&#x27;uniques&#x27;</span>][<span class="hljs-string">&#x27;value&#x27;</span>]<br>        <span class="hljs-built_in">return</span> pv, uv<br><br>port = <span class="hljs-string">&#x27;3500&#x27;</span><br>log_file_path = <span class="hljs-string">&#x27;/usr/local/static/log.log&#x27;</span><br>app = Flask(__name__)<br>app.logger = mt.log_init(log_file_path)<br>CORS(app, supports_credentials=True)<br>static_obj = Statistic()<br><br>@app.route(<span class="hljs-string">&quot;/statistics&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>])<br>def statistics():<br>    res = static_obj.js_str()<br>    <span class="hljs-built_in">return</span> res<br><br><br>@app.route(<span class="hljs-string">&quot;/poststats&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>])<br>def poststats():<br>    url = request.data.decode(<span class="hljs-string">&#x27;utf8&#x27;</span>)[1:-1]<br>    pv, uv = static_obj.post_pv(url)<br>    <span class="hljs-built_in">return</span> &#123;<span class="hljs-string">&#x27;pv&#x27;</span>: pv, <span class="hljs-string">&#x27;uv&#x27;</span>: uv&#125;<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=port)<br>    pass<br></code></pre></td></tr></table></figure><ul><li>使用时需要修改<code>root_url</code>以及<code>header</code>中的<code>&lt;url-to-umami&gt;</code> 和 <code>&lt;your-token&gt;</code></li><li><code>active_num</code> 函数获取当前活跃用户数</li><li><code>PVUV_num</code> 函数获取站点 <code>PV</code> <code>UV</code> 数</li><li><code>post_pv</code> 函数获取 <code>post PV UV</code> 数</li><li><code>js_str</code> 函数整合 <code>active_num</code> 和 <code>PVUV_num</code> 的结果返回 <code>js</code>代码</li><li><code>port</code> 是你服务端程序端口号</li><li>核心代码的行为：<ul><li>利用 <code>Umami API</code> 获取需要的数据</li><li>整合成 <code>js</code> 字符串或直接返回数据</li><li><code>js</code> 串功能为修改<code>ID</code> 为<code>PVstatic</code>, <code>UVstatic</code> 和 <code>ACTstatic</code> 的元素内容</li></ul></li></ul><p>程序运行中可能需要安装一些库, 可<code>pip</code>自行安装。成功后, 可以通过浏览器</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">http://127.0.0.1:3000/poststats 获取页面数据<br>http://127.0.0.1:3000/statistics 获取浏览数据<br></code></pre></td></tr></table></figure><p>如果没有，请检查<code>python</code>文件执行是否报错并解决。成功执行结果如下：</p><ol><li><code>http://127.0.0.1:3000/poststats</code></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">&#123;<span class="hljs-string">&quot;pv&quot;</span>:0,<span class="hljs-string">&quot;uv&quot;</span>:0&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li><code>http://127.0.0.1:3000/statistics</code></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">(<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">vvdstatistics</span></span>()&#123;var PVstatic=<span class="hljs-string">&#x27;648&#x27;</span>;var dom=document.querySelector(<span class="hljs-string">&#x27;#PVstatic&#x27;</span>);Array.isArray(dom)?dom[0].innerText=PVstatic:dom.innerText=PVstatic;var UVstatic=<span class="hljs-string">&#x27;143&#x27;</span>;var dom=document.querySelector(<span class="hljs-string">&#x27;#UVstatic&#x27;</span>);Array.isArray(dom)?dom[0].innerText=UVstatic:dom.innerText=UVstatic;var ACTstatic=<span class="hljs-string">&#x27;1&#x27;</span>;var dom=document.querySelector(<span class="hljs-string">&#x27;#ACTstatic&#x27;</span>);Array.isArray(dom)?dom[0].innerText=ACTstatic:dom.innerText=ACTstatic;&#125;)()<br></code></pre></td></tr></table></figure><p>如果以上都可以正常访问, 表示后端程序搭建完成。添加自启动。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">[Unit]<br>Description = Service to count pv,uv <span class="hljs-keyword">for</span> love-chai.top<br>After = network.target<br><br>[Service]<br>ExecStart = /bin/python3 /opt/umami_api/umami_server.py<br>WorkingDirectory = /opt/umami_api/<br>StandardOutput = inherit<br>StandardError = inherit<br>Restart = always<br>User = root<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>当获取子页面访问量时, 如果路径存在中文, <code>api</code>会一直返回<code>0</code>, 因此需要将路径转换为英文路径</li></ul><hr><h4 id="前端程序"><a class="markdownIt-Anchor" href="#前端程序"></a> 前端程序</h4><h5 id="网站pv-pu"><a class="markdownIt-Anchor" href="#网站pv-pu"></a> 网站PV PU</h5><ul><li>选择在 Fluid 主题配置文件中加入该部分前端代码</li><li>关闭原始 PV、UV 统计</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 展示网站的 PV、UV 统计数</span><br><span class="hljs-comment"># Display website PV and UV statistics</span><br><span class="hljs-attr">statistics:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">false</span><br><br>  <span class="hljs-comment"># 统计数据来源，使用 leancloud 需要设置 `web_analytics: leancloud` 中的参数；使用 busuanzi 不需要额外设置，但是有时不稳定，另外本地运行时 busuanzi 显示统计数据很大属于正常现象，部署后会正常</span><br>  <span class="hljs-comment"># Data source. If use leancloud, you need to set the parameter in `web_analytics: leancloud`</span><br>  <span class="hljs-comment"># Options: busuanzi | leancloud</span><br>  <span class="hljs-attr">source:</span> <span class="hljs-string">&quot;leancloud&quot;</span><br><br>  <span class="hljs-attr">pv_format:</span> <span class="hljs-string">&quot;总访问量 &#123;&#125; 次&quot;</span><br>  <span class="hljs-attr">uv_format:</span> <span class="hljs-string">&quot;总访客数 &#123;&#125; 人&quot;</span><br></code></pre></td></tr></table></figure><ul><li>打开主题下 <code>_config.yml</code> 文件<br>在<code>footer:</code>下添加如下内容:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">&lt;div style=<span class="hljs-string">&quot;font-size: 0.85rem&quot;</span>&gt;<br>  &lt;span&gt; 总访问量 &lt;span style=<span class="hljs-string">&quot;color: #000000;&quot;</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;PVstatic&quot;</span>&gt;0&lt;/span&gt; 次&amp;nbsp&lt;/span&gt;<br>  &lt;span&gt; 总访客数 &lt;span style=<span class="hljs-string">&quot;color: #000000;&quot;</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;UVstatic&quot;</span>&gt;0&lt;/span&gt; 人&amp;nbsp&lt;/span&gt;<br>  &lt;span&gt; 当前在线 &lt;span style=<span class="hljs-string">&quot;color: #000000;&quot;</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;ACTstatic&quot;</span>&gt;0&lt;/span&gt; 人&amp;nbsp&lt;/span&gt;<br>  &lt;script src=<span class="hljs-string">&quot;https://etcfly.top:8700/statistics&quot;</span> defer&gt;&lt;/script&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><h5 id="post-文章pv-uv"><a class="markdownIt-Anchor" href="#post-文章pv-uv"></a> post 文章PV UV</h5><ul><li>修改 <code>fluid</code> 主题配置文件<code>_config.yml</code>，加入新的文章浏览计数来源，我起名叫 <code>vvdpostpvuv</code></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 浏览量计数</span><br><span class="hljs-comment"># Number of visits</span><br><span class="hljs-attr">views:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># 统计数据来源</span><br>  <span class="hljs-comment"># Data Source</span><br>  <span class="hljs-comment"># Options: busuanzi | leancloud | 自建基于 Umami 统计的 文章PV vvdpostpvuv</span><br>  <span class="hljs-attr">source:</span> <span class="hljs-string">&quot;vvdpostpvuv&quot;</span><br>  <span class="hljs-attr">format:</span> <span class="hljs-string">&quot;&#123;&#125; 次&quot;</span><br></code></pre></td></tr></table></figure><ul><li>修改主题前端代码<code>themes\fluid\layout\_partials\post\meta-top.ejs</code>, 加入如下:</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;% &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (theme.<span class="hljs-property">post</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">views</span>.<span class="hljs-property">source</span>===<span class="hljs-string">&#x27;busuanzi&#x27;</span> ) &#123; %&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;busuanzi_container_page_pv&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-eye&quot;</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">&lt;%- views_texts[0] %&gt;<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;busuanzi_value_page_pv&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>&lt;%- views_texts[1] %&gt;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br>&lt;% <span class="hljs-title function_">import_js</span>(theme.<span class="hljs-property">static_prefix</span>.<span class="hljs-property">busuanzi</span>, <span class="hljs-string">&#x27;busuanzi.pure.mini.js&#x27;</span> , <span class="hljs-string">&#x27;defer&#x27;</span> ) %&gt;<br><br>&lt;% &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (theme.<span class="hljs-property">post</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">views</span>.<span class="hljs-property">source</span>===<span class="hljs-string">&#x27;vvdpostpvuv&#x27;</span> ) &#123; %&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vvdpost_container_page_pvuv&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-eye&quot;</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">    &lt;%- views_texts[0] %&gt;<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vvdpost_value_page_pv&quot;</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>&lt;%- views_texts[1]</span><br><span class="language-xml">        + &#x27;&amp;nbsp&amp;nbsp&#x27; %&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-users&quot;</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">        &lt;%- views_texts[0] %&gt;<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vvdpost_value_page_uv&quot;</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>&lt;%- &#x27; 人&#x27; %&gt;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>)</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">var</span> httpRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml">    httpRequest.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;你的域名:端口/poststats&#x27;</span>, <span class="hljs-literal">true</span>);</span></span><br><span class="language-javascript"><span class="language-xml">    httpRequest.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&quot;Content-type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">    httpRequest.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>));</span></span><br><span class="language-javascript"><span class="language-xml">    httpRequest.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<span class="hljs-comment">//请求后的回调接口，可将请求成功后要执行的程序写在其中</span></span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-keyword">if</span> (httpRequest.<span class="hljs-property">readyState</span> == <span class="hljs-number">4</span> &amp;&amp; httpRequest.<span class="hljs-property">status</span> == <span class="hljs-number">200</span>) &#123;<span class="hljs-comment">//验证请求是否发送成功</span></span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-keyword">var</span> json = httpRequest.<span class="hljs-property">responseText</span>;<span class="hljs-comment">//获取到服务端返回的数据</span></span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-keyword">var</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json);</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">pv</span>);</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-keyword">var</span> pvCtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#vvdpost_container_page_pvuv&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pvCtn);</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-keyword">if</span> (pvCtn) &#123;</span></span><br><span class="language-javascript"><span class="language-xml">          <span class="hljs-keyword">var</span> pv_ele = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#vvdpost_value_page_pv&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pv_ele);</span></span><br><span class="language-javascript"><span class="language-xml">          <span class="hljs-keyword">var</span> uv_ele = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#vvdpost_value_page_uv&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(uv_ele);</span></span><br><span class="language-javascript"><span class="language-xml">          <span class="hljs-keyword">if</span> (uv_ele &amp;&amp; uv_ele) &#123;</span></span><br><span class="language-javascript"><span class="language-xml">            pv_ele.<span class="hljs-property">innerText</span> = obj.<span class="hljs-property">pv</span>;</span></span><br><span class="language-javascript"><span class="language-xml">            uv_ele.<span class="hljs-property">innerText</span> = obj.<span class="hljs-property">uv</span>;</span></span><br><span class="language-javascript"><span class="language-xml">            pvCtn.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">&#x27;inline&#x27;</span>;</span></span><br><span class="language-javascript"><span class="language-xml">          &#125;</span></span><br><span class="language-javascript"><span class="language-xml">        &#125;</span></span><br><span class="language-javascript"><span class="language-xml">      &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;;</span></span><br><span class="language-javascript"><span class="language-xml">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>注意这里域名如果是<code>127.0.0.1</code>会展示无效, 具体原因未知，需要是公网域名。最终效果如下：</p><p><img src="https://etcfly.top/Images/picture/old_image/markdown/blog/%E4%B8%BB%E9%A1%B5%E8%AE%BF%E9%97%AE%E9%87%8F.png" srcset="/img/loading.gif" lazyload alt="主页访问量.png"></p><p><img src="https://etcfly.top/Images/picture/old_image/markdown/blog/%E8%AF%84%E8%AE%BA%E5%B1%95%E7%A4%BA.png" srcset="/img/loading.gif" lazyload alt="评论展示.png"></p><p><strong>参考资料</strong>:</p><ul><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-build-pvuv-statistics/build-pvuv-statistics/">Fluid -24- Leancloud 失效解决方案 —— 自建站点 PV UV 统</a></li><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/tools/umami/umami-api/umami-api/">Umami API 使用方法</a></li></ul><hr><h3 id="参考资料-2"><a class="markdownIt-Anchor" href="#参考资料-2"></a> 参考资料</h3><ul><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/tools/umami/umami/">网站统计工具 Umami 安装部署教程</a></li><li><a target="_blank" rel="noopener" href="https://www.zywvvd.com/notes/tools/umami/umami-api/umami-api/#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-329">Umami API 使用方法</a></li><li><a target="_blank" rel="noopener" href="https://umami.is/docs/api">官方文档</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" class="category-chain-item">博客搭建</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/linux/">#linux</a> <a href="/tags/mysql/">#mysql</a> <a href="/tags/Umami/">#Umami</a></div></div><div class="license-box my-3"><div class="license-title"><div>搭建umami+mysql流量统计系统</div><div>http://example.com/2023/01/31/server/umami-mysql/203139/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年1月31日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/01/31/server/waline-mongodb/203528/" title="waline+mongoDb数据库搭建评论系统"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">waline+mongoDb数据库搭建评论系统</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/01/10/hexofluid/hidden-blog/192226/" title="Hexo如何隐藏文章"><span class="hidden-mobile">Hexo如何隐藏文章</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>