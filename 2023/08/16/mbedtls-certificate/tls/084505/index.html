<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              证书解析   关于什么是证书以及和x.509的关系这里不做说明, 需要了解的请参考 “证书的类型和格式” 一节。mbedtls支持x.509证书相关操作,包括:  提供解析DER和PEM证书相关的接口， 提供CSR认证请求文件的解析支持。"><meta property="og:type" content="article"><meta property="og:title" content="mbedtls证书解析和tls通信"><meta property="og:url" content="http://example.com/2023/08/16/mbedtls-certificate/tls/084505/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              证书解析   关于什么是证书以及和x.509的关系这里不做说明, 需要了解的请参考 “证书的类型和格式” 一节。mbedtls支持x.509证书相关操作,包括:  提供解析DER和PEM证书相关的接口， 提供CSR认证请求文件的解析支持。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/chipher.png"><meta property="article:published_time" content="2023-08-16T08:45:05.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="TLS"><meta property="article:tag" content="mbedtls"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/chipher.png"><title>mbedtls证书解析和tls通信 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="mbedtls证书解析和tls通信"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-08-16 08:45" pubdate>2023年8月16日 早上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 24k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 200 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">mbedtls证书解析和tls通信</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h3 id="证书解析"><a class="markdownIt-Anchor" href="#证书解析"></a> 证书解析</h3><p>  关于什么是证书以及和<code>x.509</code>的关系这里不做说明, 需要了解的请参考 “证书的类型和格式” 一节。<code>mbedtls</code>支持<code>x.509</code>证书相关操作,包括:</p><ul><li>提供解析<code>DER</code>和<code>PEM</code>证书相关的接口，</li><li>提供<code>CSR</code>认证请求文件的解析支持。</li><li>提供生成<code>x.509</code>证书接口</li><li>提供证书过期和吊销(<code>CRL</code>)相关支持。</li></ul><hr><h4 id="der证书"><a class="markdownIt-Anchor" href="#der证书"></a> DER证书</h4><p>  要想使用<code>DER</code>证书相关解析, 需要开启宏:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_X509_USE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_OID_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_MD_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SHA256_C</span><br></code></pre></td></tr></table></figure><p>其中<code>MBEDTLS_SHA256_C</code>开启与否取决于证书的签名算法, 定义在<code>oid.c</code>文件的<code>oid_sig_alg</code>数组中, 否则签名算法不支持, 解析会报错。</p><p>解析如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mbedtls_crt.h&quot;</span></span><br><br><span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> cert_der[] = &#123;<br><span class="hljs-number">0x30</span>, <span class="hljs-number">0x82</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x82</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x58</span>,<br><span class="hljs-number">0x7d</span>, <span class="hljs-number">0x7e</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0x9a</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0xc5</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xb0</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x0d</span>,<br><span class="hljs-number">0x06</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x2a</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x31</span>,<br><span class="hljs-number">0x0b</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x4e</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x09</span>,<br><span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4a</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>,<br><span class="hljs-number">0x04</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x16</span>,<br><span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x0a</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x20</span>,<br><span class="hljs-number">0x53</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x56</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x37</span>,<br><span class="hljs-number">0x30</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x30</span>,<br><span class="hljs-number">0x35</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>,<br><span class="hljs-number">0x06</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x4e</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x02</span>,<br><span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4a</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x6e</span>,<br><span class="hljs-number">0x67</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x0a</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x0f</span>,<br><span class="hljs-number">0x49</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x56</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x30</span>,<br><span class="hljs-number">0x81</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x2a</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x05</span>,<br><span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb9</span>, <span class="hljs-number">0x7b</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x17</span>,<br><span class="hljs-number">0x64</span>, <span class="hljs-number">0xbd</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x9a</span>, <span class="hljs-number">0xf1</span>, <span class="hljs-number">0xac</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0xe9</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x8e</span>, <span class="hljs-number">0xf5</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xb6</span>,<br><span class="hljs-number">0xf9</span>, <span class="hljs-number">0x7e</span>, <span class="hljs-number">0xd0</span>, <span class="hljs-number">0xe5</span>, <span class="hljs-number">0xa2</span>, <span class="hljs-number">0xcc</span>, <span class="hljs-number">0x4b</span>, <span class="hljs-number">0xd8</span>, <span class="hljs-number">0xaf</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0xa1</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0xfa</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0x46</span>,<br><span class="hljs-number">0x65</span>, <span class="hljs-number">0x2b</span>, <span class="hljs-number">0xe3</span>, <span class="hljs-number">0xbc</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0xcd</span>, <span class="hljs-number">0xcf</span>, <span class="hljs-number">0xea</span>, <span class="hljs-number">0xa4</span>, <span class="hljs-number">0xdb</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x1a</span>, <span class="hljs-number">0xbc</span>, <span class="hljs-number">0xd7</span>, <span class="hljs-number">0x6e</span>,<br><span class="hljs-number">0xad</span>, <span class="hljs-number">0xc6</span>, <span class="hljs-number">0xa7</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0xdf</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xf4</span>, <span class="hljs-number">0xea</span>, <span class="hljs-number">0xcb</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xca</span>, <span class="hljs-number">0x59</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xee</span>, <span class="hljs-number">0xd6</span>,<br><span class="hljs-number">0x27</span>, <span class="hljs-number">0xaf</span>, <span class="hljs-number">0x4e</span>, <span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x8c</span>, <span class="hljs-number">0x4e</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xaa</span>, <span class="hljs-number">0xef</span>,<br><span class="hljs-number">0x02</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x92</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x56</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0xb7</span>, <span class="hljs-number">0xfe</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x24</span>,<br><span class="hljs-number">0x74</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0xd1</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x82</span>, <span class="hljs-number">0xd8</span>, <span class="hljs-number">0xd2</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0xc5</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0xc0</span>,<br><span class="hljs-number">0x3a</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0xe5</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0xc8</span>, <span class="hljs-number">0xe3</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0xc5</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>,<br><span class="hljs-number">0x01</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x2a</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>,<br><span class="hljs-number">0x03</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x8e</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x8f</span>, <span class="hljs-number">0xca</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xf0</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0xf6</span>,<br><span class="hljs-number">0x08</span>, <span class="hljs-number">0xc8</span>, <span class="hljs-number">0xc3</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0xb9</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0xd6</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0xee</span>, <span class="hljs-number">0x4d</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0xba</span>, <span class="hljs-number">0x75</span>,<br><span class="hljs-number">0xc9</span>, <span class="hljs-number">0xee</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x9c</span>, <span class="hljs-number">0xd4</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0xb3</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xcb</span>, <span class="hljs-number">0x4e</span>, <span class="hljs-number">0xa0</span>, <span class="hljs-number">0xbb</span>,<br><span class="hljs-number">0xf1</span>, <span class="hljs-number">0x1a</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0xa0</span>, <span class="hljs-number">0x92</span>, <span class="hljs-number">0xe9</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0xb0</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0xa9</span>, <span class="hljs-number">0xbe</span>,<br><span class="hljs-number">0xe6</span>, <span class="hljs-number">0xce</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x9e</span>, <span class="hljs-number">0x7e</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0xd6</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0xaf</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0xee</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x81</span>,<br><span class="hljs-number">0xbf</span>, <span class="hljs-number">0xb1</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x9a</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0xb1</span>, <span class="hljs-number">0x7e</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x4d</span>, <span class="hljs-number">0xf5</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x26</span>,<br><span class="hljs-number">0x76</span>, <span class="hljs-number">0xaf</span>, <span class="hljs-number">0xb6</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xe0</span>, <span class="hljs-number">0xc5</span>, <span class="hljs-number">0xb0</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x1c</span>, <span class="hljs-number">0x7b</span>, <span class="hljs-number">0xce</span>, <span class="hljs-number">0x9a</span>, <span class="hljs-number">0xb0</span>,<br><span class="hljs-number">0x88</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0xb1</span>, <span class="hljs-number">0xdb</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0xcb</span>, <span class="hljs-number">0xba</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0a</span>, <span class="hljs-number">0xe9</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0x5b</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0xae</span>,<br><span class="hljs-number">0x5f</span>, <span class="hljs-number">0xf5</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x94</span>,<br>&#125;;<br><br>mbedtls_x509_crt crt;<br>mbedtls_x509_crt_init(&amp;crt);<br><span class="hljs-comment">//int ret = mbedtls_x509_crt_parse_der(&amp;crt, cert_der, sizeof(cert_der)); //拷贝证书</span><br><span class="hljs-type">int</span> ret = mbedtls_x509_crt_parse_der_nocopy(&amp;crt, cert_der, <span class="hljs-keyword">sizeof</span>(cert_der)); <span class="hljs-comment">//不拷贝证书, 解析后cert_der损害会导致crt解析内容出错</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parse der ret:%d\r\n&quot;</span>, ret);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;version:%d\r\n&quot;</span>, crt.version);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;serialNumber len:%d\r\n&quot;</span>, crt.serial.len);<br>show_message(<span class="hljs-string">&quot;serialNumber:&quot;</span>, crt.serial.p, crt.serial.len);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sig_oid len:%d\r\n&quot;</span>, crt.sig_oid.len);<br>show_message(<span class="hljs-string">&quot;sig_oid:&quot;</span>, crt.sig_oid.p, crt.sig_oid.len);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;issuer_raw len:%d\r\n&quot;</span>, crt.issuer_raw.len);<br>show_message(<span class="hljs-string">&quot;issuer_raw:&quot;</span>, crt.issuer_raw.p, crt.issuer_raw.len);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;issuer len:%d\r\n&quot;</span>, crt.issuer.oid.len);<br>show_message(<span class="hljs-string">&quot;issuer:&quot;</span>, crt.issuer.oid.p, crt.issuer.oid.len);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;subject len:%d\r\n&quot;</span>, crt.subject.oid.len);<br>show_message(<span class="hljs-string">&quot;subject:&quot;</span>, crt.subject.oid.p, crt.subject.oid.len);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;valid_from %d/%d/%d|%d:%d:%d\r\n&quot;</span>, crt.valid_from.year, crt.valid_from.mon, crt.valid_from.day,<br>									crt.valid_from.hour, crt.valid_from.min, crt.valid_from.sec);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;valid_to %d/%d/%d|%d:%d:%d\r\n&quot;</span>, crt.valid_to.year, crt.valid_to.mon, crt.valid_to.day,<br>									crt.valid_to.hour, crt.valid_to.min, crt.valid_to.sec);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sig len:%d\r\n&quot;</span>, crt.private_sig.len);<br>show_message(<span class="hljs-string">&quot;sig:&quot;</span>, crt.private_sig.p, crt.private_sig.len);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pk_raw len:%d\r\n&quot;</span>, crt.pk_raw.len);<br>show_message(<span class="hljs-string">&quot;pk_raw:&quot;</span>, crt.pk_raw.p, crt.pk_raw.len);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> buff[<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>];<br>ret = mbedtls_x509_crt_info(buff, <span class="hljs-keyword">sizeof</span>(buff), <span class="hljs-string">&quot;My&quot;</span>, &amp;crt);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;buff:%s\r\n&quot;</span>, buff);<br><br>mbedtls_x509_crt_free(&amp;crt);<br></code></pre></td></tr></table></figure><p>可以使用</p><ul><li><code>mbedtls_x509_crt_info</code>: 获取<code>mbedtls_x509_crt</code>结构内容</li></ul><hr><h4 id="pem证书"><a class="markdownIt-Anchor" href="#pem证书"></a> PEM证书</h4><p>  <code>PEM</code>证书解析需要开启如下宏:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//pem parse</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PEM_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_BASE64_C</span><br></code></pre></td></tr></table></figure><p>同时需要注意<code>pem</code>格式文件定义应该如下格式:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> cert_pem[] = &#123;<br><span class="hljs-string">&quot;-----BEGIN CERTIFICATE-----\r\n\</span><br><span class="hljs-string">MIICEDCCAXkCFC9YVSbnWH1+NneaQMWAsJV2DHbhMA0GCSqGSIb3DQEBCwUAMEcx\</span><br><span class="hljs-string">CzAJBgNVBAYTAkNOMQswCQYDVQQIDAJaSjERMA8GA1UEBwwISGFuZ3pob3UxGDAW\</span><br><span class="hljs-string">BgNVBAoMD0lPVCBUZXN0IFNFUlZFUjAeFw0yMzA3MDcwNTUyNTVaFw0zMzA3MDQw\</span><br><span class="hljs-string">NTUyNTVaMEcxCzAJBgNVBAYTAkNOMQswCQYDVQQIDAJaSjERMA8GA1UEBwwISGFu\</span><br><span class="hljs-string">Z3pob3UxGDAWBgNVBAoMD0lPVCBUZXN0IFNFUlZFUjCBnzANBgkqhkiG9w0BAQEF\</span><br><span class="hljs-string">AAOBjQAwgYkCgYEAuXttF2S9cmua8axuvuntkY71Bbb5ftDlosxL2K9Qofb6ea5G\</span><br><span class="hljs-string">ZSvjvL4Ezc/qpNtXGrzXbq3Gp2vfYvTqy8fKWb+d7tYnr07Bp2C4dkGMTjcyiKrv\</span><br><span class="hljs-string">AhgMkkWQBfdlVge3/uEDJHS40ROC2NL5Bm2EGZbF58A6YR645ZWBNMjjMsUCAwEA\</span><br><span class="hljs-string">ATANBgkqhkiG9w0BAQsFAAOBgQCNhj6OZ1OPyhjwBvYIyMOIPLk81m/uTTb5fbp1\</span><br><span class="hljs-string">ye6R95zUJcdMILNny06gu/Eal0Zif6CS6QFosEYWqb7mzjeefhDWqCCv7TTubDCB\</span><br><span class="hljs-string">v7EvOw9wYppEsX5nTfWTJnavtgGd4MWwn6EMHHvOmrCI5rHbuMu6WArpFg0eW2mu\</span><br><span class="hljs-string">X/V9lA==\r\n\</span><br><span class="hljs-string">-----END CERTIFICATE-----\r\n&quot;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>注意添加的换行, <code>\r\n</code>没添加会导致解析报错, 解析如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_x509_crt pem_crt;<br>mbedtls_x509_crt_init(&amp;pem_crt);<br><br>ret = mbedtls_x509_crt_parse(&amp;pem_crt, cert_pem, <span class="hljs-keyword">sizeof</span>(cert_pem));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> zbuff[<span class="hljs-number">2048</span>];<br>mbedtls_x509_crt_info( zbuff, <span class="hljs-keyword">sizeof</span>(zbuff), <span class="hljs-string">&quot;zbuff &quot;</span>, &amp;pem_crt);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\r\n&quot;</span>, zbuff);<br><br>mbedtls_x509_crt_free(&amp;pem_crt);<br></code></pre></td></tr></table></figure><p>也支持直接解析一个<code>pem/der</code>文件。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_x509_crt_init(&amp;pem_crt);<br>ret = mbedtls_x509_crt_parse_path(&amp;pem_crt, <span class="hljs-string">&quot;/home/etcfly/Desktop/TLS/path_ca&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br></code></pre></td></tr></table></figure><p>同时支持直接解析多个证书, 但是证书需要放在一个目录下, 且目录下必须全部是证书文件, 否则解析到异常格式文件后解析会终止。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_x509_crt pem_crt;<br><br>mbedtls_x509_crt_init(&amp;pem_crt);<br>ret = mbedtls_x509_crt_parse_path(&amp;pem_crt, <span class="hljs-string">&quot;/home/etcfly/Desktop/TLS/path_ca&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;this is a test\r\n&quot;</span>);<br>mbedtls_x509_crt *p = &amp;pem_crt;<br><span class="hljs-keyword">do</span>&#123;<br>	mbedtls_x509_crt_info( zbuff, <span class="hljs-keyword">sizeof</span>(zbuff), <span class="hljs-string">&quot;parse file &quot;</span>, p);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\r\n&quot;</span>, zbuff);<br>	p = p-&gt;next;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r\n\r\n&quot;</span>);<br>&#125; <span class="hljs-keyword">while</span> (p != <span class="hljs-literal">NULL</span>);<br><br><br>mbedtls_x509_crt_free(&amp;pem_crt);<br></code></pre></td></tr></table></figure><hr><h5 id="证书的验签"><a class="markdownIt-Anchor" href="#证书的验签"></a> 证书的验签</h5><p>  当一个证书发布以后, 如何知道该证书是否合法? 是否为第三方冒充呢? 我们需要在收到设备证书时对证书进行验签(需要<code>CA</code>的公钥)。要想支持<code>RSA</code>证书的验签, 需要开启宏<br><code>MBEDTLS_PKCS1_V15</code> 或者 <code>MBEDTLS_PKCS1_V21</code>, 取决于证书<code>RSA</code>填充方式, 我这里是<code>MBEDTLS_PKCS1_V15</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_x509_crt crt;<br>mbedtls_x509_crt ca_crt;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><br>mbedtls_x509_crt_init(&amp;crt);<br>mbedtls_x509_crt_init(&amp;ca_crt);<br><span class="hljs-comment">//解析服务证书</span><br><span class="hljs-type">int</span> ret = mbedtls_x509_crt_parse(&amp;crt, cert_pem, <span class="hljs-keyword">sizeof</span>(cert_pem));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><span class="hljs-comment">//解析CA证书</span><br>ret = mbedtls_x509_crt_parse(&amp;ca_crt, ca_pem, <span class="hljs-keyword">sizeof</span>(ca_pem));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><br>ret = mbedtls_x509_crt_verify(&amp;crt, &amp;ca_crt, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;flags, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><br>mbedtls_x509_crt_free(&amp;crt);<br>mbedtls_x509_crt_free(&amp;ca_crt);<br></code></pre></td></tr></table></figure><p>整个验签的过程如下:</p><p><img src="/2023/08/16/mbedtls-certificate/tls/084505/sign_verify.jpg" srcset="/img/loading.gif" lazyload alt="sign_verify.jpg"></p><ul><li><code>CA</code> 签发证书的过程，如上图左边部分：</li></ul><blockquote><ol><li>首先 <code>CA</code> 会把持有者的公钥、用途、颁发者、有效时间等信息打成一个包(蓝色)，然后对这些信息进行 <code>Hash</code> 计算，得到一个 <code>Hash</code> 值；</li><li>然后 <code>CA</code> 会使用自己的私钥将该 <code>Hash</code> 值加密，生成 <code>Certificate Signature</code>，也就是 <code>CA</code> 对证书做了签名；</li><li>最后将 <code>Certificate Signature</code> 添加在文件证书上，形成数字证书；</li></ol></blockquote><ul><li>客户端校验服务端的数字证书的过程，如上图右边部分：</li></ul><blockquote><ol><li>首先客户端会使用同样的 <code>Hash</code> 算法计算该证书的 <code>Hash</code> 值 <code>H1</code>；</li><li>通常浏览器和操作系统中集成了 <code>CA</code> 的公钥信息，浏览器收到服务器的证书后可以使用 <code>CA</code> 的公钥解密 <code>Certificate Signature</code> 内容，得到一个 <code>Hash</code> 值 <code>H2</code> ；</li><li>最后比较 <code>H1</code> 和 <code>H2</code>，如果值相同，则为可信赖的证书，否则则认为服务器证书不可信。</li></ol></blockquote><hr><h6 id="证书链"><a class="markdownIt-Anchor" href="#证书链"></a> 证书链</h6><p>  但事实上，证书的验证过程中还存在一个证书信任链的问题，因为我们向 <code>CA</code> 申请的证书一般不是根证书签发的，而是由中间证书签发的。</p><p><img src="/2023/08/16/mbedtls-certificate/tls/084505/%E8%AF%81%E4%B9%A6%E9%93%BE2.jpg" srcset="/img/loading.gif" lazyload alt="证书链2.jpg"></p><p>比如百度的证书，从下图你可以看到，证书的层级有三级：</p><p><img src="/2023/08/16/mbedtls-certificate/tls/084505/%E8%AF%81%E4%B9%A6%E9%93%BE.jpg" srcset="/img/loading.gif" lazyload alt="证书链.jpg"></p><ul><li><p>客户端收到 <code>baidu.com</code> 的证书后，发现这个证书的签发者不是根证书，就无法根据本地已有的根证书中的公钥去验证 <code>baidu.com</code> 证书是否可信。于是，客户端根据 <code>baidu.com</code> 证书中的签发者，找到该证书的颁发机构是 “<code>GlobalSign Organization Validation CA - SHA256 - G2</code>”</p></li><li><p>请求到证书后发现 “<code>GlobalSign Organization Validation CA - SHA256 - G2</code>” 证书是由 “<code>GlobalSign Root CA</code>” 签发的，由于 “<code>GlobalSign Root CA</code>” 没有再上级签发机构，说明它是根证书，也就是自签证书。应用软件会检查此证书有否已预载于根证书清单上，如果有，则可以利用根证书中的公钥去验证 “<code>GlobalSign Organization Validation CA - SHA256 - G2</code>” 证书，如果发现验证通过，就认为该中间证书是可信的。</p></li><li><p>“<code>GlobalSign Organization Validation CA - SHA256 - G2</code>&quot;” 证书被信任后，可以使用 “<code>GlobalSign Organization Validation CA - SHA256 - G2</code>” 证书中的公钥去验证 <code>baidu.com</code> 证书的可信性，如果验证通过，就可以信任 <code>baidu.com</code>证书。</p></li></ul><p>实时上操作系统出厂的时候会内置一些<code>CA</code>证书, 于是就形成了一条完整的信任链条。</p><p><img src="/2023/08/16/mbedtls-certificate/tls/084505/%E4%BF%A1%E4%BB%BB%E9%93%BE.jpg" srcset="/img/loading.gif" lazyload alt="信任链.jpg"></p><p>一般<code>windown</code>操作系统内置证书可通过<code>cmd</code>执行<code>certmgr.msc</code>。</p><p><img src="/2023/08/16/mbedtls-certificate/tls/084505/windown%E5%86%85%E7%BD%AE%E8%AF%81%E4%B9%A6.png" srcset="/img/loading.gif" lazyload alt="windown内置证书.png"></p><hr><h4 id="crl相关"><a class="markdownIt-Anchor" href="#crl相关"></a> CRL相关</h4><p>  关于如何生成一个<code>crl</code>吊销文件， 请参考 “openssl基础” 一节。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_x509_crt crt;<br>mbedtls_x509_crt ca_crt;<br>mbedtls_x509_crl crl_crt;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><br>mbedtls_x509_crt_init(&amp;crt);<br>mbedtls_x509_crt_init(&amp;ca_crt);<br>mbedtls_x509_crl_init(&amp;crl_crt);<br><span class="hljs-comment">//解析服务证书</span><br><span class="hljs-type">int</span> ret = mbedtls_x509_crt_parse(&amp;crt, cert_pem, <span class="hljs-keyword">sizeof</span>(cert_pem));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><span class="hljs-comment">//解析CA证书</span><br>ret = mbedtls_x509_crt_parse(&amp;ca_crt, ca_pem, <span class="hljs-keyword">sizeof</span>(ca_pem));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><br><span class="hljs-comment">//解析CRL吊销证书</span><br>ret = mbedtls_x509_crl_parse(&amp;crl_crt, ca_crl, <span class="hljs-keyword">sizeof</span>(ca_crl));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;crl parse ret:%d\r\n&quot;</span>, ret);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> crl_buff[<span class="hljs-number">2048</span>];<br>ret = mbedtls_x509_crl_info(crl_buff, <span class="hljs-keyword">sizeof</span>(crl_buff), <span class="hljs-string">&quot;CRL: &quot;</span>, &amp;crl_crt);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;crl info:%d\r\n %s\r\n&quot;</span>, ret, crl_buff);<br><br>ret = mbedtls_x509_crt_verify(&amp;crt, &amp;ca_crt, &amp;crl_crt, <span class="hljs-literal">NULL</span>, &amp;flags, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret:%d\r\n&quot;</span>, ret);<br><br>mbedtls_x509_crt_free(&amp;crt);<br>mbedtls_x509_crt_free(&amp;ca_crt);<br>mbedtls_x509_crl_free(&amp;crl_crt);<br></code></pre></td></tr></table></figure><p>最终, 经过吊销的证书校验时返回<code>MBEDTLS_X509_BADCERT_REVOKED</code>错误。也可以使用如下接口检验证书是否吊销:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = mbedtls_x509_crt_is_revoked(&amp;crt, &amp;crl_crt);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;revoked:%s\r\n&quot;</span>, ret &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">&quot;true&quot;</span> : <span class="hljs-string">&quot;false&quot;</span>);<br></code></pre></td></tr></table></figure><hr><h3 id="ssl"><a class="markdownIt-Anchor" href="#ssl"></a> SSL</h3><p>  要想在<code>mbedtls</code>中正确使用<code>tls</code>功能, 需要进行一系列的配置, <code>tls</code>入口主要是四个部分</p><ul><li><code>tls_read</code>: <code>tls</code>接收接口, 在<code>tls buffer</code>中读取已经解密过的数据</li><li><code>tls_write</code>: <code>tls</code>发送接口, 向<code>tls buffer</code>中写入待加密的内容</li><li><code>tls_connect</code>: 建立<code>tls</code>连接, 协商<code>tls</code>密钥参数, 认证身份等。</li><li><code>tls_disconnect</code>: 断开<code>tls</code>连接, 保存会话信息用于快速恢复等。</li></ul><p>现在一步步来讲解这几部分, 配置和部署自己的<code>TLS</code>。</p><h4 id="配置说明"><a class="markdownIt-Anchor" href="#配置说明"></a> 配置说明</h4><p><code>TLS1.3</code>中将椭圆曲线作为基本的加密方法</p><ul><li>配置椭圆曲线列表</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP384R1_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP521R1_ENABLED</span><br></code></pre></td></tr></table></figure><ul><li>使能临时密钥交换模式</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_TLS1_3_KEY_EXCHANGE_MODE_EPHEMERAL_ENABLED</span><br></code></pre></td></tr></table></figure><ul><li>配置密钥交换算法</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//for key exchange</span><br><span class="hljs-comment">//psk</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_PSK_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_RSA_PSK_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_DHE_PSK_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDHE_PSK_ENABLED</span><br><br><span class="hljs-comment">//rsa ecdhe ecdsa</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_RSA_ENABLED <span class="hljs-comment">//rsa交换和签名</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_DHE_RSA_ENABLED  <span class="hljs-comment">//dhe交换 rsa签名</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDHE_RSA_ENABLED <span class="hljs-comment">//ecdhe交换 rsa签名</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDH_RSA_ENABLED <span class="hljs-comment">//ecdh交换 rsa签名</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDH_ECDSA_ENABLED <span class="hljs-comment">//ecdh交换 ecdsa签名</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDHE_ECDSA_ENABLED <span class="hljs-comment">//ecdhe交换 ecdsa签名</span></span><br><span class="hljs-comment">//#define MBEDTLS_KEY_EXCHANGE_ECJPAKE_ENABLED</span><br></code></pre></td></tr></table></figure><ul><li>配置客户端</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_TLS_C <span class="hljs-comment">//使能tls</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_CLI_C <span class="hljs-comment">//配置客户端</span></span><br></code></pre></td></tr></table></figure><ul><li>配置协议</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_PROTO_TLS1_2 <span class="hljs-comment">//tls1.2</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_PROTO_TLS1_3 <span class="hljs-comment">//tls1.3</span></span><br></code></pre></td></tr></table></figure><ul><li>快速恢复</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_SESSION_TICKETS</span><br></code></pre></td></tr></table></figure><ul><li>重协商</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_RENEGOTIATION</span><br></code></pre></td></tr></table></figure><ul><li>配置tls缓存</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_OUT_CONTENT_LEN 10240 <span class="hljs-comment">//10240 Byte</span></span><br></code></pre></td></tr></table></figure><hr><h4 id="tls12配置"><a class="markdownIt-Anchor" href="#tls12配置"></a> tls1.2配置</h4><p>如下是<code>tls1.2</code>的通用配置</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//基础的密码学原语支持</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_AES_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_RSA_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_BIGNUM_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_RSA_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_DHM_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECDH_C</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_CRYPTO_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_MD_C</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CTR_DRBG_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ENTROPY_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CIPHER_C</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_HAVE_ECDSA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SHA256_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SHA384_C</span><br><br><span class="hljs-comment">//x.509证书支持</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_OID_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_X509_USE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_BASE64_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PEM_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span><br><br><span class="hljs-comment">//允许签名sha384</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_ACCEL_ALG_SHA_256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_ACCEL_ALG_SHA_384</span><br><br><br><span class="hljs-comment">//支持的椭圆曲线</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP384R1_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP521R1_ENABLED</span><br><br><br><span class="hljs-comment">//填充算法</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PKCS1_V15</span><br><br><span class="hljs-comment">//支持TLS</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_TLS_C</span><br><br><span class="hljs-comment">//配置tls客户端</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_CLI_C</span><br><br><span class="hljs-comment">//tls支持的协议</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_PROTO_TLS1_2</span><br><br><span class="hljs-comment">//sessionTicket支持</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_SESSION_TICKETS</span><br><br><span class="hljs-comment">//允许重协商</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_RENEGOTIATION</span><br><br><span class="hljs-comment">//定义密钥交换和签名算法</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDHE_ECDSA_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDHE_RSA_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_RSA_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_DHE_RSA_ENABLED</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_KEEP_PEER_CERTIFICATE</span><br><br><span class="hljs-comment">//for debug</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_DEBUG_C</span><br><br><span class="hljs-comment">//证书使用的签名算法</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_256_VIA_LOWLEVEL_OR_PSA  <span class="hljs-comment">//sha256WithRSAEncryption / ecdsa-with-SHA256</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_384_VIA_LOWLEVEL_OR_PSA  <span class="hljs-comment">//sha384WithRSAEncryption / ecdsa-with-SHA384</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_1_VIA_LOWLEVEL_OR_PSA    <span class="hljs-comment">//sha-1WithRSAEncryption  / ecdsa-with-SHA1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_224_VIA_LOWLEVEL_OR_PSA  <span class="hljs-comment">//sha224WithRSAEncryption / ecdsa-with-SHA224</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_512_VIA_LOWLEVEL_OR_PSA  <span class="hljs-comment">//sha512WithRSAEncryption / ecdsa-with-SHA512</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_MD5_VIA_LOWLEVEL_OR_PSA      <span class="hljs-comment">//md5WithRSAEncryption</span></span><br><br><span class="hljs-comment">//使能椭圆曲线签名和校验</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECDSA_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_CAN_ECDSA_SIGN</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_CAN_ECDSA_VERIFY</span><br><br><span class="hljs-comment">//密码套件</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_GCM_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_256_VIA_MD_OR_PSA_BASED_ON_USE_PSA <span class="hljs-comment">//支持HASH256签名密码套件</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_384_VIA_MD_OR_PSA_BASED_ON_USE_PSA <span class="hljs-comment">//支持HASH384签名密码套件</span></span><br></code></pre></td></tr></table></figure><hr><h4 id="tls13配置"><a class="markdownIt-Anchor" href="#tls13配置"></a> tls1.3配置</h4><p>如下是<code>tls1.3</code>的一个通用配置</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//基础的密码学原语支持</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_AES_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_GCM_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CIPHER_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SHA256_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SHA384_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_BIGNUM_C</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_CRYPTO_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ENTROPY_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_USE_PSA_CRYPTO</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CCM_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CHACHAPOLY_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CHACHA20_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_POLY1305_C</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_HAVE_ECDSA</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_CAN_ECDSA_SOME</span><br><br><span class="hljs-comment">//x.509证书支持</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_OID_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_X509_USE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PK_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_BASE64_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PEM_PARSE_C</span><br><br><span class="hljs-comment">//支持的椭圆曲线</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP384R1_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECP_DP_SECP521R1_ENABLED</span><br><br><span class="hljs-comment">//支持TLS</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_TLS_C</span><br><br><span class="hljs-comment">//配置tls客户端</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_CLI_C</span><br><br><span class="hljs-comment">//tls支持的协议</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_PROTO_TLS1_2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_PROTO_TLS1_3</span><br><br><span class="hljs-comment">//证书认证配置</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_KEEP_PEER_CERTIFICATE</span><br><br><span class="hljs-comment">//sessionTicket支持</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_SESSION_TICKETS</span><br><br><span class="hljs-comment">//允许重协商</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_RENEGOTIATION</span><br><br><br><span class="hljs-comment">//支持的密钥交换算法</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_KEY_EXCHANGE_ECDHE_ECDSA_ENABLED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECDH_C</span><br><br><span class="hljs-comment">//使能debug</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_DEBUG_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_CTR_DRBG_C</span><br><br><br><span class="hljs-comment">//填充算法</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PKCS1_V15</span><br><br><span class="hljs-comment">//for tls1.3 chipher suite</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_384_VIA_MD_OR_PSA_BASED_ON_USE_PSA</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_256_VIA_MD_OR_PSA_BASED_ON_USE_PSA</span><br><br><br><span class="hljs-comment">//签名算法使用ECDSA</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ECDSA_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span><br><br><span class="hljs-comment">//允许签名sha384</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_MD_CAN_SHA3_384</span><br><br><span class="hljs-comment">//允许椭圆加密算法</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_TLS1_3_KEY_EXCHANGE_MODE_EPHEMERAL_ENABLED</span><br><br><br><span class="hljs-comment">//for HKDF alg</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PSA_WANT_ALG_HKDF_EXTRACT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PSA_WANT_ALG_HKDF_EXPAND</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_BUILTIN_ALG_HKDF</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_BUILTIN_ALG_HKDF_EXTRACT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_PSA_BUILTIN_ALG_HKDF_EXPAND</span><br><span class="hljs-comment">//#define MBEDTLS_PSA_BUILTIN_ALG_TLS12_PRF</span><br><span class="hljs-comment">//#define MBEDTLS_PSA_BUILTIN_ALG_TLS12_PSK_TO_MS</span><br><br><span class="hljs-comment">//使能TLS1.2-TLS1.3兼容</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_TLS1_3_COMPATIBILITY_MODE</span><br><br><span class="hljs-comment">//使能servername扩展</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_SSL_SERVER_NAME_INDICATION</span><br></code></pre></td></tr></table></figure><p>有时候一些老的证书是通过<code>rsa withh sha1</code>来签名的, 所有需要加上如下宏:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_RSA_C <span class="hljs-comment">//rsa</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MBEDTLS_HAS_ALG_SHA_1_VIA_LOWLEVEL_OR_PSA <span class="hljs-comment">//SHA1签名</span></span><br><span class="hljs-comment">// #define MBEDTLS_HAS_ALG_MD5_VIA_LOWLEVEL_OR_PSA //md5签名</span><br><span class="hljs-comment">// #define MBEDTLS_HAS_ALG_SHA_224_VIA_LOWLEVEL_OR_PSA //SHA224签名</span><br><span class="hljs-comment">// #define MBEDTLS_HAS_ALG_SHA_256_VIA_LOWLEVEL_OR_PSA //SHA256签名</span><br><span class="hljs-comment">// #define MBEDTLS_HAS_ALG_SHA_384_VIA_LOWLEVEL_OR_PSA //SHA384签名</span><br><span class="hljs-comment">// #define MBEDTLS_HAS_ALG_SHA_512_VIA_LOWLEVEL_OR_PSA //SHA512签名</span><br></code></pre></td></tr></table></figure><p>注意, 如上的配置内容, 可以通过自定义一个<code>tls_config.h</code>文件, 在编译的时候通过<code>-DMBEDTLS_CONFIG_FILE=\&quot;tls_config.h\&quot;</code>参数来生效配置。</p><p>另外<code>mbedtls</code>密码套件通过几个数据结构定义和维持:</p><ul><li>密码套件: <code>ciphersuite_definitions</code>数组中定义, 不支持请修改相关宏</li><li>证书签名算法: <code>oid_sig_alg</code>数组中定义, 不支持请修改该数据配置宏</li><li>支持的椭圆曲线: <code>ecp_supported_curves</code>中定义, 不支持请修改相关宏</li></ul><p>接下来我们来实现<code>connect</code>部分逻辑。</p><h4 id="connect"><a class="markdownIt-Anchor" href="#connect"></a> connect</h4><p>  <code>connect</code>部分主要完成的任务有:</p><ul><li>设置加密套件以及其他参数(如支持的签名算法、设置根证书等)</li></ul><blockquote><p>设置随机数</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_ctr_drbg_init(&amp;handler-&gt;ctrl_drbg);<br>mbedtls_entropy_init(&amp;handler-&gt;entropy_ctx); <span class="hljs-comment">//初始化熵</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> iv[<span class="hljs-number">16</span>]; <span class="hljs-comment">//初始化iv值</span><br>ret = mbedtls_ctr_drbg_seed(&amp;handler-&gt;ctrl_drbg, mbedtls_entropy_func, &amp;handler-&gt;entropy_ctx, iv, <span class="hljs-keyword">sizeof</span>(iv)); <span class="hljs-comment">//设置随机数种子</span><br><br>mbedtls_ssl_conf_rng(&amp;handler-&gt;ssl_config, mbedtls_ctr_drbg_random, &amp;handler-&gt;ctrl_drbg); <span class="hljs-comment">//配置随机数</span><br></code></pre></td></tr></table></figure><blockquote><p>配置默认参数</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = mbedtls_ssl_config_defaults(&amp;handler-&gt;ssl_config, MBEDTLS_SSL_IS_CLIENT, MBEDTLS_SSL_TRANSPORT_STREAM, MBEDTLS_SSL_PRESET_DEFAULT); <span class="hljs-comment">//配置默认加密参数</span><br></code></pre></td></tr></table></figure><blockquote><blockquote><ul><li><code>MBEDTLS_SSL_PRESET_DEFAULT</code>: 表示使用预设的默认的加密套件</li></ul></blockquote></blockquote><blockquote><p>配置数字证书</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_x509_crt_init(&amp;handler-&gt;cert_ctx);<br><span class="hljs-type">int</span> ret = mbedtls_x509_crt_parse(&amp;handler-&gt;cert_ctx, s_lc_certificate.cert[i].p_der, s_lc_certificate.cert[i].der_len); <span class="hljs-comment">//解析证书</span><br>mbedtls_ssl_conf_ca_chain(&amp;handler-&gt;ssl_config, &amp;handler-&gt;cert_ctx, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></table></figure><blockquote><p>配置密码套件</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-type">static</span> mbedtls_ecp_group_id tls_group[] = &#123;<br>        MBEDTLS_ECP_DP_SECP256R1,<br>        MBEDTLS_ECP_DP_SECP384R1,<br>        MBEDTLS_ECP_DP_SECP521R1,<br>        MBEDTLS_ECP_DP_NONE,<br>    &#125;;<br><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> tls_ciphersuites[] = &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined (ENABLE_TLS_1_2) &amp;&amp; (ENABLE_TLS_1_2 == 1u)</span><br>		MBEDTLS_TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,<br>        MBEDTLS_TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,<br>        MBEDTLS_TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,<br>        MBEDTLS_TLS_DHE_RSA_WITH_AES_128_CBC_SHA,<br>        MBEDTLS_TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,<br>        MBEDTLS_TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384,<br>        MBEDTLS_TLS_RSA_WITH_AES_256_CBC_SHA256,<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>        MBEDTLS_TLS_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256,<br>		MBEDTLS_TLS1_3_AES_128_GCM_SHA256,<br>		MBEDTLS_TLS1_3_AES_128_CCM_SHA256,<br>		MBEDTLS_TLS1_3_AES_128_CCM_8_SHA256,<br>		MBEDTLS_TLS1_3_CHACHA20_POLY1305_SHA256,<br>		MBEDTLS_TLS1_3_AES_256_GCM_SHA384,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        <span class="hljs-number">0</span>,<br>    &#125;;<br><br>    mbedtls_ssl_conf_ciphersuites(cfg, tls_ciphersuites);<span class="hljs-comment">//配置密码套件</span><br>    mbedtls_ssl_conf_curves(cfg, tls_group);  <span class="hljs-comment">//配置加密曲线</span><br>    <span class="hljs-comment">//mbedtls_ssl_conf_sig_algs //配置签名算法</span><br></code></pre></td></tr></table></figure><blockquote><p>配置网卡接收回调</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_ssl_set_bio(&amp;p_tls_mgr-&gt;ssl_ctx, p_custom_net_ctx, send_cb, recv_cb, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></table></figure><blockquote><blockquote><ul><li><code>send_cb</code>: 网卡底层发送接口</li><li><code>recv_cb</code>: 网卡底层接收接口</li></ul></blockquote></blockquote><blockquote><p>设置主机名</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_ssl_set_hostname(&amp;p_tls_mgr-&gt;ssl_ctx, hostname);<br></code></pre></td></tr></table></figure><p>需要注意设置主机名需要开启宏<code>MBEDTLS_SSL_SERVER_NAME_INDICATION</code></p><blockquote><p>建立<code>ssl_ctx</code>配置上下文</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = mbedtls_ssl_setup(&amp;p_tls_mgr-&gt;ssl_ctx, &amp;p_tls_mgr-&gt;ssl_config);<br></code></pre></td></tr></table></figure><blockquote><p>开启握手流程</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((ret = mbedtls_ssl_handshake(&amp;p_tls_mgr-&gt;ssl_ctx)) != <span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> handshake_flags = mbedtls_ssl_get_verify_result(&amp;p_tls_mgr-&gt;ssl_ctx);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tls handshake ret:%x flags:%d\r\n&quot;</span>, ret, handshake_flags);<br><br>    <span class="hljs-keyword">if</span>(( ret != MBEDTLS_ERR_SSL_WANT_READ  &amp;&amp; \<br>         ret != MBEDTLS_ERR_SSL_WANT_WRITE &amp;&amp; \<br>     	 ret != (MBEDTLS_ERR_X509_UNKNOWN_SIG_ALG + MBEDTLS_ERR_OID_NOT_FOUND)<br>        ))<br>        &#123;<br>            <span class="hljs-keyword">return</span> ret;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果需要通过<code>sessionTicket</code>快速恢复会话, <code>tls1.2</code>步骤如下:</p><blockquote><p><code>tls_diconnect</code>时保存会话内容</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">mbedtls_ssl_get_session(&amp;handler-&gt;ssl_ctx, &amp;s_tls_cache.saved_session);<br>s_tls_cache.has_saved_session = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><blockquote><p><code>tls_connect</code>时恢复会话</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (s_tls_cache.has_saved_session) &#123;<br>   	<span class="hljs-type">int</span> ret = mbedtls_ssl_set_session(&amp;p_tls_mgr-&gt;ssl_ctx, &amp;s_tls_cache.saved_session);<br>       <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != ret) &#123;<br>           <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set session ticket fail %d\r\n&quot;</span>, ret);<br>       &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>首次初始化会话</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">	<span class="hljs-keyword">if</span> (!s_tls_cache.tls_init)<br>	&#123;<br>        s_tls_cache.tls_init = <span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(ENABLE_TLS_NEW_SESSION_TICKET) &amp;&amp; (ENABLE_TLS_NEW_SESSION_TICKET == 1u)</span><br>        s_tls_cache.has_saved_session = <span class="hljs-number">0</span>;<br>        mbedtls_ssl_session_init(&amp;s_tls_cache.saved_session);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	&#125;<br></code></pre></td></tr></table></figure><p>如果是<code>tls1.3</code>, 还需要处理<code>newSessionTicket</code>, 一般<code>nginx</code>服务器在一次握手完成都会发送两次.所有要进行处理。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __tls_1_3_new_sessionTicket_get(<span class="hljs-type">tls_mgr_t</span> *p_tls_mgr)<br>&#123;<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCAL_BUFF_TEMP_SIZE 1024</span><br>    <span class="hljs-type">int</span> max_session_ticket = MAX_TLS_SESSION_TICKET_NUM;<br><br>    <span class="hljs-type">char</span> *pbuffer = <span class="hljs-built_in">malloc</span>(LOCAL_BUFF_TEMP_SIZE);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pbuffer)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pbuffer malloc fail\r\n&quot;</span>);<br>        __mbedtls_env_deinit(p_tls_mgr);<br>        __mbedtls_free_certificate(p_tls_mgr);<br>        <span class="hljs-built_in">free</span>(p_tls_mgr);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> ((ret = mbedtls_ssl_read(&amp;p_tls_mgr-&gt;ssl_ctx, pbuffer, LOCAL_BUFF_TEMP_SIZE)) == MBEDTLS_ERR_SSL_WANT_READ)<br>    &#123;<br>        --max_session_ticket;<br>        <span class="hljs-keyword">while</span> ((ret = mbedtls_ssl_handshake(&amp;p_tls_mgr-&gt;ssl_ctx)) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> handshake_flags = mbedtls_ssl_get_verify_result(&amp;p_tls_mgr-&gt;ssl_ctx);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tls handshake ret:%x flags:%d\r\n&quot;</span>, ret, handshake_flags);<br><br>            <span class="hljs-keyword">if</span>(( ret != MBEDTLS_ERR_SSL_WANT_READ  &amp;&amp; \<br>                ret != MBEDTLS_ERR_SSL_WANT_WRITE &amp;&amp; \<br>                ret != MBEDTLS_ERR_SSL_RECEIVED_NEW_SESSION_TICKET &amp;&amp;\<br>                ret != (MBEDTLS_ERR_X509_UNKNOWN_SIG_ALG + MBEDTLS_ERR_OID_NOT_FOUND)<br>                ))<br>                &#123;<br>                    __mbedtls_env_deinit(p_tls_mgr);<br>                    __mbedtls_free_certificate(p_tls_mgr);<br>                    <span class="hljs-built_in">free</span>(p_tls_mgr);<br>                    <span class="hljs-built_in">free</span>(pbuffer);<br>                    <span class="hljs-keyword">return</span> ret;<br>                &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (max_session_ticket&lt;=<span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ret value:%d\r\n&quot;</span>, ret);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">free</span>(pbuffer);<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><hr><ul><li>和服务端握手(握手包括协商加密参数、服务端身份认证等)</li></ul><p>和服务器握手都在<code>mbedtls_ssl_handshake</code>中进行处理的, 内部会维护一个<code>ssl-&gt;state</code>的状态机来处理<code>ssl</code>握手的各个状态。</p><p>对于<code>tls1.2</code>而言, 握手需要关注:</p><ol><li><code>clienthello</code>签名能力和服务端证书是否匹配</li><li><code>clienthello</code>中密码套件服务端是否支持</li><li>包含的<code>servername</code>是否正确。</li></ol><p>如果二者没问题, 服务端基本会回复<code>serverHello</code>、<code>certificate</code>等, 这时候就涉及到设备内置根证书是否可以解密服务端证书。同时该阶段握手失败还可能客户端相关算法没有打开。如果该阶段完成, 基本<code>tls</code>就<code>ok</code>了。</p><p>对于<code>tls1.3</code>而言, 握手和<code>tls1.2</code>有所不同, 其<code>clienthello</code>需要关注:</p><ol><li><code>clienthello</code>签名能力和服务端证书是否匹配</li><li><code>clienthello</code>中密码套件服务端是否支持</li><li><code>clientHello</code>协议版本是否为<code>tls1.2</code>, 同时必须包含<code>support_version</code>扩展且版本为<code>tls1.3</code></li><li>包含的<code>servername</code>是否正确。</li><li>非<code>psk</code>模式必须包含<code>key_share</code>扩展, <code>psk</code>模式必须包含<code>pre_shared_key</code></li></ol><p>如果这些参数都是正常的, 服务端这时候会回复<code>serverHello</code>、<code>certificate</code>等, 此时客户端接收完成会校验证书, 切换密钥并回复<code>finish</code>，, 如果这个阶段出问题, 需要考虑。</p><ol><li>客户端是否支持相关的算法</li><li>客户端内置证书是否正确</li></ol><p>如果<code>newSessionTick</code>存在, 还需要处理, 在<code>tls1.3</code>中, 其在服务端<code>finish</code>后任意时间发送, 而在<code>tls1.2</code>, 其在服务端<code>change cipher spec</code>后发送。</p><p>这里并不支持<code>psk</code>快速恢复。</p><hr><h4 id="disconnect"><a class="markdownIt-Anchor" href="#disconnect"></a> disconnect</h4><p>断开连接主要涉及处理<code>tls</code>相关资源的释放处理, 同时如果支持快速恢复, 还涉及到<code>sessionTicket</code>的保存。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">tls_disconnect</span><span class="hljs-params">(<span class="hljs-type">ptls_handler_t</span> p_tls_handler)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(p_tls_handler == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input Invalid&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-type">tls_mgr_t</span> *handler = p_tls_handler;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(ENABLE_TLS_NEW_SESSION_TICKET) &amp;&amp; (ENABLE_TLS_NEW_SESSION_TICKET == 1u)</span><br>    mbedtls_ssl_get_session(&amp;handler-&gt;ssl_ctx, &amp;s_tls_cache.saved_session);<br>    s_tls_cache.has_saved_session = <span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(ENABLE_TLS_NEW_SESSION_ID) &amp;&amp; (ENABLE_TLS_NEW_SESSION_ID == 1u)</span><br>    mbedtls_ssl_cache_set(&amp;s_tls_cache.cache_session, s_tls_cache.sessionId, <span class="hljs-keyword">sizeof</span>(s_tls_cache.sessionId), &amp;handler-&gt;ssl_ctx);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    __mbedtls_env_deinit(handler);<br>    __mbedtls_free_certificate(handler);<br><br>    <span class="hljs-built_in">free</span>(handler);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="read-write"><a class="markdownIt-Anchor" href="#read-write"></a> read / write</h4><p>当完成握手, 后面应用层将通过<code>read</code>和<code>write</code>接口发送数据, 数据通过握手协商的数据进行加密或者解密进行收发。</p><ul><li><code>read</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">tls_raw_read</span><span class="hljs-params">(<span class="hljs-type">ptls_handler_t</span> p_tls_handler,  <span class="hljs-type">char</span> *buffer, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> buf_len)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == p_tls_handler || <span class="hljs-literal">NULL</span> == buffer || buf_len == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p_tls_handler NULL\r\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br><br>    <span class="hljs-type">tls_mgr_t</span> *handler = p_tls_handler;<br>    <span class="hljs-type">int</span> len= mbedtls_ssl_read(&amp;handler-&gt;ssl_ctx, buffer, buf_len);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;app read [len:%d]\r\n&quot;</span>, len);<br>    <span class="hljs-keyword">return</span> len;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>write</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">tls_raw_write</span><span class="hljs-params">(<span class="hljs-type">ptls_handler_t</span> p_tls_handler, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> buf_len)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == p_tls_handler || <span class="hljs-literal">NULL</span> == buffer || buf_len == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p_tls_handler NULL\r\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> write_len = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">tls_mgr_t</span> *handler = p_tls_handler;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;app write data[len:%d]:%s\r\n&quot;</span>, buf_len, buffer);<br>    <span class="hljs-keyword">while</span> (write_len &lt; buf_len)<br>    &#123;<br>        <span class="hljs-type">int</span> ret = mbedtls_ssl_write(&amp;handler-&gt;ssl_ctx, &amp;buffer[write_len], buf_len-write_len);<br>        <span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            write_len += ret;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>( (ret == MBEDTLS_ERR_SSL_WANT_READ) || (ret == MBEDTLS_ERR_SSL_WANT_WRITE) )<br>        &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> write_len;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h3><ul><li><a target="_blank" rel="noopener" href="https://github.com/Mbed-TLS/mbedtls/issues/2917">How to re-use tickets in client mode</a></li><li><a target="_blank" rel="noopener" href="https://www.liuvv.com/p/be73ec63.html">https协议</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" class="category-chain-item">密码学</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/TLS/">#TLS</a> <a href="/tags/mbedtls/">#mbedtls</a></div></div><div class="license-box my-3"><div class="license-title"><div>mbedtls证书解析和tls通信</div><div>http://example.com/2023/08/16/mbedtls-certificate/tls/084505/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年8月16日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/08/16/tls/certificate/084839/" title="部署安全的tls证书"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">部署安全的tls证书</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/07/18/chipher/base-openssl/214013/" title="openssl基础"><span class="hidden-mobile">openssl基础</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>