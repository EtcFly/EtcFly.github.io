<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介   扩展是 TLS 比较重要的一个知识点。它的存在能让 Client 和 Server 在不更新 TLS 的基础上，获得新的能力。扩展的官方文档在 【RFC 6066】 中定义。Extension 像 TLS 中的一系列可水平扩展的"><meta property="og:type" content="article"><meta property="og:title" content="tls协议扩展详情"><meta property="og:url" content="http://example.com/2023/08/16/mbedtls-certificate/ext/085157/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介   扩展是 TLS 比较重要的一个知识点。它的存在能让 Client 和 Server 在不更新 TLS 的基础上，获得新的能力。扩展的官方文档在 【RFC 6066】 中定义。Extension 像 TLS 中的一系列可水平扩展的"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/chipher.png"><meta property="article:published_time" content="2023-08-16T08:51:57.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="TLS"><meta property="article:tag" content="mbedtls"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/chipher.png"><title>tls协议扩展详情 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="tls协议扩展详情"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-08-16 08:51" pubdate>2023年8月16日 早上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 27k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 222 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">tls协议扩展详情</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2><p>  扩展是 <code>TLS</code> 比较重要的一个知识点。它的存在能让 <code>Client</code> 和 <code>Server</code> 在不更新 <code>TLS</code> 的基础上，获得新的能力。扩展的官方文档在 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6066">【RFC 6066】</a> 中定义。<code>Extension</code> 像 <code>TLS</code> 中的一系列可水平扩展的插件。</p><p>  <code>Client</code> 在 <code>ClientHello</code> 中申明多个自己可以支持的 <code>Extension</code>，以向 <code>Server</code> 表示自己有以下这些能力，或者向 <code>Server</code> 协商某些协议。<code>Server</code> 收到 <code>ClientHello</code> 以后，依次解析 <code>Extension</code>，有些如果需要立即回应，就在 <code>ServerHello</code> 中作出回应，有些不需要回应，或者 <code>Server</code> 不支持的 <code>Extension</code> 就不用响应，忽略不处理。</p><p><code>TLS</code> 握手中的 <code>Extension</code> 有以下几个特点:</p><ul><li><code>Extension</code> 不影响 <code>TLS</code> 握手的成功与否。<code>Server</code> 对 <code>ClientHello</code> 中的 <code>Extension</code> 有些不支持，忽略不处理即可，不影响握手的流程。</li><li><code>ServerHello</code> 中回应 <code>Client</code> 的 <code>Extension</code> 一定要是 <code>ClientHello</code> 中的 <code>Extension</code> 的子集(小于等于)。<code>ServerHello</code> 中禁止出现 <code>ClientHello</code> 中没有出现的 <code>Extension</code>。如果一个 <code>Client</code> 在 <code>ServerHello</code> 中收到一个扩展类型但在相关的 <code>ClientHello</code> 中并不存在，它必须用一个 <code>unsupported_extension</code> 致命 <code>alert</code> 消息来丢弃握手。</li><li>当 <code>ClientHello</code> 或 <code>ServerHello</code> 中有多个不同类型的扩展存在时，这些扩展可能会以任意顺序出现。不能出现重复相同的扩展。</li><li>所有的 <code>Extension</code> 都必须考虑会话恢复的情况，保证安全性。</li></ul><blockquote><p>&quot;面向 <code>Server</code>&quot;的扩展将来可以在 <code>TLS</code> 中提供。这样的一个扩展(比如, 类型 <code>X</code> 的扩展)可能要求 <code>Client</code> 首先发送一个类型 <code>X</code> 的扩展在 <code>ClientHello</code> 中，并且 <code>extension_data</code> 为空以表示它支持扩展类型。在这个例子中，<code>Client</code> 提供了理解扩展类型的能力，<code>Server</code> 基于 <code>Client</code> 提供的内容与其进行通信。</p></blockquote><hr><h2 id="tls-12握手extension"><a class="markdownIt-Anchor" href="#tls-12握手extension"></a> TLS 1.2握手extension</h2><p>在 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6066">【RFC 6066】</a> 中定义了很多 <code>Extension</code>，这些 <code>Extension</code> 在 <code>TLS 1.2</code> 中基本都在使用。</p><table><thead><tr><th style="text-align:left">扩展类型名称</th><th style="text-align:left">扩展类型编号</th><th style="text-align:left">TLS 1.3 中使用情况</th><th style="text-align:left">是否推荐</th><th style="text-align:left">RFC 文档出处</th></tr></thead><tbody><tr><td style="text-align:left"><code>server_name</code></td><td style="text-align:left">0</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 6066</code></td></tr><tr><td style="text-align:left"><code>max_fragment_length</code></td><td style="text-align:left">1</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 6066</code></td></tr><tr><td style="text-align:left"><code>client_certificate_url</code></td><td style="text-align:left">2</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 6066</code></td></tr><tr><td style="text-align:left"><code>trusted_ca_keys</code></td><td style="text-align:left">3</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 6066</code></td></tr><tr><td style="text-align:left"><code>truncated_hmac</code></td><td style="text-align:left">4</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 6066</code></td></tr><tr><td style="text-align:left"><code>status_request</code></td><td style="text-align:left">5</td><td style="text-align:left"><code>CH, CR, CT</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 6066</code></td></tr><tr><td style="text-align:left"><code>user_mapping</code></td><td style="text-align:left">6</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 4681</code></td></tr><tr><td style="text-align:left"><code>client_authz</code></td><td style="text-align:left">7</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 5878</code></td></tr><tr><td style="text-align:left"><code>server_authz</code></td><td style="text-align:left">8</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 5878</code></td></tr><tr><td style="text-align:left"><code>cert_type</code></td><td style="text-align:left">9</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 6091</code></td></tr><tr><td style="text-align:left"><code>supported_groups(renamed from &quot;elliptic_curves&quot;)</code></td><td style="text-align:left">10</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7919</code></td></tr><tr><td style="text-align:left"><code>ec_point_formats</code></td><td style="text-align:left">11</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8422</code></td></tr><tr><td style="text-align:left"><code>srp</code></td><td style="text-align:left">12</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 5054</code></td></tr><tr><td style="text-align:left"><code>signature_algorithms</code></td><td style="text-align:left">13</td><td style="text-align:left"><code>CH, CR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 5246</code></td></tr><tr><td style="text-align:left"><code>use_srtp</code></td><td style="text-align:left">14</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 5764</code></td></tr><tr><td style="text-align:left"><code>heartbeat</code></td><td style="text-align:left">15</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 6520</code></td></tr><tr><td style="text-align:left"><code>application_layer_protocol_negotiation</code></td><td style="text-align:left">16</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7301</code></td></tr><tr><td style="text-align:left"><code>status_request_v2</code></td><td style="text-align:left">17</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 6961</code></td></tr><tr><td style="text-align:left"><code>signed_certificate_timestamp</code></td><td style="text-align:left">18</td><td style="text-align:left"><code>CH, CR, CT</code></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC 6962</code></td></tr><tr><td style="text-align:left"><code>client_certificate_type</code></td><td style="text-align:left">19</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7250</code></td></tr><tr><td style="text-align:left"><code>server_certificate_type</code></td><td style="text-align:left">20</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7250</code></td></tr><tr><td style="text-align:left"><code>padding</code></td><td style="text-align:left">21</td><td style="text-align:left"><code>CH</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7685</code></td></tr><tr><td style="text-align:left"><code>encrypt_then_mac</code></td><td style="text-align:left">22</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7366</code></td></tr><tr><td style="text-align:left"><code>extended_master_secret</code></td><td style="text-align:left">23</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 7627</code></td></tr><tr><td style="text-align:left"><code>token_binding</code></td><td style="text-align:left">24</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8472</code></td></tr><tr><td style="text-align:left"><code>cached_info</code></td><td style="text-align:left">25</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>tls_lts</code></td><td style="text-align:left">26</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"><code>draft-gutmann-tls-lts</code></td></tr><tr><td style="text-align:left"><code>compress_certificate (TEMPORARY - registered 2018-05-23, expires 2019-05-23)</code></td><td style="text-align:left">27</td><td style="text-align:left"><code>CH, CR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>draft-ietf-tls-certificate-compression</code></td></tr><tr><td style="text-align:left"><code>record_size_limit</code></td><td style="text-align:left">28</td><td style="text-align:left"><code>CH, EE</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8449</code></td></tr><tr><td style="text-align:left"><code>pwd_protect</code></td><td style="text-align:left">29</td><td style="text-align:left"><code>CH</code></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC-harkins-tls-dragonfly-03</code></td></tr><tr><td style="text-align:left"><code>pwd_clear</code></td><td style="text-align:left">30</td><td style="text-align:left"><code>CH</code></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC-harkins-tls-dragonfly-03</code></td></tr><tr><td style="text-align:left"><code>password_salt</code></td><td style="text-align:left">31</td><td style="text-align:left"><code>CH, SH, HRR</code></td><td style="text-align:left">❌</td><td style="text-align:left"><code>RFC-harkins-tls-dragonfly-03</code></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">32</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">33</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">34</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>session_ticket (renamed from &quot;SessionTicket TLS&quot;)</code></td><td style="text-align:left">35</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 4507</code></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">36</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">37</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">38</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">39</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">40</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">52-65279</td><td style="text-align:left"></td><td style="text-align:left">❌</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>renegotiation_info</code></td><td style="text-align:left">65281</td><td style="text-align:left"></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 5746</code></td></tr></tbody></table><blockquote><p>缩写注解: <code>CH: ClientHello</code>，<code>SH: ServerHello</code>，<code>CR: CertificateRequest</code>，<code>EE:EncryptedExtensions</code>，<code>HRR: HelloRetryRequest</code>，<code>CT: Certificate</code></p></blockquote><p>上面这些 <code>Extension</code> 也有对应的 <code>ExtensionType</code>，这里只列举一些常用的 <code>ExtensionType</code>，并非所有:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    server_name(<span class="hljs-number">0</span>),<br>    max_fragment_length(<span class="hljs-number">1</span>),<br>    client_certificate_url(<span class="hljs-number">2</span>),<br>    trusted_ca_keys(<span class="hljs-number">3</span>),<br>    truncated_hmac(<span class="hljs-number">4</span>),<br>    status_request(<span class="hljs-number">5</span>),<br>    supported_groups(<span class="hljs-number">10</span>),<br>    ec_point_formats(<span class="hljs-number">11</span>),<br>    signature_algorithms(<span class="hljs-number">13</span>),<br>    application_layer_protocol_negotiation(<span class="hljs-number">16</span>),<br>    signed_certificate_timestamp(<span class="hljs-number">18</span>),<br>    extended_master_secret(<span class="hljs-number">23</span>),<br>    SessionTicket <span class="hljs-title function_">TLS</span><span class="hljs-params">(<span class="hljs-number">35</span>)</span>,<br>    <span class="hljs-title function_">renegotiation_info</span><span class="hljs-params">(<span class="hljs-number">65281</span>)</span><br>    <span class="hljs-params">(<span class="hljs-number">65535</span>)</span><br>&#125; ExtensionType;<br></code></pre></td></tr></table></figure><p>每个 <code>Extension</code> 的数据结构如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    ExtensionType extension_type;<br>    opaque extension_data&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; Extension;<br></code></pre></td></tr></table></figure><p><code>Extension</code> 是由 <code>extension_type</code> 和 <code>extension_data</code> 共同构成的。有些 <code>Extension</code> 是没有 <code>extension_data</code> 的。所以 <code>extension_type</code> 占 2 个字节，后面 <code>extension_data</code> 是 <code>&lt;0..2^16-1&gt;</code> 可变长度。</p><p>通常, 每个扩展类型的规范需要描述扩展对全部握手流程和会话恢复的影响。大多数当前的 <code>TLS</code> 扩展仅当一个会话被初始化时才相关联, 当一个旧的会话被恢复时，<code>Server</code> 不会处理 <code>Client Hello</code> 中的扩展，也不会将其包含在 <code>Server Hello</code> 中。然而, 一些扩展可以在会话恢复时指定不同的行为.</p><p>在这个协议的新特性与现存特性之间会有一些敏感(以及不很敏感)的交互产生, 这可能会导致整体安全性的显著降低。当设计新的扩展时应考虑下列事项:</p><ul><li><p>一些情况 <code>Server</code> 没有就一个扩展协商出一个一致结果，一些情况下则简单地拒绝支持特定特性。通常，错误警报应该用于前者，<code>Server</code> 扩展中的一个域用于响应后者。</p></li><li><p>扩展应该尽可能在设计上阻止任何通过操纵握手消息来强制使用(或不使用)一个特殊特性进行的攻击。无论这个特性是否被确认会导致安全问题，这个原则都应该被遵循。通常扩展域都会被包含在 <code>Finished</code> 消息的 <code>hash</code> 输入中，但需要给予极大关注的是在握手阶段扩展改变了发送消息的含义。设计者和实现者应该注意的事实是，握手被认证后，活动的攻击者才能修改消息并插入，移动或替换扩展。</p></li><li><p>使用扩展来改变 <code>TLS</code> 设计的主要方面在技术上是可能的；例如密码套件协商的设计。这种做法并不被推荐；更合适的做法是定义一个新版本的 <code>TLS</code> – 尤其是 <code>TLS</code> 握手算法有特定的保护方法以防御基于版本号的版本回退攻击，版本回退攻击的可能性应该在任何主要的修改设计中都是一个有意义的考量。</p></li></ul><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/tls_ext.png" srcset="/img/loading.gif" lazyload alt="tls_ext.png"></p><p>我们知道在 <code>ClientHello</code> 中，<code>Compression Methods</code> 字段之后就是 <code>Extension</code> 了，所以我们从 <code>Compression Methods</code> 字段之后逐一看起。</p><h3 id="1-server_name"><a class="markdownIt-Anchor" href="#1-server_name"></a> 1. Server_name</h3><p><code>server_name</code> 扩展比较简单，存储的就是 <code>Server</code> 的名字。<code>TLS</code> 没有为 <code>Client</code> 提供一种机制来告诉 <code>Server</code> 它正在建立链接的 <code>Server</code> 的名称。<code>Client</code> 可能希望提供此信息以促进与在单个底层网络地址处托管多个“虚拟”服务的 <code>Server</code> 的安全连接。</p><p>当 <code>Client</code> 连接 <code>HTTPS</code> 网站的时候，解析出 <code>IP</code> 地址以后，就能创建 <code>TLS</code> 连接，在握手完成之前，<code>Server</code> 接收到的消息中并没有 <code>host HTTP</code> 的头部。如果这个 <code>Server</code> 有多个虚拟的服务，每个服务都有一张证书，那么此时 <code>Server</code> 不知道该用哪一张证书。</p><p>于是为了解决这个问题，增加了 <code>SNI</code> 扩展。用这个扩展就能区别出各个服务对应的证书了。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_servername.png" srcset="/img/loading.gif" lazyload alt="ext_servername.png"></p><p>结构如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    NameType name_type;<br>    select (name_type) &#123;<br>        <span class="hljs-keyword">case</span> host_name: HostName;<br>    &#125; name;<br>&#125; ServerName;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    host_name(<span class="hljs-number">0</span>), (<span class="hljs-number">255</span>)<br>&#125; NameType;<br><br>opaque HostName&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    ServerName server_name_list&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;<br>&#125; ServerNameList;<br></code></pre></td></tr></table></figure><p>支持 <code>TLS 1.2</code> 的 <code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_server_name_resp.png" srcset="/img/loading.gif" lazyload alt="ext_server_name_resp.png"></p><p><code>TLS 1.3</code> 中也同样在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_server_name_resp_tls1_3.png" srcset="/img/loading.gif" lazyload alt="ext_server_name_resp_tls1_3.png"></p><p>返回的是一个空的扩展即可。</p><hr><h3 id="2-extended_master_secret"><a class="markdownIt-Anchor" href="#2-extended_master_secret"></a> 2. extended_master_secret</h3><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_extended_master_secret.png" srcset="/img/loading.gif" lazyload alt="ext_extended_master_secret.png"></p><p>这个 <code>Extension</code> 标识 <code>Client</code> 和 <code>Server</code> 使用增强型主密钥计算方式。</p><p><code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_extended_master_secret_resp.png" srcset="/img/loading.gif" lazyload alt="ext_extended_master_secret_resp.png"></p><p><code>Server</code> 返回了一个空的 <code>extended_master_secret</code> 扩展，表明会使用增强型主密钥计算方式。</p><hr><h3 id="3-renegotiation_info-重协商"><a class="markdownIt-Anchor" href="#3-renegotiation_info-重协商"></a> 3. renegotiation_info 重协商</h3><p>  在安全性要求比较高的场景中，如果 <code>Server</code> 发现当前加密算法不够安全，或者需要校验 <code>Client</code> 证书的时候，需要建立一个新的链接，这个时候就需要用到重协商。重协商的协议设计初衷是好的，但是由于 <code>2009</code> 年出现了一个针对重协商的漏洞 <code>CVE-2009-3555</code>，导致 <code>Server</code> 和 <code>Client</code> 发起的重协商都是不安全的。出现漏洞的原因是没有校验 <code>Client</code> 和 <code>Server</code> 的身份，因为双方没法判断重协商的链接是不是原有链接的对端。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_renegotiation_info.png" srcset="/img/loading.gif" lazyload alt="ext_renegotiation_info.png"></p><p>为了解决这个问题，所以在 <code>RFC 5746</code> 中增加了这个<code>Extension</code>，增加了这个 <code>Extension</code> 以后，重协商就安全了。</p><p>这个扩展的数据结构非常简单：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    opaque renegotiated_connection&lt;<span class="hljs-number">0.</span>.<span class="hljs-number">.255</span>&gt;;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_renegotiation_info_resp.png" srcset="/img/loading.gif" lazyload alt="ext_renegotiation_info_resp.png"></p><hr><h3 id="4-supported_groups"><a class="markdownIt-Anchor" href="#4-supported_groups"></a> 4. supported_groups</h3><p>这个扩展原名叫 “<code>elliptic_curves</code>”，后来更名成 “<code>supported_groups</code>”。从原名的意思就能看出来这个扩展的意义。它标识了 <code>Client</code> 支持的椭圆曲线的种类。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_supported_groups.png" srcset="/img/loading.gif" lazyload alt="ext_supported_groups.png"></p><p>这个例子中，<code>Client</code> 支持 4 种椭圆曲线，<code>x25519</code>、<code>secp256r1</code>、<code>secp384r1</code>、<code>secp521r1</code>。<code>Server</code> 接收到这个扩展会根据这些信息进行选择合适的椭圆曲线。</p><p><code>TLS 1.3</code> 中支持的所有曲线如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    unallocated_RESERVED(<span class="hljs-number">0x0000</span>),<br><br>    <span class="hljs-comment">/* Elliptic Curve Groups (ECDHE) */</span><br>    obsolete_RESERVED(<span class="hljs-number">0x0001</span>.<span class="hljs-number">.0</span>x0016),<br>    secp256r1(<span class="hljs-number">0x0017</span>), secp384r1(<span class="hljs-number">0x0018</span>), secp521r1(<span class="hljs-number">0x0019</span>),<br>    obsolete_RESERVED(<span class="hljs-number">0x001A</span>.<span class="hljs-number">.0</span>x001C),<br>    x25519(<span class="hljs-number">0x001D</span>), x448(<span class="hljs-number">0x001E</span>),<br><br>    <span class="hljs-comment">/* Finite Field Groups (DHE) */</span><br>    ffdhe2048(<span class="hljs-number">0x0100</span>), ffdhe3072(<span class="hljs-number">0x0101</span>), ffdhe4096(<span class="hljs-number">0x0102</span>),<br>    ffdhe6144(<span class="hljs-number">0x0103</span>), ffdhe8192(<span class="hljs-number">0x0104</span>),<br><br>    <span class="hljs-comment">/* Reserved Code Points */</span><br>    ffdhe_private_use(<span class="hljs-number">0x01FC</span>.<span class="hljs-number">.0</span>x01FF),<br>    ecdhe_private_use(<span class="hljs-number">0xFE00</span>.<span class="hljs-number">.0</span>xFEFF),<br>    obsolete_RESERVED(<span class="hljs-number">0xFF01</span>.<span class="hljs-number">.0</span>xFF02),<br>    (<span class="hljs-number">0xFFFF</span>)<br>&#125; NamedGroup;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    NamedGroup named_group_list&lt;<span class="hljs-number">2.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; NamedGroupList;<br></code></pre></td></tr></table></figure><p>标记了 “<code>obsolete_RESERVED</code>” 的曲线是在以前版本的 <code>TLS</code> 中使用过的，不得由 <code>TLS 1.3</code> 实现提供或协商。因为这些过时的曲线具有各种已知/理论上的弱点或者使用的非常少，它们不再被认为适合一般用途，应该被认为可能不安全。此处指定的曲线集足以与所有当前部署和正确配置的 <code>TLS</code> 实现进行互操作。</p><hr><h3 id="5-ec_point_formats"><a class="markdownIt-Anchor" href="#5-ec_point_formats"></a> 5. ec_point_formats</h3><p>这个扩展标识了是否能对椭圆曲线参数进行压缩。一般不启用压缩(<code>uncompressed</code>)。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_ec_point_formats.png" srcset="/img/loading.gif" lazyload alt="ext_ec_point_formats.png"></p><p><code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_ec_point_formats_resp.png" srcset="/img/loading.gif" lazyload alt="ext_ec_point_formats_resp.png"></p><hr><h3 id="6-sessionticket-tls"><a class="markdownIt-Anchor" href="#6-sessionticket-tls"></a> 6. SessionTicket TLS</h3><p>这个扩展表明了 <code>Client</code> 端是否有上次会话保存的 <code>SessionTicket</code>，如果有，则表明 <code>Client</code> 希望基于 <code>SessionTicket</code> 的方式进行会话恢复。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_sessionTicket.png" srcset="/img/loading.gif" lazyload alt="ext_sessionTicket.png"></p><p><code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_sessionTicket_resp.png" srcset="/img/loading.gif" lazyload alt="ext_sessionTicket_resp.png"></p><p><code>Server</code> 在 <code>SessionTicket TLS</code> 中返回一个空的扩展，在 <code>NewSessionTicket</code> 中发给 <code>Client</code> 新的 <code>session ticket</code>。</p><hr><h3 id="7-application_layer_protocol_negotiation"><a class="markdownIt-Anchor" href="#7-application_layer_protocol_negotiation"></a> 7. application_layer_protocol_negotiation</h3><p><code>Application Layer Protocol Negotiation</code>，<code>ALPN</code> 应用层协议扩展。由于应用层协议存在多个版本，<code>Client</code> 在 <code>TLS</code> 握手的时候想知道应用层用的什么协议。基于这个目的，<code>ALPN</code> 协议就出现了。<code>ALPN</code> 希望能协商出双方都支持的应用层协议，应用层底层还是基于 <code>TLS/SSL</code> 协议的。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_alpn.png" srcset="/img/loading.gif" lazyload alt="ext_alpn.png"></p><p>上图中显示 <code>Client</code> 希望协商 <code>HTTP/2</code> 协议。如果不能达成一致，那么接着协商 <code>HTTP/1.1</code>。除了 <code>HTTP</code> 这些协议以外，还有一些其他的应用层协议，见下表。</p><table><thead><tr><th style="text-align:left">应用层协议</th><th style="text-align:left">标识</th><th style="text-align:left">RFC文档出处</th></tr></thead><tbody><tr><td style="text-align:left"><code>HTTP/0.9</code></td><td style="text-align:left"><code>0x68 0x74 0x74 0x70 0x2f 0x30 0x2e 0x39 (&quot;http/0.9&quot;)</code></td><td style="text-align:left"><code>RFC 1945</code></td></tr><tr><td style="text-align:left"><code>HTTP/1.0</code></td><td style="text-align:left"><code>0x68 0x74 0x74 0x70 0x2f 0x31 0x2e 0x30 (&quot;http/1.0&quot;)</code></td><td style="text-align:left"><code>RFC 1945</code></td></tr><tr><td style="text-align:left"><code>HTTP/1.1</code></td><td style="text-align:left"><code>0x68 0x74 0x74 0x70 0x2f 0x31 0x2e 0x31 (&quot;http/1.1&quot;)</code></td><td style="text-align:left"><code>RFC 7230</code></td></tr><tr><td style="text-align:left"><code>SPDY/1</code></td><td style="text-align:left"><code>0x73 0x70 0x64 0x79 0x2f 0x31 (&quot;spdy/1&quot;)</code></td><td style="text-align:left"><a target="_blank" rel="noopener" href="http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft1">【SPDY Protocol - Draft 1】</a></td></tr><tr><td style="text-align:left"><code>SPDY/2</code></td><td style="text-align:left"><code>0x73 0x70 0x64 0x79 0x2f 0x32 (&quot;spdy/2&quot;)</code></td><td style="text-align:left"><a target="_blank" rel="noopener" href="http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft2">【SPDY Protocol - Draft 2】</a></td></tr><tr><td style="text-align:left"><code>SPDY/3</code></td><td style="text-align:left"><code>0x73 0x70 0x64 0x79 0x2f 0x33 (&quot;spdy/3&quot;)</code></td><td style="text-align:left"><a target="_blank" rel="noopener" href="http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3">【spdy-protocol-draft3】</a></td></tr><tr><td style="text-align:left"><code>Traversal Using Relays around NAT (TURN)</code></td><td style="text-align:left"><code>0x73 0x74 0x75 0x6E 0x2E 0x74 0x75 0x72 0x6E (&quot;stun.turn&quot;)</code></td><td style="text-align:left"><code>RFC 7443</code></td></tr><tr><td style="text-align:left"><code>NAT discovery using Session Traversal Utilities for NAT (STUN)</code></td><td style="text-align:left"><code>0x73 0x74 0x75 0x6E 0x2E 0x6e 0x61 0x74 0x2d 0x64 0x69 0x73 0x63 0x6f 0x76 0x65 0x72 0x79 (&quot;stun.nat-discovery&quot;)</code></td><td style="text-align:left"><code>RFC 7443</code></td></tr><tr><td style="text-align:left"><code>HTTP/2 over TLS</code></td><td style="text-align:left"><code>0x68 0x32 (&quot;h2&quot;)</code></td><td style="text-align:left"><code>RFC 7540</code></td></tr><tr><td style="text-align:left"><code>HTTP/2 over TCP</code></td><td style="text-align:left"><code>0x68 0x32 0x63 (&quot;h2c&quot;)</code></td><td style="text-align:left"><code>RFC 7540</code></td></tr><tr><td style="text-align:left"><code>WebRTC Media and Data</code></td><td style="text-align:left"><code>0x77 0x65 0x62 0x72 0x74 0x63 (&quot;webrtc&quot;)</code></td><td style="text-align:left"><code>RFC-ietf-rtcweb-alpn-04</code></td></tr><tr><td style="text-align:left"><code>Confidential WebRTC Media and Data</code></td><td style="text-align:left"><code>0x63 0x2d 0x77 0x65 0x62 0x72 0x74 0x63 (&quot;c-webrtc&quot;)</code></td><td style="text-align:left"><code>RFC-ietf-rtcweb-alpn-04</code></td></tr><tr><td style="text-align:left"><code>FTP</code></td><td style="text-align:left"><code>0x66 0x74 0x70 (&quot;ftp&quot;)</code></td><td style="text-align:left"><code>RFC 959</code> 、<code>RFC 4217</code></td></tr><tr><td style="text-align:left"><code>IMAP</code></td><td style="text-align:left"><code>0x69 0x6d 0x61 0x70 (&quot;imap&quot;)</code></td><td style="text-align:left"><code>RFC 2595</code></td></tr><tr><td style="text-align:left"><code>POP3</code></td><td style="text-align:left"><code>0x70 0x6f 0x70 0x33 (&quot;pop3&quot;)</code></td><td style="text-align:left"><code>RFC 2595</code></td></tr><tr><td style="text-align:left"><code>ManageSieve</code></td><td style="text-align:left"><code>0x6d 0x61 0x6e 0x61 0x67 0x65 0x73 0x69 0x65 0x76 0x65 (&quot;managesieve&quot;)</code></td><td style="text-align:left"><code>RFC 5804</code></td></tr><tr><td style="text-align:left"><code>CoAP</code></td><td style="text-align:left"><code>0x63 0x6f 0x61 0x70 (&quot;coap&quot;)</code></td><td style="text-align:left"><code>RFC 8323</code></td></tr><tr><td style="text-align:left"><code>XMPP jabber:client namespace</code></td><td style="text-align:left"><code>0x78 0x6d 0x70 0x70 0x2d 0x63 0x6c 0x69 0x65 0x6e 0x74 (&quot;xmpp-client&quot;)</code></td><td style="text-align:left"><a target="_blank" rel="noopener" href="https://xmpp.org/extensions/xep-0368.html">【XEP-0368: SRV records for XMPP over TLS】</a></td></tr><tr><td style="text-align:left"><code>XMPP jabber:server namespace</code></td><td style="text-align:left"><code>0x78 0x6d 0x70 0x70 0x2d 0x73 0x65 0x72 0x76 0x65 0x72 (&quot;xmpp-server&quot;)</code></td><td style="text-align:left"><a target="_blank" rel="noopener" href="https://xmpp.org/extensions/xep-0368.html">【XEP-0368: SRV records for XMPP over TLS】</a></td></tr></tbody></table><p>支持 <code>TLS 1.2</code> 的 <code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_alpn_resp.png" srcset="/img/loading.gif" lazyload alt="ext_alpn_resp.png"></p><p><code>TLS 1.3</code> 的情况一样，也在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_alpn_resp_tls1_3.png" srcset="/img/loading.gif" lazyload alt="ext_alpn_resp_tls1_3.png"></p><p>从这里例子中看到协商 <code>HTTP/2</code> 成功。</p><hr><h3 id="8-status_request"><a class="markdownIt-Anchor" href="#8-status_request"></a> 8. status_request</h3><p>当 <code>Client</code> 收到 <code>Server</code> 发来的证书以后，除了校验证书身份以外，还需要校验证书是否有效。有可能证书已经被 <code>CA</code> 刚刚吊销了。所以 <code>Client</code> 必须通过 <code>CRL</code> 和 <code>OCSP</code> 机制校验证书是否还在有效期之内。不管是 <code>CRL</code> 还是 <code>OCSP</code> 机制都会发送一个额外的请求去验证有效期，这个请求可能会阻塞握手下面的流程，为了避免阻塞，一般采用 <code>Server</code> 向 <code>CA</code> 发送 <code>OCSP</code> 请求。</p><p>为了使用 <code>OCSP</code> 封套技术，在 <code>ClientHello</code> 中增加 <code>status_request</code> 扩展，这个扩展内包含了证书状态的请求。</p><p>该扩展的 <code>extension_data</code> 中就包含了 <code>CertificateStatusRequest</code> 信息。对应的数据结构如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    CertificateStatusType status_type;<br>    select (status_type) &#123;<br>        <span class="hljs-keyword">case</span> ocsp: OCSPStatusRequest;<br>    &#125; request;<br>&#125; CertificateStatusRequest;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> ocsp(<span class="hljs-number">1</span>), (<span class="hljs-number">255</span>) &#125; CertificateStatusType;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    ResponderID responder_id_list&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>    Extensions  request_extensions;<br>&#125; OCSPStatusRequest;<br><br>opaque ResponderID&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>opaque Extensions&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br></code></pre></td></tr></table></figure><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_status_request.png" srcset="/img/loading.gif" lazyload alt="ext_status_request.png"></p><p><code>Sever</code> 收到此扩展以后，会发送 <code>CertificateStatus</code> 子消息，这条新增的子消息就是专门针对此扩展的。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    CertificateStatusType status_type;<br>    select (status_type) &#123;<br>        <span class="hljs-keyword">case</span> ocsp: OCSPResponse;<br>    &#125; response;<br>&#125; CertificateStatus;<br><br>opaque OCSPResponse&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">24</span><span class="hljs-number">-1</span>&gt;;<br></code></pre></td></tr></table></figure><p><code>OCSPResponse</code> 中包含了一个完整经过 <code>DER</code> 编码的 <code>OCSP</code> 封套响应。<code>CertificateStatus</code> 子消息也只能返回 <code>Server</code> 自己证书的 <code>OCSP</code> 信息。</p><p><code>Server</code> 在 <code>ServerHello</code> 中响应该扩展，返回如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_status_request_resp.png" srcset="/img/loading.gif" lazyload alt="ext_status_request_resp.png"></p><p><code>Server</code> 返回了一个空的 <code>status_request</code> 扩展。支持 <code>TLS 1.2</code> 的 <code>Server</code> 返回的 <code>CertificateStatus</code> 子消息内容如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_status_request_resp_support.png" srcset="/img/loading.gif" lazyload alt="ext_status_request_resp_support.png"></p><p>而在支持 <code>TLS 1.3</code> 的 <code>Server</code> 是在 <code>Certificate</code> 子消息中响应该扩展:</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_status_request_resp_support_tls1_3.png" srcset="/img/loading.gif" lazyload alt="ext_status_request_resp_support_tls1_3.png"></p><hr><h3 id="9-signature_algorithms"><a class="markdownIt-Anchor" href="#9-signature_algorithms"></a> 9. signature_algorithms</h3><p><code>Client</code> 使用 “<code>signature_algorithms</code>” 扩展来向 <code>Server</code> 表明哪个签名/ <code>hash</code> 算法对会被用于数字签名。这个扩展的 “<code>extension_data</code>” 域包含了一个 “<code>supported_signature_algorithms</code>” 值。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    none(<span class="hljs-number">0</span>), md5(<span class="hljs-number">1</span>), sha1(<span class="hljs-number">2</span>), sha224(<span class="hljs-number">3</span>), sha256(<span class="hljs-number">4</span>), sha384(<span class="hljs-number">5</span>),<br>    sha512(<span class="hljs-number">6</span>), (<span class="hljs-number">255</span>)<br>&#125; HashAlgorithm;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> anonymous(<span class="hljs-number">0</span>), rsa(<span class="hljs-number">1</span>), dsa(<span class="hljs-number">2</span>), ecdsa(<span class="hljs-number">3</span>), (<span class="hljs-number">255</span>) &#125;<br>  SignatureAlgorithm;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>      HashAlgorithm hash;<br>      SignatureAlgorithm signature;<br>&#125; SignatureAndHashAlgorithm;<br><br>SignatureAndHashAlgorithm<br>  supported_signature_algorithms&lt;<span class="hljs-number">2.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-2</span>&gt;;<br></code></pre></td></tr></table></figure><p>每个 <code>SignatureAndHashAlgorithm</code> 值都列出了一个 <code>Client</code> 愿意使用的 <code>hash</code>/签名对。这些值根据倾向使用的程度按降序排列。</p><p>注: 由于并不是所有的签名算法和 <code>hash</code> 算法都会被一个实现方所接受(例如: <code>DSA</code> 接受 <code>SHA-1</code>, 不接受 <code>SHA-256</code>), 所有算法是成对列出。</p><ul><li><p><code>hash</code>: 这个字段表明可能使用的 <code>hash</code> 算法。这些值分别表明支持无 <code>hash</code>, <code>MD5</code>, <code>SHA-1</code>, <code>SHA-224</code>, <code>SHA-256</code>, <code>SHA-384</code>, 和 <code>SHA-512</code>。“<code>none</code>” 值用于将来的可扩展性, 以防止一个签名算法在签名之前不需要 <code>hash</code>。</p></li><li><p><code>signature</code>: 这个字段表明使用哪个签名算法。这些值分别表示匿名签名, <code>RSASSA-PKCS1-v1_5</code>, <code>DSA</code> 和<code>ECDSA</code>。“<code>anonymous</code>” 值在这个上下文中是无意义的，它不能出现在这个扩展之中。</p></li></ul><p>这个扩展的语义某种程度上有些复杂, 因为密码套件表明允许的签名算法而不是 <code>hash</code>算法。</p><p>如果 <code>Client</code> 只支持默认的 <code>hash</code> 和签名算法(本节中所列出的)，它可以忽略 <code>signature_algorithms</code> 扩展。如果 <code>Client</code> 不支持默认的算法，或支持其它的 <code>hash</code> 和签名算法(并且它愿意使用他们来验证 <code>Server</code> 发送的消息，如: <code>server certificates</code> 和 <code>server key exchange</code>)，它必须发送 <code>signature_algorithms</code> 扩展，列出它愿意接受的算法。</p><p>如果 <code>Client</code> 不发送 <code>signature_algorithms</code> 扩展，<code>Server</code> 必须执行如下动作:</p><ul><li><p>如果协商后的密钥交换算法是(<code>RSA</code>、<code>DHE_RSA</code>、<code>DH_RSA</code>、<code>RSA_PSK</code>、<code>ECDH_RSA</code>、<code>ECDHE_RSA</code>)中的一个，处理行为同 <code>Client</code> 发送了 <code>&#123;sha1,rsa&#125;</code>；</p></li><li><p>如果协商后的密钥交换算法是(<code>DHE_DSS</code>、<code>DH_DSS</code>)中的一个, 处理行为同 <code>Client</code> 发送了<code>&#123;sha1,dsa&#125;</code>。</p></li><li><p>如果协商后的密钥交换算法是(<code>ECDH_ECDSA</code>,<code>ECDHE_ECDSA</code>)中的一个, 处理行为同 <code>Client</code> 发送了<code>&#123;sha1,ecdsa&#125;</code>。</p></li></ul><p>注:</p><ul><li><p>这个对于 <code>TLS 1.1</code> 是一个变更，且没有显式的规则，但在实现上可以假定对端支持 <code>MD5</code> 和 <code>SHA-1</code>。</p></li><li><p>这个扩展对早于 <code>1.2</code> 版本的 <code>TLS</code> 是没有意义的，对于之前的版本 <code>Client</code> 不能这个扩展。然而，即使 <code>Client</code> 提供了这个扩展，<code>[TLSEXT]</code> 中明确的规则要求 <code>Server</code> 如果不能理解扩展则忽略之。</p></li><li><p><code>Server</code> 不能发送此扩展，<code>TLS Server</code> 必须支持接收此扩展。</p></li></ul><p>当进行会话恢复时，这个扩展不能被包含在 <code>Server Hello</code> 中, 且 <code>Server</code> 会忽略 <code>Client Hello</code> 中的这个扩展(如果有)。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_signature_algorithms.png" srcset="/img/loading.gif" lazyload alt="ext_signature_algorithms.png"></p><hr><h2 id="tls-13-握手中的-extension"><a class="markdownIt-Anchor" href="#tls-13-握手中的-extension"></a> TLS 1.3 握手中的 extension</h2><p>在 <code>TLS 1.3</code> <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8446">RFC 8446</a> 规范中定义了很多 <code>Extension</code>，以下这些 <code>Extension</code> 在 <code>TLS 1.3</code> 中基本都在使用。加上上一章节表格中的 <code>Extension</code>，就是当前最全的 <code>Extension</code> 了。</p><table><thead><tr><th style="text-align:left">扩展类型名称</th><th style="text-align:left">扩展类型编号</th><th style="text-align:left">TLS 1.3 中使用情况</th><th style="text-align:left">是否推荐</th><th style="text-align:left">RFC 文档出处</th></tr></thead><tbody><tr><td style="text-align:left"><code>pre_shared_key</code></td><td style="text-align:left">41</td><td style="text-align:left"><code>CH, SH</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>early_data</code></td><td style="text-align:left">42</td><td style="text-align:left"><code>CH, EE, NST</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>supported_versions</code></td><td style="text-align:left">43</td><td style="text-align:left"><code>CH, SH, HRR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>cookie</code></td><td style="text-align:left">44</td><td style="text-align:left"><code>CH, HRR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>psk_key_exchange_modes</code></td><td style="text-align:left">45</td><td style="text-align:left"><code>CH</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">46</td><td style="text-align:left">❌</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>certificate_authorities</code></td><td style="text-align:left">47</td><td style="text-align:left"><code>CH, CR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>oid_filters</code></td><td style="text-align:left">48</td><td style="text-align:left"><code>CR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>post_handshake_auth</code></td><td style="text-align:left">49</td><td style="text-align:left"><code>CH</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>signature_algorithms_cert</code></td><td style="text-align:left">50</td><td style="text-align:left"><code>CH, CR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>key_share</code></td><td style="text-align:left">51</td><td style="text-align:left"><code>CH, SH, HRR</code></td><td style="text-align:left">✅</td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>Unassigned</code></td><td style="text-align:left">52-65279</td><td style="text-align:left">❌</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><code>Reserved for Private Use</code></td><td style="text-align:left">65280</td><td style="text-align:left"></td><td style="text-align:left"></td><td style="text-align:left"><code>RFC 8446</code></td></tr><tr><td style="text-align:left"><code>Reserved for Private Use</code></td><td style="text-align:left">65282-65535</td><td style="text-align:left"></td><td style="text-align:left"></td><td style="text-align:left"><code>RFC 8446</code></td></tr></tbody></table><blockquote><p>缩写注解: <code>CH: ClientHello</code>，<code>SH: ServerHello</code>，<code>CR: CertificateRequest</code>，<code>EE:EncryptedExtensions</code>，<code>HRR: HelloRetryRequest</code>，<code>CT: Certificate</code>，<code>NST: NewSessionTicket</code></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    server_name(<span class="hljs-number">0</span>),                             <span class="hljs-comment">/* RFC 6066 */</span><br>    max_fragment_length(<span class="hljs-number">1</span>),                     <span class="hljs-comment">/* RFC 6066 */</span><br>    status_request(<span class="hljs-number">5</span>),                          <span class="hljs-comment">/* RFC 6066 */</span><br>    supported_groups(<span class="hljs-number">10</span>),                       <span class="hljs-comment">/* RFC 8422, 7919 */</span><br>    signature_algorithms(<span class="hljs-number">13</span>),                   <span class="hljs-comment">/* RFC 8446 */</span><br>    use_srtp(<span class="hljs-number">14</span>),                               <span class="hljs-comment">/* RFC 5764 */</span><br>    heartbeat(<span class="hljs-number">15</span>),                              <span class="hljs-comment">/* RFC 6520 */</span><br>    application_layer_protocol_negotiation(<span class="hljs-number">16</span>), <span class="hljs-comment">/* RFC 7301 */</span><br>    signed_certificate_timestamp(<span class="hljs-number">18</span>),           <span class="hljs-comment">/* RFC 6962 */</span><br>    client_certificate_type(<span class="hljs-number">19</span>),                <span class="hljs-comment">/* RFC 7250 */</span><br>    server_certificate_type(<span class="hljs-number">20</span>),                <span class="hljs-comment">/* RFC 7250 */</span><br>    padding(<span class="hljs-number">21</span>),                                <span class="hljs-comment">/* RFC 7685 */</span><br>    RESERVED(<span class="hljs-number">40</span>),                               <span class="hljs-comment">/* Used but never</span><br><span class="hljs-comment">                                                   assigned */</span><br>    pre_shared_key(<span class="hljs-number">41</span>),                         <span class="hljs-comment">/* RFC 8446 */</span><br>    early_data(<span class="hljs-number">42</span>),                             <span class="hljs-comment">/* RFC 8446 */</span><br>    supported_versions(<span class="hljs-number">43</span>),                     <span class="hljs-comment">/* RFC 8446 */</span><br>    cookie(<span class="hljs-number">44</span>),                                 <span class="hljs-comment">/* RFC 8446 */</span><br>    psk_key_exchange_modes(<span class="hljs-number">45</span>),                 <span class="hljs-comment">/* RFC 8446 */</span><br>    RESERVED(<span class="hljs-number">46</span>),                               <span class="hljs-comment">/* Used but never</span><br><span class="hljs-comment">                                                   assigned */</span><br>    certificate_authorities(<span class="hljs-number">47</span>),                <span class="hljs-comment">/* RFC 8446 */</span><br>    oid_filters(<span class="hljs-number">48</span>),                            <span class="hljs-comment">/* RFC 8446 */</span><br>    post_handshake_auth(<span class="hljs-number">49</span>),                    <span class="hljs-comment">/* RFC 8446 */</span><br>    signature_algorithms_cert(<span class="hljs-number">50</span>),              <span class="hljs-comment">/* RFC 8446 */</span><br>    key_share(<span class="hljs-number">51</span>),                              <span class="hljs-comment">/* RFC 8446 */</span><br>    (<span class="hljs-number">65535</span>)<br>&#125; ExtensionType;<br></code></pre></td></tr></table></figure><p>在 <code>TLS 1.3</code> 中，相比 <code>TLS 1.2</code> 增加了大量的扩展，当然上一章提到的 <code>TLS 1.2</code> 的扩展也会继续使用。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c">+--------------------------------------------------+-------------+<br>| Extension                                        |     TLS <span class="hljs-number">1.3</span> |<br>+--------------------------------------------------+-------------+<br>| server_name [RFC6066]                            |      CH, EE |<br>|                                                  |             |<br>| max_fragment_length [RFC6066]                    |      CH, EE |<br>|                                                  |             |<br>| status_request [RFC6066]                         |  CH, CR, CT |<br>|                                                  |             |<br>| supported_groups [RFC7919]                       |      CH, EE |<br>|                                                  |             |<br>| signature_algorithms (RFC <span class="hljs-number">8446</span>)                  |      CH, CR |<br>|                                                  |             |<br>| use_srtp [RFC5764]                               |      CH, EE |<br>|                                                  |             |<br>| heartbeat [RFC6520]                              |      CH, EE |<br>|                                                  |             |<br>| application_layer_protocol_negotiation [RFC7301] |      CH, EE |<br>|                                                  |             |<br>| signed_certificate_timestamp [RFC6962]           |  CH, CR, CT |<br>|                                                  |             |<br>| client_certificate_type [RFC7250]                |      CH, EE |<br>|                                                  |             |<br>| server_certificate_type [RFC7250]                |      CH, EE |<br>|                                                  |             |<br>| padding [RFC7685]                                |          CH |<br>|                                                  |             |<br>| key_share (RFC <span class="hljs-number">8446</span>)                             | CH, SH, HRR |<br>|                                                  |             |<br>| pre_shared_key (RFC <span class="hljs-number">8446</span>)                        |      CH, SH |<br>|                                                  |             |<br>| psk_key_exchange_modes (RFC <span class="hljs-number">8446</span>)                |          CH |<br>|                                                  |             |<br>| early_data (RFC <span class="hljs-number">8446</span>)                            | CH, EE, NST |<br>|                                                  |             |<br>| cookie (RFC <span class="hljs-number">8446</span>)                                |     CH, HRR |<br>|                                                  |             |<br>| supported_versions (RFC <span class="hljs-number">8446</span>)                    | CH, SH, HRR |<br>|                                                  |             |<br>| certificate_authorities (RFC <span class="hljs-number">8446</span>)               |      CH, CR |<br>|                                                  |             |<br>| oid_filters (RFC <span class="hljs-number">8446</span>)                           |          CR |<br>|                                                  |             |<br>| post_handshake_auth (RFC <span class="hljs-number">8446</span>)                   |          CH |<br>|                                                  |             |<br>| signature_algorithms_cert (RFC <span class="hljs-number">8446</span>)             |      CH, CR |<br>+--------------------------------------------------+-------------+<br></code></pre></td></tr></table></figure><p>在 <code>TLS 1.3</code> 中，扩展通常以请求/响应方式构建，虽然有些扩展只是一些标识，并不会有任何响应。<code>Client</code> 只能在 <code>ClientHello</code> 中发送其扩展请求，<code>Server</code> 只能在 <code>ServerHello</code>, <code>EncryptedExtensions</code>, <code>HelloRetryRequest</code>,和 <code>Certificate</code> 消息中发送对应的扩展响应。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_all_1.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_all_1.png"></p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_all_2.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_all_2.png"></p><p>上面 2 张图是 <code>TLS 1.3</code> 中 <code>ClientHello</code> 中的所有扩展。到 <code>signature_algorithms</code> 为止，上面的扩展都在 <code>TLS 1.2</code> 扩展中讲解了。这里就不再赘述了，只是放一下 <code>Wireshake</code> 的截图展示一下。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_all_1_info.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_all_1_info.png"></p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_all_2_info.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_all_2_info.png"></p><hr><h3 id="1-signed_certificate_timestamp"><a class="markdownIt-Anchor" href="#1-signed_certificate_timestamp"></a> 1. signed_certificate_timestamp</h3><p>这个扩展在 <code>TLS 1.2</code> 中就有了，之所以放在这里，只是因为在 <code>TLS 1.3</code> 的抓包中出现了，在 <code>TLS 1.2</code> 的抓包中没有出现。</p><p>这个扩展与证书透明度有关系，每一张 <code>Server</code> 实体证书都可以由 <code>CA</code> 机构或者 <code>Server</code> 实体提交给 <code>CT</code> 日志服务器从而获得证书的 <code>SCT</code> 信息。</p><p><code>HTTPS</code> 网站的安全性很大一部分取决于 <code>PKI</code> 设施的可信赖性。<code>CA</code> 如果因为失误导致错误签发了证书，这些错误的证书都能通过证书链的校验，所以这些证书很难被发现，即使被发现，也很难快速消除影响。</p><p><code>Certificate Transparency</code> 证书透明度就是为了解决这些问题的，由 <code>Google</code> 主导，并由 <code>IETF</code> 标准化为 <code>RFC 6962</code>。<code>Certificate Transparency</code> 的目标是提供一个开放的审计和监控系统，可以让任何域名所有者或者 <code>CA</code> 确定证书是否被错误签发或者被恶意使用，从而提高 <code>HTTPS</code> 网站的安全性。</p><p><code>Certificate Transparency</code> 整套系统由三部分组成：<br>1）<code>Certificate Logs</code>；<br>2）<code>Certificate Monitors</code>；<br>3）<code>Certificate Auditors</code>。<br>完整的工作原理可以看官方文档：<code>How Certificate Transparency Works</code></p><p>简单说来，证书所有者或者 <code>CA</code> 都可以主动向 <code>Certificate Logs</code> 服务器提交证书，所有证书记录都会接受审计和监控。支持 <code>CT</code> 的浏览器（目前只有 <code>Chrome</code>）会根据 <code>Certificate Logs</code> 中证书状态，作出不同的反应。<code>CT</code> 不是要替换现有的 <code>CA</code> 设施，而是做为补充，使之更透明、更实时。</p><p><code>Certificate Logs</code> 服务器由 <code>Google</code> 或 <code>CA</code> 部署，这个页面列举了目前已知的服务器。合法的证书提交到 <code>CT Logs</code> 服务器之后，服务器会返回 <code>signed certificate timestamp（SCT）</code>，要启用 <code>CT</code> 就必须用到 <code>SCT</code> 信息。</p><p>开启证书透明度有 3 种方法：</p><ul><li>通过 <code>X.509v3</code> 扩展</li><li>通过 <code>TLS</code> 的 <code>signed_certificate_timestamp</code> 扩展</li><li>通过 <code>OCSP Stapling</code></li></ul><p>这里的方法 2 就是这里所说的扩展。<code>SCT</code> 信息可以通过 <code>X.509v3</code> 扩展嵌入在证书里，方法 1 是以后的趋势。<code>Letsencrypt</code> 已经默认在证书中嵌入了 <code>CT</code> 信息。笔者的博客证书就是由 <code>Letsencrypt</code> 签发的，所以证书中也嵌入了 <code>CT</code> 信息了。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_signed_certificate_timestamp.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_signed_certificate_timestamp.png"></p><hr><h3 id="2-key_share"><a class="markdownIt-Anchor" href="#2-key_share"></a> 2. key_share</h3><p>在 <code>TLS 1.3</code> 中，之所以能比 <code>TLS 1.2</code> 快的原因，原因之一就在 <code>key_share</code> 这个扩展上。<code>key_share</code> 扩展内包含了 <code>(EC)DHE groups</code> 需要协商密钥参数，这样不需要再次花费 <code>1-RTT</code> 进行协商了。</p><p>“<code>supported_groups</code>” 的扩展 和 “<code>key_share</code>” 扩展配合使用。“<code>supported_groups</code>” 这个扩展表明了 <code>Client</code> 支持的 <code>(EC)DHE groups</code>，“<code>key_share</code>” 扩展表明了 <code>Client</code> 是否包含了一些或者全部的<code>（EC）DHE</code>共享参数。</p><p><code>KeyShareEntry</code> 数据结构如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    NamedGroup group;<br>    opaque key_exchange&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; KeyShareEntry;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    KeyShareEntry client_shares&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; KeyShareClientHello;<br></code></pre></td></tr></table></figure><p>如果 <code>Server</code> 选择了 <code>(EC)DHE</code> 组，并且 <code>Client</code> 在 <code>ClientHello</code> 中没有提供合适的 “<code>key_share</code>” 扩展， <code>Server</code> 必须用 <code>HelloRetryRequest</code> 消息作为回应。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    NamedGroup selected_group;<br>&#125; KeyShareHelloRetryRequest;<br></code></pre></td></tr></table></figure><p>如果 <code>ClientHello</code> 提供了合适的 “<code>key_share</code>” 扩展，那么在 <code>Serverhello</code> 中回应 <code>Server</code> 的参数。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    KeyShareEntry server_share;<br>&#125; KeyShareServerHello;<br></code></pre></td></tr></table></figure><p>整个流程见下图:</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_key_share_1.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_key_share_1.png"></p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_key_share_2.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_key_share_2.png"></p><p>上面 2 张图就展示了 <code>Server</code> 和 <code>Client</code> 是如何协商各自的密钥参数的。</p><blockquote><p>这个扩展在 <code>TLS 1.3</code> 中非常关键，<code>TLS 1.3</code> 官方也对它进行了大篇幅的说明，见 <a target="_blank" rel="noopener" href="https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/TLS_1.3_Handshake_Protocol.md#8-key-share">【这篇文章】</a></p></blockquote><hr><h3 id="3-psk_key_exchange_modes"><a class="markdownIt-Anchor" href="#3-psk_key_exchange_modes"></a> 3. psk_key_exchange_modes</h3><p>为了使用 <code>PSK</code>，<code>Client</code> 还必须发送一个 “<code>psk_key_exchange_modes</code>” 扩展。这个扩展语意是 <code>Client</code> 仅支持使用具有这些模式的 <code>PSK</code>。这就限制了在这个 <code>ClientHello</code> 中提供的 <code>PSK</code> 的使用，也限制了 <code>Server</code> 通过 <code>NewSessionTicket</code> 提供的 <code>PSK</code> 的使用。</p><p>如果 <code>Client</code> 提供了 “<code>pre_shared_key</code>” 扩展，那么它必须也要提供 “<code>psk_key_exchange_modes</code>” 扩展。如果 <code>Client</code> 发送不带 “<code>psk_key_exchange_modes</code>” 扩展名的 “<code>pre_shared_key</code>”，<code>Server</code> 必须立即中止握手。<code>Server</code> 不能选择一个 <code>Client</code> 没有列出的密钥交换模式。此扩展还限制了与 <code>PSK</code> 恢复使用的模式。<code>Server</code> 也不能发送与建议的 <code>modes</code> 不兼容的 <code>NewSessionTicket</code>。不过如果 <code>Server</code> 一定要这样做，影响的只是 <code>Client</code> 在尝试恢复会话的时候会失败。</p><p><code>Server</code> 不能发送 “<code>psk_key_exchange_modes</code>” 扩展:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> psk_ke(<span class="hljs-number">0</span>), psk_dhe_ke(<span class="hljs-number">1</span>), (<span class="hljs-number">255</span>) &#125; PskKeyExchangeMode;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    PskKeyExchangeMode ke_modes&lt;<span class="hljs-number">1.</span><span class="hljs-number">.255</span>&gt;;<br>&#125; PskKeyExchangeModes;<br></code></pre></td></tr></table></figure><ul><li><code>psk_ke</code>: 仅 <code>PSK</code> 密钥建立。在这种模式下，<code>Server</code> 不能提供 “<code>key_share</code>” 值。</li><li><code>psk_dhe_ke</code>: <code>PSK</code> 和 <code>(EC)DHE</code> 建立。在这种模式下，<code>Client</code> 和 <code>Server</code> 必须提供 “<code>key_share</code>” 值。</li></ul><p>未来分配的任何值都必须要能保证传输的协议消息可以明确的标识 <code>Server</code> 选择的模式。目前 <code>Server</code> 选择的值由 <code>ServerHello</code> 中存在的 “<code>key_share</code>” 表示。</p><p><code>ClientHello</code> 中包含此扩展的消息如下：</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_psk_key_exchange_modes.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_psk_key_exchange_modes.png"></p><hr><h3 id="4-supported_versions"><a class="markdownIt-Anchor" href="#4-supported_versions"></a> 4. supported_versions</h3><p>在 <code>TLS 1.3</code> 中，<code>ClientHello</code> 中的 <code>supported_versions</code> 扩展非常重要。因为 <code>TLS 1.3</code> 是根据这个字段的值来协商是否支持 <code>TLS 1.3</code> 。在 <code>TLS 1.3</code> 规范中规定，<code>ClientHello</code> 中的 <code>legacy_version</code> 必须设置为 <code>0x0303</code>，这个值代表的是 <code>TLS 1.2</code> 。这样规定是为了对网络中间件做的一些兼容。如果此时 <code>ClientHello</code> 中不携带 <code>supported_versions</code> 这个扩展，那么注定只能协商 <code>TLS 1.2</code> 了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    select (Handshake.msg_type) &#123;<br>        <span class="hljs-keyword">case</span> client_hello:<br>             ProtocolVersion versions&lt;<span class="hljs-number">2.</span><span class="hljs-number">.254</span>&gt;;<br><br>        <span class="hljs-keyword">case</span> server_hello: <span class="hljs-comment">/* and HelloRetryRequest */</span><br>             ProtocolVersion selected_version;<br>    &#125;;<br>&#125; SupportedVersions;<br></code></pre></td></tr></table></figure><p><code>Client</code> 在 <code>ClientHello</code> 的 <code>supported_versions</code> 扩展中发送自己所能支持的 <code>TLS</code> 版本。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_supported_versions.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_supported_versions.png"></p><p><code>Server</code> 收到以后，在 <code>ServerHello</code> 中的 <code>supported_versions</code> 扩展响应 <code>Client</code>，告诉 <code>Client</code> 接下来进行哪个 <code>TLS</code> 版本的握手。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_supported_versions_1.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_supported_versions_1.png"></p><p>上面这个例子说明了接下来会进行 <code>TLS 1.3</code> 的握手。哪怕 <code>ClientHello</code> 和 <code>ServerHello</code> 中 <code>version</code> 都是 <code>TLS 1.2</code> 。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_supported_versions_2.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_supported_versions_2.png"></p><hr><h3 id="5-early_data"><a class="markdownIt-Anchor" href="#5-early_data"></a> 5. early_data</h3><p>当使用 <code>PSK</code> 并且 <code>PSK</code> 允许使用 <code>early_data</code> 的时候，<code>Client</code> 可以在其第一个消息中发送应用数据。如果 <code>Client</code> 选择这么做，则必须发送 “<code>pre_shared_key</code>” 和 “<code>early_data</code>” 扩展。</p><p><code>Early Data Indication</code> 扩展中的 “<code>extension_data</code>” 字段包含了一个 <code>EarlyDataIndication</code> 值。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>&#125; Empty;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    select (Handshake.msg_type) &#123;<br>        <span class="hljs-keyword">case</span> new_session_ticket:   uint32 max_early_data_size;<br>        <span class="hljs-keyword">case</span> client_hello:         Empty;<br>        <span class="hljs-keyword">case</span> encrypted_extensions: Empty;<br>    &#125;;<br>&#125; EarlyDataIndication;<br></code></pre></td></tr></table></figure><p>有关 <code>max_early_data_size</code> 字段的使用请看 <a target="_blank" rel="noopener" href="https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/TLS_1.3_Handshake_Protocol.md#1-new-session-ticket-message">【New Session Ticket Message】</a> 章节。</p><p><code>0-RTT</code> 数据(版本，对称加密套件，应用层协议协商协议<code>[RFC7301]</code>，等等)的参数与使用中的 <code>PSK</code> 参数相关。对于外部配置的 <code>PSK</code>，关联值是由密钥提供的。对于通过 <code>NewSessionTicket</code> 消息建立的 <code>PSK</code>，关联值是在建立 <code>PSK</code> 连接时协商的值。<code>PSK</code> 用来加密 <code>early data</code> 必须是 <code>Client</code> 在 “<code>pre_shared_key</code>” 扩展中列出的第一个 <code>PSK</code>。</p><p>对于通过 <code>NewSessionTicket</code> 提供的 <code>PSK</code>，<code>Server</code> 必须验证所选 <code>PSK</code> 标识中的 <code>ticket age</code>(从 <code>PskIdentity.obfuscated_ticket_age</code> 取 <code>2^32</code> 模中减去 <code>ticket_age_add</code>)距离 <code>ticket</code> 发出的时间是否有一个很小的公差。如果相差的时间很多，那么 <code>Server</code> 应该继续握手，但是要拒绝 <code>0-RTT</code>，并且还要假定这条 <code>ClientHello</code> 是新的，也不能采取任何其他措施。</p><p>在第一次 <code>flight</code> 中发送的 <code>0-RTT</code> 消息与其他 <code>flight</code> (握手和应用数据)中发送的相同类型的消息具有相同(加密)的内容类型，但受到不同密钥的保护。如果 <code>Server</code> 已经接收了 <code>early data</code>，<code>Client</code> 在收到 <code>Server</code> 的 <code>Finished</code> 消息以后，<code>Client</code> 则会发送 <code>EndOfEarlyData</code> 消息表示密钥更改。这条消息将会使用 <code>0-RTT</code> 的 <code>traffic</code> 密钥进行加密。</p><p><code>Server</code> 接收 “<code>early_data</code>” 扩展必须以下面三种方式之一操作：</p><ul><li><p>忽略 “<code>early_data</code>” 扩展，并返回常规的 <code>1-RTT</code> 响应。<code>Server</code> 尝试通过用握手中的流量密钥(<code>traffic key</code>)解密收到的记录，并忽略掉 <code>early data</code>。丢弃解密失败的记录(取决于配置的 <code>max_early_data_size</code>)。一旦一个记录被解密成功，它将会被 <code>Server</code> 看做 <code>Client</code> 第二次 <code>flight</code> 的开始并且 <code>Server</code> 会把它当做普通的 <code>1-RTT</code> 来处理。</p></li><li><p>通过回应 <code>HelloRetryRequest</code> 来请求 <code>Client</code> 发送另外一个 <code>ClientHello</code>。<code>Client</code> 不能在这个 <code>ClientHello</code> 中包含 “<code>early_data</code>” 扩展。<code>Server</code> 通过跳过具有外部内容类型的 “<code>application_data</code>”(说明他们被加密了) 的所有记录来忽略 <code>early data</code>(同样取决于配置的 <code>max_early_data_size</code>)。</p></li><li><p>在 <code>EncryptedExtensions</code> 中返回自己的 “<code>early_data</code>” 扩展，表明它准备处理 <code>early data</code>。<code>Server</code> 不可能只接受 <code>early data</code> 消息中的一部分。即使 <code>Server</code> 发送了一条接收 <code>early data</code> 的消息，但是实际上 <code>early data</code> 可能在 <code>Server</code> 生成这条消息的时候已经在 <code>flight</code> 了。</p></li></ul><p>为了接受 <code>early data</code>，<code>Server</code> 必须已经接受了 <code>PSK</code> 密码套件并且选择了 <code>Client</code> 的 “<code>pre_shared_key</code>” 扩展中提供的第一个密钥。此外，<code>Server</code> 还需要验证以下的值和选择的 <code>PSK</code> 关联值一样：</p><ul><li><code>TLS</code> 版本号</li><li>选择的密码套件</li><li>选择的 <code>ALPN</code> 协议，如果选择了的话</li></ul><p>这些要求是使用相关 <code>PSK</code> 执行 <code>1-RTT</code>握手所需的超集。对于外部建立的 <code>PSK</code>，关联值是与密钥一起提供的值。对于通过 <code>NewSessionTicket</code> 消息建立的 <code>PSK</code>，关联值是在连接中协商的值，在这期间 <code>ticket</code> 被建立了。</p><p>如果任何检查失败了，<code>Server</code> 不得在响应中附带扩展，并且必须使用上面列出的前两种机制中的一个，丢弃所有 <code>first-flight</code> 数据(因此回落到 <code>1-RTT</code> 或者 <code>2-RTT</code>)。如果 <code>Client</code> 尝试 <code>0-RTT</code> 握手但 <code>Server</code> 拒绝了它，则 <code>Server</code> 通常不会有 <code>0-RTT</code> 记录保护密钥，而必须使用试用解密（使用 <code>1-RTT</code> 握手密钥或者通过在有 <code>HelloRetryRequest</code> 消息的情况下查找明文 <code>ClientHello</code>）找到第一个非 <code>0-RTT</code> 消息。</p><p>如果 <code>Server</code> 选择接受 <code>early_data</code> 扩展，那么在处理 <code>early data</code> 记录的时候，<code>Server</code> 必须遵守用相同的标准(指定的相同错误处理要求)来处理所有记录。具体来说，如果 <code>Server</code> 无法解密已经接受的 “<code>early_data</code>” 扩展中的记录，则它必须发送 “<code>bad_record_mac</code>” <code>alert</code> 消息中止握手。</p><p>如果 <code>Server</code> 拒绝 “<code>early_data</code>” 扩展，则 <code>Client</code> 应用程序可以选择在握手完成后重新发送先前在 <code>early data</code> 中发送的应用数据。请注意，<code>early data</code> 的自动重传可能会导致关于连接状态的误判。例如，当协商连接从用于 <code>early data</code> 的协议中选择不同的 <code>ALPN</code> 协议时，应用程序可能需要构造不同的消息。同样，如果 <code>early data</code> 假定包含有关连接状态的任何内容，则在握手完成后可能会错误地发送这些内容。</p><p><code>TLS</code> 的实现不应该自动重新发送 <code>early data</code>；应用程序可以很好的决定何时重传。除非协商连接选择相同的 <code>ALPN</code>协议，否则 <code>TLS</code> 实现绝不能自动重新发送 <code>early data</code>。</p><p>下图是 <code>NewSessionTicket</code> 中的 <code>early_data</code>，表明了 <code>Server</code> 可以接受 <code>0-RTT</code>。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_early_data.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_early_data.png"></p><hr><h3 id="6-pre_shared_key"><a class="markdownIt-Anchor" href="#6-pre_shared_key"></a> 6. pre_shared_key</h3><p>“<code>pre_shared_key</code>” 预共享密钥和 “<code>psk_key_exchange_modes</code>” 扩展配合使用。预共享密钥扩展包含了 <code>Client</code> 可以识别的对称密钥标识。“<code>psk_key_exchange_modes</code>” 扩展表明了可能可以和 <code>psk</code> 一起使用的密钥交换模式。</p><p>“<code>pre_shared_key</code>” 扩展用来协商标识的，这个标识是与 <code>PSK</code> 密钥相关联的给定握手所使用的预共享密钥的标识。</p><p>这个扩展中的 “<code>extension_data</code>” 字段包含一个 <code>PreSharedKeyExtension</code> 值:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    opaque identity&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>    uint32 obfuscated_ticket_age;<br>&#125; PskIdentity;<br><br>opaque PskBinderEntry&lt;<span class="hljs-number">32.</span><span class="hljs-number">.255</span>&gt;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    PskIdentity identities&lt;<span class="hljs-number">7.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>    PskBinderEntry binders&lt;<span class="hljs-number">33.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; OfferedPsks;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    select (Handshake.msg_type) &#123;<br>        <span class="hljs-keyword">case</span> client_hello: OfferedPsks;<br>        <span class="hljs-keyword">case</span> server_hello: uint16 selected_identity;<br>    &#125;;<br>&#125; PreSharedKeyExtension;<br></code></pre></td></tr></table></figure><ul><li><code>identity</code>: <code>key</code> 的标签。例如，一个 <code>ticket</code> 或者是一个外部建立的预共享密钥的标签。</li><li><code>obfuscated_ticket_age</code>: <code>age of the key</code> 的混淆版本。这一章节描述了通过 <code>NewSessionTicket</code> 消息建立，如何为标识(<code>identities</code>)生成这个值。对于外部建立的标识(<code>identities</code>)，应该使用 0 的 <code>obfuscated_ticket_age</code>，并且 <code>Server</code> 也必须忽略这个值。</li><li><code>identities</code>: <code>Client</code> 愿意和 <code>Server</code> 协商的 <code>identities</code> 列表。如果和 “<code>early_data</code>” 一起发送，第一个标识被用来标识 <code>0-RTT</code> 的。</li><li><code>binders</code>: 一系列的 <code>HMAC</code> 值。和 <code>identities</code> 列表中的每一个值都一一对应，并且顺序一致。</li><li><code>selected_identity</code>: <code>Server</code> 选择的标识，这个标识是以 <code>Client</code> 列表中标识表示为基于 0 的索引。</li></ul><p>每一个 <code>PSK</code> 都和单个哈希算法相关联。对于通过 <code>ticket</code> 建立的 <code>PSK</code>，当 <code>ticket</code> 在连接中被建立，这时候用的哈希算法是 <code>KDF</code> 哈希算法。对于外部建立的 <code>PSK</code>，当 <code>PSK</code> 建立的时候，哈希算法必须设置，如果没有设置，默认算法是 <code>SHA-256</code>。<code>Server</code> 必须确保它选择的是兼容的 <code>PSK</code> (如果有的话) 和密钥套件。</p><p>实现者请注意：会话恢复是 PSK 最主要的用途，实现 <code>PSK</code>/密钥套件 匹配要求的最直接的方法是先协商密码套件，然后再排除任何不兼容的 <code>PSK</code>。任何未知的 <code>PSK</code> (例如：不在 <code>PSK</code> 数据库中，或者用未知的 <code>key</code> 进行编码的)都必须忽略。如果找不到可接受的 <code>PSK</code>，如果可能，<code>Server</code> 应该执行 <code>non-PSK</code> 握手。如果向后兼容性很重要，<code>Client</code> 提供的，外部建立的 <code>PSK</code> 应该影响密码套件的选择。</p><p>在接受<code>PSK</code>密钥建立之前，<code>Server</code> 必须先验证相应的 <code>binder</code> 值。如果这个值不存在或者未验证，则 <code>Server</code> 必须立即中止握手。<code>Server</code> 不应该尝试去验证多个 <code>binder</code>，而应该选择单个 <code>PSK</code> 并且仅验证对应于该 <code>PSK</code> 的 <code>binder</code>。为了接受 <code>PSK</code> 密钥建立连接，<code>Server</code> 发送 “<code>pre_shared_key</code>” 扩展，标明它所选择的 <code>identity</code>。</p><p><code>Client</code>必须验证 <code>Server</code> 的 <code>selected_identity</code> 是否在 <code>Client</code> 提供的范围之内。<code>Server</code> 选择的加密套件标明了与 <code>PSK</code> 关联的哈希算法，如果 <code>ClientHello</code> “<code>psk_key_exchange_modes</code>” 有需要，<code>Server</code> 还应该发送 “<code>key_share</code>” 扩展。如果这些值不一致，<code>Client</code> 必须立即用 “<code>illegal_parameter</code>” <code>alert</code> 消息中止握手。</p><p>如果 <code>Server</code> 提供了 “<code>early_data</code>” 扩展，<code>Client</code> 必须验证 <code>Server</code> 的 <code>selected_identity</code> 是否为 0。如果返回任何其他值，<code>Client</code> 必须使用 “<code>illegal_parameter</code>” <code>alert</code> 消息中止握手。</p><p>“<code>pre_shared_key</code>” 扩展必须是<code>ClientHello</code> 中的最后一个扩展(这有利于下面的描述的实现)。<code>Server</code> 必须检查它是最后一个扩展，否则用 “<code>illegal_parameter</code>” <code>alert</code> 消息中止握手。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_pre_shared_key.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_pre_shared_key.png"></p><p>上图是 <code>ClientHello</code> 中的 <code>pre_shared_key</code> 扩展。</p><p><img src="/2023/08/16/mbedtls-certificate/ext/085157/ext_tls1_3_pre_shared_key_2.png" srcset="/img/loading.gif" lazyload alt="ext_tls1_3_pre_shared_key_2.png"></p><p>上图是 <code>Server</code> 选择后，返回给 <code>Client</code> 的 <code>pre_shared_key</code> 扩展。它标识了 <code>Server</code> 选择的哪一组密钥参数。</p><hr><h3 id="7-signature_algorithms_cert"><a class="markdownIt-Anchor" href="#7-signature_algorithms_cert"></a> 7. signature_algorithms_cert</h3><p>“<code>signature_algorithms</code>” 签名算法和 “<code>signature_algorithms_cert</code>” 签名证书算法的扩展配合使用。“<code>signature_algorithms</code>” 这个扩展展示了 <code>Client</code> 可以支持了签名算法有哪些。“<code>signature_algorithms_cert</code>” 这个扩展展示了具体证书的签名算法。</p><h3 id="8-cookie"><a class="markdownIt-Anchor" href="#8-cookie"></a> 8. cookie</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    opaque cookie&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; Cookie;<br></code></pre></td></tr></table></figure><p><code>Cookies</code> 有 2 大主要目的：</p><ul><li><p>允许 <code>Server</code> 强制 <code>Client</code> 展示网络地址的可达性(因此提供了一个保护 <code>Dos</code> 的度量方法)，这主要是面向无连接的传输(参考 <code>RFC 6347</code> 中的例子)</p></li><li><p>允许 <code>Server</code> 卸载状态。从而允许 <code>Server</code> 在向 <code>Client</code> 发送 <code>HelloRetryRequest</code> 消息的时候，不存储任何状态。为了实现这一点，可以通过 <code>Server</code> 把 <code>ClientHello</code> 的哈希存储在 <code>HelloRetryRequest</code> 的 <code>cookie</code> 中(用一些合适的完整性算法保护)。</p></li></ul><p>当发送 <code>HelloRetryRequest</code> 消息时，<code>Server</code> 可以向 <code>Client</code> 提供 “<code>cookie</code>” 扩展(这是常规中的一个例外，常规约定是：只能是可能被发送的扩展才可以出现在 <code>ClientHello</code> 中)。当发送新的 <code>ClientHello</code> 消息时，<code>Client</code> 必须将 <code>HelloRetryRequest</code> 中收到的扩展的内容复制到新 <code>ClientHello</code> 中的 “<code>cookie</code>” 扩展中。<code>Client</code> 不得在后续连接中使用首次 <code>ClientHello</code> 中的 <code>Cookie</code>。</p><p>当 <code>Server</code> 在无状态运行的时候，在第一个和第二个 <code>ClientHello</code> 之间可能会收到不受保护的 <code>change_cipher_spec</code> 消息。由于 <code>Server</code> 没有存储任何状态，它会表现出像到达的第一条消息一样。无状态的 <code>Server</code> 必须忽略这些记录。</p><hr><h3 id="9-certificate_authorities"><a class="markdownIt-Anchor" href="#9-certificate_authorities"></a> 9. certificate_authorities</h3><p>“<code>certificate_authorities</code>” 扩展用于表示终端支持的 <code>CA</code>, 并且接收的端点应该使用它来指导证书的选择。</p><p>“<code>certificate_authorities</code>” 扩展的主体包含了一个 <code>CertificateAuthoritiesExtension</code> 结构：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">opaque DistinguishedName&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    DistinguishedName authorities&lt;<span class="hljs-number">3.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; CertificateAuthoritiesExtension;<br></code></pre></td></tr></table></figure><ul><li><code>authorities</code>: 可接受证书颁发机构的一个可分辨名字 <code>X501</code> 的列表 ，这个列表是以 <code>DER X690</code> 编码格式表示的。这些可分辨的名称为，信任锚或从属的 <code>CA</code> 指定所需的可分辨的名称。因此，可以使用此消息描述已知的信任锚以及所需的授权空间。</li></ul><p><code>Client</code> 可能会在 <code>ClientHello</code> 消息中发送 “<code>certificate_authorities</code>” 扩展，<code>Server</code> 可能会在 <code>CertificateRequest</code> 消息中发送 “<code>certificate_authorities</code>” 扩展。</p><p>“<code>trusted_ca_keys</code>” 扩展和 “<code>certificate_authorities</code>” 扩展有相同的目的，但是更加复杂。“<code>trusted_ca_keys</code>” 扩展不能在 <code>TLS 1.3</code> 中使用，但是它在 <code>TLS 1.3</code> 之前的版本中，可能出现在 <code>Client</code> 的 <code>ClientHello</code> 消息中。</p><hr><h3 id="10-oid_filters"><a class="markdownIt-Anchor" href="#10-oid_filters"></a> 10. oid_filters</h3><p>“<code>oid_filters</code>” 扩展允许 <code>Server</code> 提供一组 <code>OID/value</code> 对，用来匹配 <code>Client</code> 的证书。如果 <code>Server</code> 想要发送这个扩展，有且仅有在 <code>CertificateRequest</code> 消息中才能发送。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    opaque certificate_extension_oid&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">8</span><span class="hljs-number">-1</span>&gt;;<br>    opaque certificate_extension_values&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; OIDFilter;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    OIDFilter filters&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;<br>&#125; OIDFilterExtension;<br></code></pre></td></tr></table></figure><ul><li><code>filters</code>: 一个有允许值的证书扩展 <code>OID RFC 5280</code> 列表，以 <code>DER</code> 编码 <code>X690</code> 格式表示。一些证书扩展 <code>OID</code> 允许多个值(例如，<code>Extended Key Usage</code>)。如果 <code>Server</code> 包含非空的 <code>filters</code> 列表，则响应中包含的 <code>Client</code> 证书必须包含 <code>Client</code> 识别的所有指定的扩展 <code>OID</code>。对于 <code>Client</code> 识别的每个扩展 <code>OID</code>，所有指定的值必须存在于 <code>Client</code> 证书中（但是证书也可以具有其他值）。然而，<code>Client</code> 必须忽略并跳过任何无法识别的证书扩展 <code>OID</code>。如果 <code>Client</code> 忽略了一些所需的证书扩展 <code>OID</code> 并提供了不满足请求的证书。<code>Server</code> 可以自行决定是继续与没有身份认证的 <code>Client</code> 保持连接，还是用 “<code>unsupported_certificate</code>” <code>alert</code> 消息中止握手。任何给定的 <code>OID</code> 都不能在 <code>filters</code> 列表中出现多次。</li></ul><p><code>PKIX RFC</code> 定义了各种证书扩展<code>OID</code> 及其对应的值类型。根据类型，匹配的证书扩展值不一定是按位相等的。期望 <code>TLS</code> 实现将依靠它们的 <code>PKI</code> 库，使用证书扩展 <code>OID</code> 来做证书的选择。</p><p><code>TLS 1.3</code> 规范中定义了 <code>RFC5280</code> 中定义的两个标准证书扩展的匹配规则：</p><ul><li><p>当请求中声明的所有 <code>Key Usage</code> 位也同样在 <code>Key Usage</code> 证书扩展声明了，那么证书中的 <code>Key Usage</code> 扩展匹配了请求。</p></li><li><p>当请求中所有的密钥 <code>OIDs</code> 在 <code>Extended Key Usage</code> 证书扩展中也存在，那么证书中的 <code>Extended Key Usage</code> 匹配了请求。特殊的 <code>anyExtendedKeyUsage OID</code> 一定不能在请求中使用。</p></li></ul><p>单独的规范可以为其他证书扩展的规则定义匹配规则。</p><hr><h3 id="11-post_handshake_auth"><a class="markdownIt-Anchor" href="#11-post_handshake_auth"></a> 11. post_handshake_auth</h3><p>“<code>post_handshake_auth</code>” 扩展用于表明 <code>Client</code> 愿意握手后再认证。<code>Server</code> 不能向没有提供此扩展的 <code>Client</code> 发送握手后再认证的 <code>CertificateRequest</code> 消息。<code>Server</code> 不能发送此扩展。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>&#125; PostHandshakeAuth;<br></code></pre></td></tr></table></figure><p>“<code>post_handshake_auth</code>” 扩展名中的 “<code>extension_data</code>” 字段为零长度。</p><p>当 <code>Client</code> 发送了 “<code>post_handshake_auth</code>” 扩展时，<code>Server</code> 可以在握手完成后随时通过发送 <code>CertificateRequest</code> 消息来请求客户端身份验证。<code>Client</code> 必须使用适当的验证消息进行响应。如果 <code>Client</code> 选择进行身份验证，则必须发送 <code>Certificate</code>，<code>CertificateVerify</code>，<code>Finished</code> 消息。如果 <code>Client</code> 拒绝身份验证，它必须发送一个 <code>Certificate</code> 证书消息，其中不包含证书，然后是 <code>Finished</code> 消息。响应 <code>Server</code> 的所有 <code>Client</code> 消息必须连续出现在线路上，中间不能有其他类型的消息。</p><p>在没有发送 “<code>post_handshake_auth</code>” 扩展的情况下接收 <code>CertificateRequest</code> 消息的 <code>Client</code> 必须发送 “<code>unexpected_message</code>” <code>alert</code> 消息。</p><p>注意：由于 <code>Client</code> 身份验证可能涉及提示用户，因此 <code>Server</code> 必须做好一些延迟的准备，包括在发送 <code>CertificateRequest</code> 和接收响应之间接收任意数量的其他消息。此外，<code>Client</code> 如果连续接收到了多个 <code>CertificateRequests</code> 消息，<code>Client</code> 可能会以不同于它们的顺序响应它们(<code>certificate_request_context</code> 值允许服务器消除响应的歧义)</p><hr><h3 id="12-signature_algorithms"><a class="markdownIt-Anchor" href="#12-signature_algorithms"></a> 12. signature_algorithms</h3><p>这个扩展在 <code>TLS 1.2</code> 中就存在，只不过在 <code>TLS 1.3</code> 中数据结构发生了变化，所以这个扩展还是需要提一下。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    SignatureScheme supported_signature_algorithms&lt;<span class="hljs-number">2.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-2</span>&gt;;<br>&#125; SignatureSchemeList;<br></code></pre></td></tr></table></figure><p><code>SignatureScheme</code> 有以下一些枚举值：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    <span class="hljs-comment">/* RSASSA-PKCS1-v1_5 algorithms */</span><br>    rsa_pkcs1_sha256(<span class="hljs-number">0x0401</span>),<br>    rsa_pkcs1_sha384(<span class="hljs-number">0x0501</span>),<br>    rsa_pkcs1_sha512(<span class="hljs-number">0x0601</span>),<br><br>    <span class="hljs-comment">/* ECDSA algorithms */</span><br>    ecdsa_secp256r1_sha256(<span class="hljs-number">0x0403</span>),<br>    ecdsa_secp384r1_sha384(<span class="hljs-number">0x0503</span>),<br>    ecdsa_secp521r1_sha512(<span class="hljs-number">0x0603</span>),<br><br>    <span class="hljs-comment">/* RSASSA-PSS algorithms with public key OID rsaEncryption */</span><br>    rsa_pss_rsae_sha256(<span class="hljs-number">0x0804</span>),<br>    rsa_pss_rsae_sha384(<span class="hljs-number">0x0805</span>),<br>    rsa_pss_rsae_sha512(<span class="hljs-number">0x0806</span>),<br><br>    <span class="hljs-comment">/* EdDSA algorithms */</span><br>    ed25519(<span class="hljs-number">0x0807</span>),<br>    ed448(<span class="hljs-number">0x0808</span>),<br><br>    <span class="hljs-comment">/* RSASSA-PSS algorithms with public key OID RSASSA-PSS */</span><br>    rsa_pss_pss_sha256(<span class="hljs-number">0x0809</span>),<br>    rsa_pss_pss_sha384(<span class="hljs-number">0x080a</span>),<br>    rsa_pss_pss_sha512(<span class="hljs-number">0x080b</span>),<br><br>    <span class="hljs-comment">/* Legacy algorithms */</span><br>    rsa_pkcs1_sha1(<span class="hljs-number">0x0201</span>),<br>    ecdsa_sha1(<span class="hljs-number">0x0203</span>),<br><br>    <span class="hljs-comment">/* Reserved Code Points */</span><br>    obsolete_RESERVED(<span class="hljs-number">0x0000</span>.<span class="hljs-number">.0</span>x0200),<br>    dsa_sha1_RESERVED(<span class="hljs-number">0x0202</span>),<br>    obsolete_RESERVED(<span class="hljs-number">0x0204</span>.<span class="hljs-number">.0</span>x0400),<br>    dsa_sha256_RESERVED(<span class="hljs-number">0x0402</span>),<br>    obsolete_RESERVED(<span class="hljs-number">0x0404</span>.<span class="hljs-number">.0</span>x0500),<br>    dsa_sha384_RESERVED(<span class="hljs-number">0x0502</span>),<br>    obsolete_RESERVED(<span class="hljs-number">0x0504</span>.<span class="hljs-number">.0</span>x0600),<br>    dsa_sha512_RESERVED(<span class="hljs-number">0x0602</span>),<br>    obsolete_RESERVED(<span class="hljs-number">0x0604</span>.<span class="hljs-number">.0</span>x06FF),<br>    private_use(<span class="hljs-number">0xFE00</span>.<span class="hljs-number">.0</span>xFFFF),<br>    (<span class="hljs-number">0xFFFF</span>)<br>&#125; SignatureScheme;<br></code></pre></td></tr></table></figure><hr><h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/HTTPS-extensions.md">HTTPS 温故知新（六） —— TLS 中的 Extensions</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6066">RFC 6066 - TLS Extensions</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc4346">RFC 4346 - TLS 1.1 Protocol</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2246">RFC 2246 - TLS 1.0 Protocol</a></li><li><a target="_blank" rel="noopener" href="https://www.liuvv.com/p/be73ec63.html">https协议</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" class="category-chain-item">密码学</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/TLS/">#TLS</a> <a href="/tags/mbedtls/">#mbedtls</a></div></div><div class="license-box my-3"><div class="license-title"><div>tls协议扩展详情</div><div>http://example.com/2023/08/16/mbedtls-certificate/ext/085157/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年8月16日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/08/16/tls/protocol/tls1_3/085339/" title="tls1.3协议原理"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">tls1.3协议原理</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/08/16/tls/certificate/084839/" title="部署安全的tls证书"><span class="hidden-mobile">部署安全的tls证书</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>