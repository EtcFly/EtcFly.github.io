<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介   随着数字化的普及, 越来越多的信息走向网络, 数据安全存储越来越重要。对于大家熟悉的各类网盘, 如百度网盘, 阿里云盘等等，这些很多存在严重限速以及存储空间不足的问题。数据上传和下载被限速导致用户体验极差.   与此同时, 当我"><meta property="og:type" content="article"><meta property="og:title" content="nextcloud搭建高速本地网盘"><meta property="og:url" content="http://example.com/2023/02/08/linux/nextcloud/005226/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介   随着数字化的普及, 越来越多的信息走向网络, 数据安全存储越来越重要。对于大家熟悉的各类网盘, 如百度网盘, 阿里云盘等等，这些很多存在严重限速以及存储空间不足的问题。数据上传和下载被限速导致用户体验极差.   与此同时, 当我"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/nextcloud.png"><meta property="article:published_time" content="2023-02-08T00:52:26.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="linux - nextcloud"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/nextcloud.png"><title>nextcloud搭建高速本地网盘 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="nextcloud搭建高速本地网盘"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-08 00:52" pubdate>2023年2月8日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 5.7k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 48 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">nextcloud搭建高速本地网盘</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3><p>  随着数字化的普及, 越来越多的信息走向网络, 数据安全存储越来越重要。对于大家熟悉的各类网盘, 如百度网盘, 阿里云盘等等，这些很多存在严重限速以及存储空间不足的问题。数据上传和下载被限速导致用户体验极差.<br>  与此同时, 当我们的私密数据被存储在第三方平台，也存在各类安全泄漏的风险，因此本文极力打造私人的个人网盘服务, 数据存储在本地，定期进行备份, 磁盘容量也很容易扩展，速度方面也具有很大优势。</p><p>  目前开源的网盘项目有如下几个:</p><ul><li><p><a href="https://link.zhihu.com/?target=https%3A//github.com/alist-org/alist-web">AList</a>: 颜值极高的一个网盘程序，支持常见的多种存储、文件预览、网页上传、打包下载，甚至还支持暗黑模式和多语言</p></li><li><p><a href="(https://nextcloud.com/install/#instructions-server)">Nextcloud</a>: 可以搭建个人同步分享的网盘，同样全平台支持，<code>Nextcloud</code>作为<code>ownCloud</code>的衍生版本,在其基础上做了许多改进,</p></li><li><p><a target="_blank" rel="noopener" href="https://cloudreve.org/">Cloudreve</a>: 如果你需要一个相对简单的网盘，这个是最合适不过了，强大的离线下载功能，支持七牛云等第三方云存储，支持视频音频文档等文件的在线预览</p></li><li><p><a target="_blank" rel="noopener" href="https://owncloud.com/">ownCloud</a>: <code>ownCloud</code> 是一个开源免费专业的私有云存储项目，它能帮你快速在个人电脑或服务器上架设一套专属的私有云文件同步网盘，可以像<code>Dropbox</code> 那样实现文件跨平台同步、共享、版本控制、团队协作等等。</p></li><li><p><a target="_blank" rel="noopener" href="https://kodcloud.com/download/">可道云</a>: 功能丰富强大，界面精致友好，像操作本地文件一样编辑、预览、解压，直接上传到主机即可使用，无需数据库</p></li></ul><p>总而言之, 可选的方案很多, 具体如何权衡请自行进行对比, 这里选则<code>netxcloud</code>来进行部署。</p><p><strong>参考资料</strong></p><ul><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/44103820">如何搭建自己的私有云盘</a></li></ul><hr><h3 id="开发环境搭建"><a class="markdownIt-Anchor" href="#开发环境搭建"></a> 开发环境搭建</h3><p>  <code>nextcloud</code>是一个<code>php</code>项目, 项目运行需要<code>LNMP</code>环境, 即<code>Linux+Nginx+MySql+PHP</code>, 关于这几个环境的搭建, 请参考如下:</p><ul><li><p><code>Nginx</code>:</p><ul><li><a target="_blank" rel="noopener" href="https://etcfly.top/2023/02/04/linux/nginxconfig/000102/">nginx参数配置</a></li><li><a target="_blank" rel="noopener" href="https://etcfly.top/2023/01/08/nginx/praxyinstall230251/">linux下ngnix代理安装配置</a></li></ul></li><li><p><code>MySql</code>:</p><ul><li><a target="_blank" rel="noopener" href="https://etcfly.top/2023/01/31/server/umami-mysql/203139/">搭建umami+mysql流量统计系统</a></li></ul></li></ul><p>这里主要讲解一下<code>PHP</code>环境的搭建。</p><hr><h4 id="php环境搭建"><a class="markdownIt-Anchor" href="#php环境搭建"></a> PHP环境搭建</h4><h5 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h5><p><code>nextcloud</code>需要基础的运行环境, 对于<code>php</code>而言， 第一步需要依赖如下控件。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt-get update<br>sudo apt-get install php8.0 php8.0-fpm php8.0-mysql -y<br></code></pre></td></tr></table></figure><p>这里安装的是<code>php8.0</code>, 对于太低的<code>php</code>版本, <code>nextcloud</code>安装可能不支持, 请确保在<code>php7.4</code>以上。如果你通过<code>apt update</code>更新后的<code>php</code>版本还是较低, 可通过如下方式升级。</p><h5 id="升级"><a class="markdownIt-Anchor" href="#升级"></a> 升级</h5><ol><li>为<code>PHP 8.0</code>添加<code>PPA</code>储存库</li></ol><blockquote><p>使用<code>ondrej/php</code>添加<code>PHP 8.0</code>包和其他所需要的<code>PHP</code>扩展</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install software-properties-common<br>sudo add-apt-repository ppa:ondrej/php<br>sudo apt update<br></code></pre></td></tr></table></figure><p>成功添加PPA后，就可以安装<code>PHP 8.0</code>了, 直接通过<code>apt</code>安装即可。</p><ol start="2"><li>安装<code>PHP 8.0</code>扩展</li></ol><blockquote><p>执行命令，安装<code>PHP</code>扩展</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install php8.0-extension_name<br></code></pre></td></tr></table></figure><p>至此, <code>php</code>基础环境就可以了, 后面我们缺什么库在实际安装。</p><p><strong>参考资料</strong>:</p><ul><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/402297155">如何在Ubuntu中将PHP升级到8.0</a></li></ul><hr><h3 id="nextcloud安装"><a class="markdownIt-Anchor" href="#nextcloud安装"></a> nextcloud安装</h3><p>  经过前面的步骤, 已经可以了基础的<code>LAMP</code>的环境搭建, 现在开始正式的<code>nextcloud</code>部署之路。首先下载<code>nextcloud</code>。</p><ul><li><a target="_blank" rel="noopener" href="https://nextcloud.com/install/#instructions-server">nextcloud下载</a></li></ul><p>一般下载下来是一个<code>nextcloud-版本.zip</code>的这样一个问题, 我们将其拷贝到<code>/opt/</code>目录下, 修改文件名为<code>nextcloud</code>。<br>添加权限:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">chown</span> www-data:www-data /opt/nextcloud -fR<br></code></pre></td></tr></table></figure><p>如果没有添加权限可能会报错, 如:</p><ul><li>浏览器直接页面刷新不出来</li><li>页面可以刷新出来但是显示: 服务器内部错误</li></ul><p><img src="/2023/02/08/linux/nextcloud/005226/nextcloud%E5%86%85%E9%83%A8%E9%94%99%E8%AF%AF.png" srcset="/img/loading.gif" lazyload alt="nextcloud内部错误.png"></p><p><strong>参考资料</strong>:</p><ul><li><a target="_blank" rel="noopener" href="https://www.wunote.cn/article/956/">NextCloud安装时出现服务器内部错误</a></li></ul><hr><p>配置<code>nginx</code>代理:<br>创建一个<code>nextcloud.conf</code>, 并拷贝到<code>/usr/local/nginx/conf/</code>目录, 内容如下:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">root</span>         /opt/nextcloud;<br>    <span class="hljs-attribute">index</span>  index.php index.html index.htm;<br>    <span class="hljs-section">location</span> / &#123;<br>      <span class="hljs-attribute">if</span> (-f <span class="hljs-variable">$request_filename</span>/index.html)&#123;<br>    <span class="hljs-attribute">rewrite</span> (.*) <span class="hljs-variable">$1</span>/index.html <span class="hljs-literal">break</span>;<br>      &#125;<br>      <span class="hljs-attribute">if</span> (-f <span class="hljs-variable">$request_filename</span>/index.php)&#123;<br>          <span class="hljs-attribute">rewrite</span> (.*) <span class="hljs-variable">$1</span>/index.php;<br>      &#125;<br>      <span class="hljs-attribute">if</span> (!-f <span class="hljs-variable">$request_filename</span>)&#123;<br>          <span class="hljs-attribute">rewrite</span> (.*) /index.php;<br>      &#125;<br>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ =<span class="hljs-number">404</span>;<br>    &#125;<br><br>    <span class="hljs-section">location</span> <span class="hljs-regexp">~ .php$</span> &#123;<br>        <span class="hljs-attribute">fastcgi_pass</span>  unix:/run/php/php8.0-fpm.sock;<br>        <span class="hljs-comment"># 如果你的php版本低于7.0，请将unix:/run/php/php7.0-fpm.sock;替换为127.0.0.1:9000；</span><br>        <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>        <span class="hljs-attribute">fastcgi_param</span>  SCRIPT_FILENAME  <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;<br>        <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在浏览器上输入:<code>http://ip:port</code>, 显示如下：</p><p><img src="/2023/02/08/linux/nextcloud/005226/nextcloud%E6%A8%A1%E5%9D%97%E9%94%99%E8%AF%AF.png" srcset="/img/loading.gif" lazyload alt="nextcloud模块错误.png"></p><p>这里会显示很多模块未安装, 可以通过<code>apt</code>安装:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install php8.0-模块名<br></code></pre></td></tr></table></figure><p>  安装完成后可以正常打开: <code>http://你的服务器IP/index.php</code>, 这时候系统要求你提供管理账户、密码、数据库用户名、数据库密码、数据库名、及数据库地址。管理用户名及密码自定义，但一定要记清楚，这里以<code>admin</code>和<code>passwd</code>为例。数据目录就是存放你文件的目录。数据库用户名和密码是你创建的用户名和密码。我这里以<code>nextcloud</code>为例。数据库地址默认localhost即可。</p><p><img src="/2023/02/08/linux/nextcloud/005226/nextcloud%E5%AE%89%E8%A3%85%E7%95%8C%E9%9D%A2.png" srcset="/img/loading.gif" lazyload alt="nextcloud安装界面.png"></p><p>设置完成后，点击安装完成按钮，即可完成安装。接下来，我们就可以使用<code>Nextcloud</code>服务啦！</p><p><img src="/2023/02/08/linux/nextcloud/005226/nextcloud%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90.png" srcset="/img/loading.gif" lazyload alt="nextcloud安装完成.png"></p><p>通过以上, 我们就完成了<code>nextcloud</code>云盘的部署了, 但是如果就这样使用, 你会发现系统特别卡顿。还需要进一步配置优化。</p><p><strong>参考资料</strong>:</p><ul><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jdhj/articles/16635860.html">如何使用 Nextcloud 搭建个人网盘</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/439229940">Ubuntu安装nginx+php+nextcloud</a></li></ul><hr><h3 id="nextcloud优化"><a class="markdownIt-Anchor" href="#nextcloud优化"></a> nextcloud优化</h3><h4 id="开启内存缓存"><a class="markdownIt-Anchor" href="#开启内存缓存"></a> 开启内存缓存</h4><ul><li>APCu<br><strong>安装</strong>:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install php8.0-pecl-apcu<br></code></pre></td></tr></table></figure><p><strong>配置</strong>:<br>修改<code>nextcloud</code>根目录下<code>config/cinfig.php</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-string">&#x27;memcache.local&#x27;</span> =&gt; <span class="hljs-string">&#x27;\OC\Memcache\APCu&#x27;</span>,<br></code></pre></td></tr></table></figure><hr><ul><li>Redis<br><strong>安装</strong>:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install php8.0-redis-server php8.0-redis<br></code></pre></td></tr></table></figure><p>正常情况下当我们安装完成, <code>redis-server</code>会自动启动, 可以通过如下命令来确认:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps ax | grep redis<br>22203 ? Ssl    0:00 /usr/bin/redis-server 127.0.0.1:6379<br></code></pre></td></tr></table></figure><p><strong>配置</strong>:<br>修改<code>config.php</code>文件, 加入如下内容:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-string">&#x27;memcache.distributed&#x27;</span> =&gt; <span class="hljs-string">&#x27;\OC\Memcache\Redis&#x27;</span>,<br><span class="hljs-string">&#x27;redis&#x27;</span> =&gt; [<br>     <span class="hljs-string">&#x27;host&#x27;</span> =&gt; <span class="hljs-string">&#x27;redis-host.example.com&#x27;</span>,<br>     <span class="hljs-string">&#x27;port&#x27;</span> =&gt; 6379,<br>],<br><span class="hljs-string">&#x27;memcache.locking&#x27;</span> =&gt; <span class="hljs-string">&#x27;\OC\Memcache\Redis&#x27;</span>,<br></code></pre></td></tr></table></figure><hr><ul><li>开启<code>https</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#防止出现不能https访问问题</span><br><span class="hljs-string">&#x27;overwriteprotocol&#x27;</span> =&gt; <span class="hljs-string">&#x27;https&#x27;</span>,<br></code></pre></td></tr></table></figure><hr><ul><li><code>开启PHP OPcache</code><br><strong>安装</strong>:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install php8.0-opcache<br></code></pre></td></tr></table></figure><hr><ul><li>切换<code>Cron</code>定时<br>添加<code>crontab</code>定时任务</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">crontab -e<br></code></pre></td></tr></table></figure><p>添加如下定时:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">*/5 * * * * sudo -u www php -f /opt/nextcloud/cron.php<br></code></pre></td></tr></table></figure><p><strong>检查效果</strong>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">crontab -u www-data -l<br></code></pre></td></tr></table></figure><p><strong>输出</strong>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[snip]<br>*/5  *  *  *  * php -f /var/www/nextcloud/cron.php<br></code></pre></td></tr></table></figure><hr><ul><li>增加音视频预览<br>安装<code>ffmpeg</code>:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install ffmpeg<br></code></pre></td></tr></table></figure><p>然后配置如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#增加视频预览,需要提前安装ffmpeg</span><br><span class="hljs-string">&#x27;enabledPreviewProviders&#x27;</span> =&gt;<br>array (<br>  0 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\PNG&#x27;</span>,<br>  1 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\JPEG&#x27;</span>,<br>  2 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\GIF&#x27;</span>,<br>  3 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\HEIC&#x27;</span>,<br>  4 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\BMP&#x27;</span>,<br>  5 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\XBitmap&#x27;</span>,<br>  6 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\MP3&#x27;</span>,<br>  7 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\TXT&#x27;</span>,<br>  8 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\MarkDown&#x27;</span>,<br>  9 =&gt; <span class="hljs-string">&#x27;OC\\Preview\\Movie&#x27;</span><br>),<br></code></pre></td></tr></table></figure><hr><h4 id="nextcloud的php优化"><a class="markdownIt-Anchor" href="#nextcloud的php优化"></a> nextcloud的php优化</h4><p>编辑<code>/etc/php/8.0/fpm/pool.d/www.conf</code>目录, 修改配置如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">pm = dynamic<br>pm.max_children = 300<br>pm.start_servers = 18<br>pm.min_spare_servers = 6<br>pm.max_spare_servers = 36<br></code></pre></td></tr></table></figure><h4 id="数据库优化"><a class="markdownIt-Anchor" href="#数据库优化"></a> 数据库优化</h4><p>编辑<code>/etc/php/8.0/fpm/conf.d/20-mysqli.ini</code>, 修改内容如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">[mysql]<br>mysql.allow_local_infile=On<br>mysql.allow_persistent=On<br>mysql.cache_size=2000<br>mysql.max_persistent=-1<br>mysql.max_links=-1<br>mysql.default_port=<br>mysql.default_socket=/var/lib/mysql/mysql.sock  <span class="hljs-comment"># Debian squeeze: /var/run/mysqld/mysqld.sock</span><br>mysql.default_host=<br>mysql.default_user=<br>mysql.default_password=<br>mysql.connect_timeout=60<br>mysql.trace_mode=Off<br></code></pre></td></tr></table></figure><p>数据库优化，编辑<code>/etc/mysql/mariadb.cnf</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh">[server]<br>skip_name_resolve = 1<br>innodb_buffer_pool_size = 128M<br>innodb_buffer_pool_instances = 1<br>innodb_flush_log_at_trx_commit = 2<br>innodb_log_buffer_size = 32M<br>innodb_max_dirty_pages_pct = 90<br>query_cache_type = 1<br>query_cache_limit = 2M<br>query_cache_min_res_unit = 2k<br>query_cache_size = 64M<br>tmp_table_size= 64M<br>max_heap_table_size= 64M<br>slow_query_log = 1<br>slow_query_log_file = /var/log/mysql/slow.log<br>long_query_time = 1<br><br>[mysqld]<br>character_set_server = utf8mb4<br>collation_server = utf8mb4_general_ci<br>transaction_isolation = READ-COMMITTED<br>binlog_format = ROW<br>innodb_large_prefix=on<br>innodb_file_format=barracuda<br>innodb_file_per_table=1<br></code></pre></td></tr></table></figure><p>保存完成后, 重启数据库：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl restart mysql<br></code></pre></td></tr></table></figure><hr><h4 id="enable-php-opcache"><a class="markdownIt-Anchor" href="#enable-php-opcache"></a> Enable PHP OPcache</h4><p>修改<code>php.ini</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">opcache.enable = 1<br>opcache.interned_strings_buffer = 8<br>opcache.max_accelerated_files = 10000<br>opcache.memory_consumption = 128<br>opcache.save_comments = 1<br>opcache.revalidate_freq = 1<br></code></pre></td></tr></table></figure><p><strong>参考文档</strong>:</p><ul><li><a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/23/admin_manual/configuration_server/caching_configuration.html#id1">nextclod Memory caching</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/i12344/article/details/107712473">Nextcloud打开缓慢卡顿的一些优化</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/435516648">Ubuntu安装Nextcloud个人网盘搭建环境部署</a></li></ul><hr><h3 id="网盘自检查"><a class="markdownIt-Anchor" href="#网盘自检查"></a> 网盘自检查</h3><p>  进入网盘 -&gt; 设置 -&gt; 基本, 我们可以看到安全与警告, 通过这里我们可以看相关的一些警告信息，从而可以针对性优化。</p><hr><h3 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h3><ul><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jdhj/articles/16635860.html">如何使用 Nextcloud 搭建个人网盘</a></li><li><a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/23/admin_manual/installation/nginx.html">Nextcloud NGINX configuration</a></li><li><a target="_blank" rel="noopener" href="http://help.websoft9.com/cloudbox-practice/nextcloud/solution/https.html">自建企业网盘</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E6%90%AD%E5%BB%BA/" class="category-chain-item">基础设施搭建</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/linux-nextcloud/">#linux - nextcloud</a></div></div><div class="license-box my-3"><div class="license-title"><div>nextcloud搭建高速本地网盘</div><div>http://example.com/2023/02/08/linux/nextcloud/005226/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年2月8日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/02/09/frp/leanote/private/213142/" title="frp穿透+leanote搭建私人云笔记"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">frp穿透+leanote搭建私人云笔记</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/02/04/linux/nginxconfig/000102/" title="nginx参数配置"><span class="hidden-mobile">nginx参数配置</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>