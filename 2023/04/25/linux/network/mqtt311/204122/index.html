<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              1. 背景   MQTT是一个轻量级、基于发布-订阅模型的M2M 消息队列服务的网络协议。它专为资源限制或网络带宽有限的远程设备而设计。例如在物联网(IoT) 中, 很多远端设备都是资源有限, 对于像HTTP之类重量级协议是很难支持的,"><meta property="og:type" content="article"><meta property="og:title" content="mqtt3.1.1协议详解"><meta property="og:url" content="http://example.com/2023/04/25/linux/network/mqtt311/204122/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              1. 背景   MQTT是一个轻量级、基于发布-订阅模型的M2M 消息队列服务的网络协议。它专为资源限制或网络带宽有限的远程设备而设计。例如在物联网(IoT) 中, 很多远端设备都是资源有限, 对于像HTTP之类重量级协议是很难支持的,"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/mqtt.png"><meta property="article:published_time" content="2023-04-25T20:41:22.000Z"><meta property="article:modified_time" content="2024-03-05T03:41:03.000Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创"><meta property="article:tag" content="TCPIP"><meta property="article:tag" content="MQTT"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/mqtt.png"><title>mqtt3.1.1协议详解 仗剑走天涯</title><meta name="robots" content="noindex"><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="mqtt3.1.1协议详解"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-04-25 20:41" pubdate>2023年4月25日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 10k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 86 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">mqtt3.1.1协议详解</h1><p class="note note-info">本文最后更新于：2024年3月5日 凌晨</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h3 id="1-背景"><a class="markdownIt-Anchor" href="#1-背景"></a> 1. 背景</h3><p>  <code>MQTT</code>是一个轻量级、基于发布-订阅模型的<code>M2M</code> 消息队列服务的网络协议。它专为资源限制或网络带宽有限的远程设备而设计。例如在物联网(<code>IoT</code>) 中, 很多远端设备都是资源有限, 对于像<code>HTTP</code>之类重量级协议是很难支持的, 于此同时一些设备可能还需要低功耗, 大量的发包会导致功耗的增加, <code>MQTT</code>就是为此类场景诞生的。</p><p>  <code>MQTT</code>最早是<code>IBM</code>为自己产品设计和开发的, 该协议提供发布和订阅消息传递。<code>2013</code> 年, <code>IBM</code> 向 <code>OASIS</code> 规范机构提交了 <code>MQTT v3.1</code>，并附有一份章程，确保仅接受对规范的微小更改。此后, <code>OASIS</code> 从 <code>IBM</code> 手中接过标准的维护工作，于 <code>2014</code> 年 <code>10</code> 月 <code>29</code> 日发布了 <code>3.1.1</code> 版本。这是<code>OASIS</code> 标准化组织发布的首个<code>MQTT</code>版本, <code>2019</code> 年 <code>3</code> 月 <code>7</code> 日， <code>OASIS</code> 组织发布了<code>MQTT V5.0</code>协议, 版本 <code>5</code> 对 版本 <code>V3.1.1</code> 进行了更大幅度的升级, 目前最新的发布版本就是<code>V5.0</code>版本。</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload alt="基础架构.png"></p><hr><h3 id="2-协议"><a class="markdownIt-Anchor" href="#2-协议"></a> 2. 协议</h3><p><strong>控制报文组成为:</strong><br>报文 = 固定报头 + 可变报头(不同报文可能不存在可变报头) + 有效载荷(数据区域(需要指定特定的<code>UTF-8</code>编码, 通常传输需要将二机制格式进行<code>Base64</code>编码)), 接下来分别介绍报文的各部分。</p><h4 id="21-固定报头"><a class="markdownIt-Anchor" href="#21-固定报头"></a> 2.1 固定报头</h4><p>  首先是固定报头部分, <code>mqtt v3.1.1</code>每一个报文都包含一个固定的报头, 报头格式如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E5%9B%BA%E5%AE%9A%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.png" srcset="/img/loading.gif" lazyload alt="固定报文格式.png"></p><hr><h5 id="211-控制报文类型"><a class="markdownIt-Anchor" href="#211-控制报文类型"></a> 2.1.1 控制报文类型</h5><p><strong>位置</strong>: 其位置为报文第<code>1byte</code>, 二进制位<code>7-4</code><br><code>v3.1.1</code>协议具有特定的报文格式, 这些控制报文类型一共有<code>14</code>种, 占据<code>4bit</code>位, 如下图:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E7%B1%BB%E5%9E%8B.png" srcset="/img/loading.gif" lazyload alt="控制报文类型.png"></p><hr><h5 id="212-控制报文标志位"><a class="markdownIt-Anchor" href="#212-控制报文标志位"></a> 2.1.2 控制报文标志位</h5><p><strong>位置</strong>: 其位置为报文第<code>1byte</code>, 二进制位<code>3-0</code></p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E6%A0%87%E5%BF%97%E4%BD%8D.png" srcset="/img/loading.gif" lazyload alt="控制报文标志位.png"></p><ul><li><code>DUP</code>: 控制报文重复分发标志</li><li><code>QOS</code>: 用于<code>PUBLISH</code> 报文的服务质量等级</li><li><code>RETAIN</code>: <code>PUBLISH</code> 报文的保留标志</li></ul><hr><h5 id="213-剩余长度"><a class="markdownIt-Anchor" href="#213-剩余长度"></a> 2.1.3 剩余长度</h5><p><strong>位置</strong>: 从第<code>2</code>个直接, 最多<code>4</code>字节, 采用变长编码方式。</p><p>  剩余长度字段使用一个变长度编码方案， 对小于 <code>128</code> 的值它使用单字节编码。 更大的值按下面的方式处理。低 <code>7</code> 位有效位用于编码数据，最高有效位用于指示是否有更多的字节。 因此每个字节可以编码 <code>128</code> 个数值和一个延续位（<code>continuation bit</code>） 。 剩余长度字段最大 <code>4</code> 个字节</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E5%89%A9%E4%BD%99%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6.png" srcset="/img/loading.gif" lazyload alt="剩余长度限制.png"></p><p><strong>变长编码算法</strong>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span><br>    encodedByte = X MOD <span class="hljs-number">128</span><br>    X = X DIV <span class="hljs-number">128</span><br>    <span class="hljs-comment">// if there are more data to encode, set the top bit of this byte</span><br>    <span class="hljs-keyword">if</span> ( X &gt; <span class="hljs-number">0</span> )<br>        encodedByte = encodedByte OR <span class="hljs-number">128</span><br>    endif<br>    <span class="hljs-string">&#x27;output&#x27;</span> encodedByte<br><span class="hljs-keyword">while</span> ( X &gt; <span class="hljs-number">0</span> )<br></code></pre></td></tr></table></figure><p><code>MOD</code> 是模运算， <code>DIV</code> 是整数除法， <code>OR</code> 是位操作或（<code>C</code> 语言中分别是<code>%</code>， <code>/</code>， <code>|</code>）</p><p><strong>变长解码算法</strong>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">multiplier = <span class="hljs-number">1</span><br>value = <span class="hljs-number">0</span><br><span class="hljs-keyword">do</span><br>    encodedByte = <span class="hljs-string">&#x27;next byte from stream&#x27;</span><br>    value += (encodedByte AND <span class="hljs-number">127</span>) * multiplier<br>    multiplier *= <span class="hljs-number">128</span><br><br>    <span class="hljs-keyword">if</span> (multiplier &gt; <span class="hljs-number">128</span>*<span class="hljs-number">128</span>*<span class="hljs-number">128</span>)<br>        throw Error(Malformed Remaining Length)<br><span class="hljs-keyword">while</span> ((encodedByte AND <span class="hljs-number">128</span>) != <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p><code>AND</code> 是位操作与（<code>C</code> 语言中的 <code>&amp;</code>）, 这个算法终止时， <code>value</code> 包含的就是剩余长度的值。</p><hr><h4 id="22-可变报头"><a class="markdownIt-Anchor" href="#22-可变报头"></a> 2.2 可变报头</h4><p>  某些 <code>MQTT</code> 控制报文包含一个可变报头部分。 它在固定报头和负载之间。可变报头的内容根据报文类型的不同而不同。可变报头的报文标识符（<code>Packet Identifier</code>） 字段存在于在多个类型的报文里, 这些报文是:<code>PUBLISH(QOS&gt;0)</code>时, <code>PUBACK</code>、<code>PUBREC</code>、<code>PUBREL</code>、<code>PUBCOMP</code>、<code>SUBSCRIBE</code>、<code>SUBACK</code>、<code>UNSUBACK</code>。即<code>PUBLISH(QOS&gt;0)</code>时, <code>SUBSCRIBE</code>和<code>UNSUBCRIBE</code>相关报文。这些报文(除<code>PUBLISH(QOS=0)</code>报文)都包含报文标识符(<code>2Byte</code>)来唯一标识一个报文。</p><p>  客户端每次发送一个新的这些类型的报文时都必须分配一个当前未使用的报文标识符, 如果一个客户端要重发这个特殊的控制报文，在随后重发那个报文时， 它必须使用相同的标识符。 当客户端处理完这个报文对应的确认后，这个报文标识符就释放可重用。<code>QoS</code> 设置为 <code>0</code> 的 <code>PUBLISH</code> 报文不能包含报文标识符。<code>PUBACK</code>, <code>PUBREC</code>, <code>PUBREL</code> 报文必须包含与最初发送的 <code>PUBLISH</code> 报文相同的报文标识符。 类似地， <code>SUBACK</code> 和 <code>UNSUBACK</code> 必须包含在对应的 <code>SUBSCRIBE</code> 和 <code>UNSUBSCRIBE</code> 报文中使用的报文标识符。</p><p><strong>如下表示需要包含报文标识符的控制报文:</strong></p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E5%8C%85%E5%90%AB%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E6%A0%87%E8%AF%86%E7%AC%A6%E7%9A%84%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87.png" srcset="/img/loading.gif" lazyload alt="包含控制报文标识符的控制报文.png"></p><p>客户端和服务端彼此独立地分配报文标识符。 因此，客户端服务端组合使用相同的报文标识符可以实现并发的消息交换</p><hr><h4 id="23-有效载荷"><a class="markdownIt-Anchor" href="#23-有效载荷"></a> 2.3 有效载荷</h4><p>  某些 <code>MQTT</code> 控制报文在报文的最后部分包含一个有效载荷, 具体那些报文包含有效载荷如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E5%8C%85%E5%90%AB%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E7%9A%84%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87.png" srcset="/img/loading.gif" lazyload alt="包含有效载荷的控制报文.png"></p><hr><h3 id="3-报文格式"><a class="markdownIt-Anchor" href="#3-报文格式"></a> 3. 报文格式</h3><p>  接下来我们分别对<code>MQTT</code>的<code>14</code>种类型的报文组成进行描述, 以 <strong>固定报头</strong>、<strong>可变报头</strong>、<strong>有效载荷</strong> 三部分进行介绍。</p><h4 id="31-connect"><a class="markdownIt-Anchor" href="#31-connect"></a> 3.1 CONNECT</h4><h5 id="311-固定报头"><a class="markdownIt-Anchor" href="#311-固定报头"></a> 3.1.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/connect%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="connect报文固定报头.png"></p><ul><li>剩余类型: 剩余长度等于可变报头的长度（<code>10</code> 字节） 加上有效载荷的长度。</li></ul><hr><h5 id="312-可变报头"><a class="markdownIt-Anchor" href="#312-可变报头"></a> 3.1.2 可变报头</h5><p><code>CONNECT</code> 报文的可变报头按下列次序包含四个字段：协议名（<code>Protocol Name</code>）(<code>6Byte</code>)， 协议级别（<code>Protocol Level</code>）(<code>1Byte</code>) ， 连接标志（<code>Connect Flags</code>）(<code>1Byte</code>)和保持连接（<code>Keep Alive</code>）(<code>2Byte</code>), 总共<code>10Byte</code>。</p><h6 id="3121-协议名"><a class="markdownIt-Anchor" href="#3121-协议名"></a> 3.1.2.1 协议名</h6><p><img src="/2023/04/25/linux/network/mqtt311/204122/connect%E5%8D%8F%E8%AE%AE%E5%90%8D.png" srcset="/img/loading.gif" lazyload alt="connect协议名.png"></p><p>  协议名是表示协议名 <code>MQTT</code> 的 <code>UTF-8</code> 编码的字符串。 <code>MQTT</code> 规范的后续版本不会改变这个字符串的偏移和长度。如果协议名不正确服务端可以断开客户端的连接， 也可以按照某些其它规范继续处理 <code>CONNECT</code> 报文。对于后一种情况，按照本规范， 服务端不能继续处理 <code>CONNECT</code> 报文</p><h6 id="3122-协议级别"><a class="markdownIt-Anchor" href="#3122-协议级别"></a> 3.1.2.2 协议级别</h6><p><img src="/2023/04/25/linux/network/mqtt311/204122/connect%E5%8D%8F%E8%AE%AE%E7%BA%A7%E5%88%AB.png" srcset="/img/loading.gif" lazyload alt="connect协议级别.png"></p><p>客户端用 <code>8</code> 位的无符号值表示协议的修订版本, 协议级别目前定义如下:</p><ul><li><code>3</code>: <code>3.1</code> 版协议</li><li><code>4</code>: <code>3.1.1</code> 版协议</li><li><code>5</code>: <code>5.0</code> 版协议</li></ul><p>如果发现不支持的协议级别， 服务端必须给发送一个返回码为<code>0x01</code>（不支持的协议级别） 的 <code>CONNACK</code> 报文响应<code>CONNECT</code> 报文， 然后断开客户端的连接。</p><h6 id="3123-连接标志"><a class="markdownIt-Anchor" href="#3123-连接标志"></a> 3.1.2.3 连接标志</h6><p><img src="/2023/04/25/linux/network/mqtt311/204122/connect%E8%BF%9E%E6%8E%A5%E6%A0%87%E5%BF%97.png" srcset="/img/loading.gif" lazyload alt="connect连接标志.png"></p><p>连接标志字节包含一些用于指定 <code>MQTT</code> 连接行为的参数。它还指出有效载荷中的字段是否存在。服务端必须验证 <code>CONNECT</code> 控制报文的保留标志位（第 <code>0</code> 位） 是否为 <code>0</code>， 如果不为 <code>0</code> 必须断开客户端连接。</p><ul><li><p><strong>Reserved</strong> : 必须为0, 连接时服务器检测到非0将断开连接</p></li><li><p><strong>clean Session:</strong> 清理会话标记<br><strong>位置</strong>： 连接标志字节的第 <code>1</code> 位<br><strong>特点</strong>:</p><ul><li><ol><li>当客户端掉线或者正常断开, 之前客户端订阅的话题被服务器保存, 下次重新连接不需要重新订阅话题(有些客户端能正确接受服务端消息但是不展示，容易引发困惑(如 <code>mqttfx v1.7.1</code>), 可以通过抓包查看)</li></ol></li><li><ol start="2"><li>当订阅的话题<code>QOS1</code>, <code>QOS2</code>级别时, 假如客户端掉线期间, 其他客户端发布了该主题, 服务器将保存该信息, 待下次 客户端连接后, 发布该主题. 确保<code>QOS1</code>, <code>QOS2</code> 级别消息不会被丢失。<code>QOS0</code> 是否不存取决于服务器配置(测试<code>mosquitto_pub v2.0.15</code> 版本也会转发)。</li></ol></li><li><ol start="3"><li>如果<code>clean Session</code>标记为 <code>1</code>, 则每次清理回话信息, 会话仅持续和网络连接相同时间, 及每次需要重新订阅原有的所有主题。</li></ol></li></ul></li><li><p><strong>Will Flag</strong>: 遗嘱标志<br><strong>位置</strong>： 连接标志字节的第 <code>2</code> 位<br><strong>特点</strong>:</p><ul><li><ol><li>当遗嘱标志设置为 <code>1</code> 表示如果连接请求被接受, 遗嘱(<code>will Message</code>)消息必须被存储到服务端, 该客户端网络连接关闭, 服务器必须发布这个遗嘱消息</li></ol></li><li><ol start="2"><li>遗嘱主题是一个和网络相关的主题,当客户端掉线时，服务端发布该遗嘱(发布成功后服务端将删除该遗嘱消息), 注意: 当客户端是主动关闭服务器连接时不发布遗嘱消息, 遗嘱消息随连接关闭被删除。(该类情况可以通过<code>windown</code>杀掉进程来模拟异常情况)</li></ol></li></ul></li><li><p><strong>Will QoS</strong>: 遗嘱的消息级别(<code>QOS0/QOS1/QOS2</code>), 当遗嘱标志为<code>0</code>时必须为<code>0</code></p></li><li><p><strong>Will Retain</strong>: 遗嘱保留(是否当做保留消息处理)<br><strong>位置</strong>： 连接标志字节的第 <code>5</code> 位</p></li></ul><blockquote><p><strong>保留消息</strong>: 服务端必须存储该应用的内容和服务质量等级(<code>QOS</code>), 以便可以分发给未来保留消息主题匹配的订阅者。对每个匹配的主题名，如果存在最近保留的消息， 它必须被发送给这个订阅者。保留消息将由服务端转发给在未来订阅该保留消息的客户端, 一般订阅成功后立即下发)。</p><p><strong>删除保留消息</strong>: 保留消息是不会随着客户端断开连接而删除的, 因此非常考验服务端的性能。客户端发布一个 <code>0</code> 长度的保留消息, 服务端将删除该主题的保留消息。如果发布一个该主题 <code>0</code> 长度的非保留消息(保留标志位<code>0</code>), 服务端不能存储这个消息也不能移除或替换任何现存的保留消息</p></blockquote><ul><li><strong>USER NAME</strong>: 用户名标志</li></ul><blockquote><p>用于连接建立期间向服务端传输认证数据。</p></blockquote><ul><li><strong>PASSWORD FLAG</strong>:</li></ul><blockquote><p>用于连接建立期间向服务端传输认证数据。</p></blockquote><h6 id="3124-保活连接时间"><a class="markdownIt-Anchor" href="#3124-保活连接时间"></a> 3.1.2.4 保活连接时间</h6><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E4%BF%9D%E6%B4%BB%E8%BF%9E%E6%8E%A5%E6%97%B6%E9%97%B42.png" srcset="/img/loading.gif" lazyload alt="保活连接时间2.png"></p><p>保活时间(<code>2Byte</code> 单位秒), 如果服务器在 <code>1.5</code>倍的这个时间还没有收到<code>PINGEQ</code>, 将断开连接, 客户端可以在连接期间任何时间发送<code>PINGEQ</code> 报文。如果保活时间为<code>0</code>, 服务端将不检测客户端是否离线。</p><hr><h5 id="313-有效载荷"><a class="markdownIt-Anchor" href="#313-有效载荷"></a> 3.1.3 有效载荷</h5><p>  <code>CONNECT</code> 报文的有效载荷（<code>payload</code>） 包含一个或多个以长度为前缀的字段，可变报头中的标志决定是否包含这些字段。 如果包含的话， 必须按这个顺序出现：<strong>客户端标识符</strong>， <strong>遗嘱主题</strong>， <strong>遗嘱消息</strong>， <strong>用户名</strong>， <strong>密码</strong>。有效载荷的格式如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E6%A0%BC%E5%BC%8F.png" srcset="/img/loading.gif" lazyload alt="有效载荷格式.png"></p><h6 id="3131-客户端标识符"><a class="markdownIt-Anchor" href="#3131-客户端标识符"></a> 3.1.3.1 客户端标识符</h6><ul><li>服务端使用客户端标识符 (<code>ClientId</code>) 识别客户端。 连接服务端的每个客户端都有唯一的客户端标识符（<code>ClientId</code>） 。客户端和服务端都必须使用 <code>ClientId</code> 识别两者之间的 <code>MQTT</code> 会话相关的状态。</li><li>客户端标识符 (<code>ClientId</code>) 必须存在而且必须是 <code>CONNECT</code> 报文有效载荷的第一个字段</li><li>服务端必须允许 <code>1</code> 到 <code>23</code> 个字节长的 UTF-8 编码的客户端标识符， 客户端标识符只能包含这些字符：<code>0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ</code>（大写字母， 小写字母和数字）, 服务端可以允许编码后超过 <code>23</code> 个字节的客户端标识符 (<code>ClientId</code>)。 服务端可以允许包含不是上面列表字符的客户端标识符 (<code>ClientId</code>)</li><li>客户端标识符必须存在, 但是可以是一个<code>null</code>(0长度的)值, <code>null</code>值是一个特殊的<code>client-id</code>, 届时服务端自动分配一个唯一<code>id</code>给客户端, 并假设客户端提供了唯一<code>id</code>并与其通信, 当<code>cleient-id</code>为<code>null</code>时, 清除会话<br>标志必须为<code>1</code>,否则服务端报<code>0x02</code>报错并关闭连接。 注意: <code>client-id</code>最长<code>23byte</code>。</li></ul><hr><h6 id="3132-遗嘱主题"><a class="markdownIt-Anchor" href="#3132-遗嘱主题"></a> 3.1.3.2 遗嘱主题</h6><ul><li>如果遗嘱标志被设置为 <code>1</code>， 有效载荷的下一个字段是遗嘱主题（<code>Will Topic</code>）</li></ul><h6 id="3133-遗嘱消息"><a class="markdownIt-Anchor" href="#3133-遗嘱消息"></a> 3.1.3.3 遗嘱消息</h6><ul><li>如果遗嘱标志被设置为 <code>1</code>， 有效载荷的下一个字段是遗嘱消息。 遗嘱消息定义了将被发布到遗嘱主题的应用消息</li></ul><h6 id="3134-用户名"><a class="markdownIt-Anchor" href="#3134-用户名"></a> 3.1.3.4 用户名</h6><ul><li>如果用户名（<code>User Name</code>） 标志被设置为 1， 有效载荷的下一个字段就是它, 服务端可以将它用于身份验证和授权。</li></ul><h6 id="3135-密码"><a class="markdownIt-Anchor" href="#3135-密码"></a> 3.1.3.5 密码</h6><ul><li>如果密码（<code>Password</code>） 标志被设置为 <code>1</code>， 有效载荷的下一个字段就是它。密码字段包含一个两字节的长度字段， 长度表示二进制数据的字节数（不包含长度字段本身占用的两个字节） ， 后面跟着 <code>0</code> 到 <code>65535</code> 字节的二进制数据。</li></ul><p>如下是一份<code>CONNECT</code>报文的抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%9C%89%E5%AE%A2%E6%88%B7%E7%AB%AFid-connect%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="有客户端id-connect抓包.png"></p><p>如下是没有<code>client-id</code>的抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%B2%A1%E6%9C%89clientid-connect%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="没有clientid-connect抓包.png"></p><p>注意:</p><ul><li>如果 <code>ClientId</code> 表明客户端已经连接到这个服务端，那么服务端必须断开原有的客户端连接(如果两个相同<code>client-id</code>客户端同一时间上线, 然后又存在重连机制, 会导致两个客户端频繁离上线现象)</li><li>允许客户端在发送 <code>CONNECT</code> 报文之后立即发送其它的控制报文； 客户端不需要等待服务端的 <code>CONNACK</code>报文。 如果服务端拒绝了 <code>CONNECT</code>， 它不能处理客户端在 <code>CONNECT</code> 报文之后发送的任何数据 。</li></ul><hr><h4 id="32-connack"><a class="markdownIt-Anchor" href="#32-connack"></a> 3.2 CONNACK</h4><p>  服务端发送 <code>CONNACK</code> 报文响应从客户端收到的 <code>CONNECT</code> 报文。服务端发送给客户端的第一个报文必须是 <code>CONNACK</code>。</p><p>  如果客户端在合理的时间内没有收到服务端的 <code>CONNACK</code> 报文， 客户端应该关闭网络连接。 合理 的时间取决于应用的类型和通信基础设施。</p><h5 id="321-固定报头"><a class="markdownIt-Anchor" href="#321-固定报头"></a> 3.2.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/connect-ack%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="connect-ack固定报头.png"></p><ul><li>剩余长度字段： 表示可变报头的长度。 对于 <code>CONNACK</code> 报文这个值等于 <code>2</code>。</li></ul><h5 id="322-可变报头"><a class="markdownIt-Anchor" href="#322-可变报头"></a> 3.2.2 可变报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/connect-ack%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4%E6%A0%BC%E5%BC%8F.png" srcset="/img/loading.gif" lazyload alt="connect-ack可变报头格式.png"></p><h6 id="3221-连接确认标志"><a class="markdownIt-Anchor" href="#3221-连接确认标志"></a> 3.2.2.1 连接确认标志</h6><ul><li>第 <code>1</code> 个字节是 连接确认标志， 位 <code>7-1</code> 是保留位且必须设置为 0</li><li>第 <code>0</code> (<code>SP</code>)位 是当前会话（<code>Session Present</code>） 标志</li></ul><blockquote><p><code>connect ack</code>的<code>sp</code>位可以看出服务端是否保存了<code>clientId</code> 的会话, <code>0</code> 表示没保存 <code>1</code>表示保存, 如果客户端和服务端关于会话保存状态的期望不一致, 客户端可以选择断开或者继续会话。</p></blockquote><h6 id="3222-连接返回码"><a class="markdownIt-Anchor" href="#3222-连接返回码"></a> 3.2.2.2 连接返回码</h6><p>  连接返回码字段使用一个字节的无符号值， 如果服务端收到一个合法的 <code>CONNECT</code> 报文， 但出于某些原因无法处理它， 服务端应该尝试发送一个包含非零返回码（表格中的某一个） 的 <code>CONNACK</code> 报文。如果服务端发送了一个包含非零返回码的 <code>CONNACK</code> 报文， 那么它必须关闭网络连接</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E8%BF%9E%E6%8E%A5%E8%BF%94%E5%9B%9E%E7%A0%81%E8%A1%A82.png" srcset="/img/loading.gif" lazyload alt="连接返回码表2.png"></p><p>如果认为上表中的所有连接返回码都不太合适，那么服务端必须关闭网络连接，不需要发送 <code>CONNACK</code> 报文</p><h5 id="323-有效载荷"><a class="markdownIt-Anchor" href="#323-有效载荷"></a> 3.2.3 有效载荷</h5><p><code>CONNACK</code> 报文没有有效载荷。</p><hr><p>数据抓包:<br><img src="/2023/04/25/linux/network/mqtt311/204122/connect-ack%E8%BF%94%E5%9B%9E%E7%A0%81%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="connect-ack返回码抓包.png"></p><hr><h4 id="33-publish"><a class="markdownIt-Anchor" href="#33-publish"></a> 3.3 PUBLISH</h4><p>emsp; <code>PUBLISH</code> 控制报文是指从客户端向服务端或者服务端向客户端传输一个应用消息。为了满足不同场景对数据可靠性的要求, 协议提供了三个服务质量的消息:<code>QOS0/QOS1/QOS2</code>。下面将一一解释。</p><h5 id="331-固定报头"><a class="markdownIt-Anchor" href="#331-固定报头"></a> 3.3.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/public%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="public固定报头.png"></p><h6 id="3311-重发标志"><a class="markdownIt-Anchor" href="#3311-重发标志"></a> 3.3.1.1 重发标志</h6><p><strong>位置：</strong> 第 1 个字节， 第 3 位</p><ul><li>如果 <code>DUP</code> 标志被设置为 <code>0</code>， 表示这是客户端或服务端第一次请求发送这个 <code>PUBLISH</code> 报文。 如果 <code>DUP</code> 标志被设置为 <code>1</code>，表示这可能是一个早前报文请求的重发。</li><li>客户端或服务端请求重发一个 <code>PUBLISH</code> 报文时， 必须将 <code>DUP</code> 标志设置为 <code>1</code> 。 对于 <code>QoS0</code> 的消息， <code>DUP</code> 标志必须设置为 <code>0</code></li></ul><h6 id="3312-服务质量等级"><a class="markdownIt-Anchor" href="#3312-服务质量等级"></a> 3.3.1.2 服务质量等级</h6><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F%E7%AD%89%E7%BA%A7%E5%AE%9A%E4%B9%89.png" srcset="/img/loading.gif" lazyload alt="服务质量等级定义.png"></p><p>通常情况下:</p><ul><li><code>QOS0</code>: 对于一些对可靠性无很高要求的场景(如速度传感器，其采集速度较快, 丢一包也不影响)</li><li><code>QOS1</code>: 需要可靠保证数据到达, 重复接受也无影响(家居中的电器状态上报)</li><li><code>QOS2</code>: 严格要求数据到达的可靠性和次数。(如银行提款额度)</li></ul><p><code>PUBLISH</code> 报文不能将 <code>QoS</code> 所有的位设置为 <code>1</code>。 如果服务端或客户端收到 <code>QoS</code> 所有位都为 <code>1</code> 的 <code>PUBLISH</code>报文， 它必须关闭网络连接</p><h6 id="3313-保留标志"><a class="markdownIt-Anchor" href="#3313-保留标志"></a> 3.3.1.3 保留标志</h6><p>保留标志表示这是一个保留消息。服务端应该保存会话状态。严格上，保留消息是一个发给未来订阅话题客户端的消息。保留消息有如下特性:</p><ul><li>客户端推送保留消息后, 服务端保存消息，并不会关联到会话。</li><li>客户端主动或被动断开连接, 保留消息不会被服务端释放(即使重新<code>CONNECT</code>时清理会话标志被设置), 未来当有客户端订阅该保留消息, 由服务端分发最近一次最新的该话题保留消息。</li><li>删除保留消息必须客户端向该保留消息发送一个消息内容为<code>0</code>的保留消息。</li></ul><h6 id="3314-剩余长度字段"><a class="markdownIt-Anchor" href="#3314-剩余长度字段"></a> 3.3.1.4 剩余长度字段</h6><p>等于可变报头的长度加上有效载荷的长度</p><hr><h5 id="332-可变报头"><a class="markdownIt-Anchor" href="#332-可变报头"></a> 3.3.2 可变报头</h5><p>可变报头按顺序包含主题名和报文标识符, 格式如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/publish%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4%E9%9D%9E%E8%A7%84%E8%8C%83%E7%A4%BA%E4%BE%8B.png" srcset="/img/loading.gif" lazyload alt="publish报文可变报头非规范示例.png"></p><ul><li><code>Length</code>: 主题长度</li><li><code>a/b</code>: 示例的主题名称, 可以是任意字符串, 注意字符串不能含有协议禁止字符。</li><li>标识符：标识报文的唯一性</li></ul><blockquote><p>只有当 <code>QoS</code> 等级是 <code>1</code> 或 <code>2</code> 时，报文标识符（<code>Packet Identifier</code>） 字段才能出现在 <code>PUBLISH</code> 报文中, 且服务端回复的<code>ack</code>报文必须包含相同报文标识符。</p></blockquote><hr><h5 id="333-有效载荷"><a class="markdownIt-Anchor" href="#333-有效载荷"></a> 3.3.3 有效载荷</h5><p>  有效载荷包含将被发布的应用消息。 数据的内容和格式是应用特定的。 有效载荷的长度计算：用固定报头中的剩余长度字段的值减去可变报头的长度。 包含零长度有效载荷的 <code>PUBLISH</code> 报文是合法的</p><h5 id="334-响应"><a class="markdownIt-Anchor" href="#334-响应"></a> 3.3.4 响应</h5><p>  <code>PUBLISH</code> 报文的接收者必须按照根据 <code>PUBLISH</code> 报文中的 <code>QoS</code> 等级发送响应</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/publish%E6%8A%A5%E6%96%87%E9%A2%84%E6%9C%9F%E5%93%8D%E5%BA%94.png" srcset="/img/loading.gif" lazyload alt="publish报文预期响应.png"></p><ul><li>客户端使用 <code>PUBLISH</code> 报文发送应用消息给服务端， 目的是分发到其它订阅匹配的客户端</li><li>服务端使用 <code>PUBLISH</code> 报文发送应用消息给每一个订阅匹配的客户端。</li><li>服务端转发到设备端的消息质量, 应该是原始消息<code>QOS</code>等级和服务端订阅时授予的<code>QOS</code>等级中最小值。(如果原始消息的 <code>QoS</code> 是 1 而被授予的最大 <code>QoS</code> 是 0, 那么转发的消息服务质量等级为<code>0</code>)</li><li><code>MQTT</code>消息推送需要注意避免消息体中出现非法的字符, 因此一般需要将消息体进行<code>base64</code>编码以后传输。</li></ul><p>实际抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/publish%E6%8A%A5%E6%96%87%E6%8E%A8%E9%80%81%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="publish报文推送抓包.png"></p><hr><h4 id="34-puback"><a class="markdownIt-Anchor" href="#34-puback"></a> 3.4 PUBACK</h4><p><code>PUBACK</code> 报文是对 <code>QoS 1</code> 等级的 <code>PUBLISH</code> 报文的响应, 其交互逻辑如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/publish-qos1%E6%B6%88%E6%81%AF%E4%BA%A4%E4%BA%92%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="publish-qos1消息交互抓包.png"></p><h5 id="341-固定报头"><a class="markdownIt-Anchor" href="#341-固定报头"></a> 3.4.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/puback%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="puback报文固定报头.png"></p><ul><li>剩余长度字段： 表示可变报头的长度。对 <code>PUBACK</code> 报文这个值等于 <code>2</code></li></ul><h5 id="342-可变报头"><a class="markdownIt-Anchor" href="#342-可变报头"></a> 3.4.2 可变报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/puback%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="puback可变报头.png"></p><h5 id="343-有效载荷"><a class="markdownIt-Anchor" href="#343-有效载荷"></a> 3.4.3 有效载荷</h5><p><code>PUBACK</code> 报文没有有效载荷</p><p><strong>报文抓包</strong></p><p><img src="/2023/04/25/linux/network/mqtt311/204122/puback%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="puback报文抓包.png"></p><hr><h4 id="35-pubrec"><a class="markdownIt-Anchor" href="#35-pubrec"></a> 3.5 PUBREC</h4><p>  <code>PUBREC</code> 报文是对 <code>QoS</code> 等级 <code>2</code> 的 <code>PUBLISH</code> 报文的响应。它是 <code>QoS 2</code> 等级协议交换的第二个报文, 其交互逻辑抓包如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/publish-qos2%E4%BA%A4%E4%BA%92%E9%80%BB%E8%BE%91%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="publish-qos2交互逻辑抓包.png"></p><h5 id="351-固定报头"><a class="markdownIt-Anchor" href="#351-固定报头"></a> 3.5.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubrec%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pubrec报文固定报头.png"></p><ul><li>剩余长度字段: 表示可变报头的长度。 对 <code>PUBREC</code> 报文它的值等于 <code>2</code></li></ul><h5 id="352-可变报头"><a class="markdownIt-Anchor" href="#352-可变报头"></a> 3.5.2 可变报头</h5><p>可变报头包含等待确认的 <code>PUBLISH</code> 报文的报文标识符</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubrec%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pubrec报文可变报头.png"></p><h5 id="353-有效载荷"><a class="markdownIt-Anchor" href="#353-有效载荷"></a> 3.5.3 有效载荷</h5><p><code>PUBREC</code> 报文没有有效载荷</p><p>正常抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubrec%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="pubrec报文抓包.png"></p><hr><h4 id="36-pubrel"><a class="markdownIt-Anchor" href="#36-pubrel"></a> 3.6 PUBREL</h4><p>  <code>PUBREL</code> 报文是对 <code>PUBREC</code> 报文的响应。 它是 <code>QoS 2</code> 等级协议交换的第三个报文</p><h5 id="361-固定报头"><a class="markdownIt-Anchor" href="#361-固定报头"></a> 3.6.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubrel%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pubrel固定报头.png"></p><p><code>PUBREL</code> 控制报文固定报头的第 <code>3,2,1,0</code> 位是保留位， 必须被设置为 <code>0,0,1,0</code>。 服务端必须将其它的任何值都当做是不合法的并关闭网络连接</p><ul><li>剩余长度字段：表示可变报头的长度。 对 <code>PUBREL</code> 报文这个值等于 <code>2</code></li></ul><h5 id="362-可变报头"><a class="markdownIt-Anchor" href="#362-可变报头"></a> 3.6.2 可变报头</h5><p>  可变报头包含与等待确认的 <code>PUBREC</code> 报文相同的报文标识符</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubrel%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pubrel报文可变报头.png"></p><h5 id="363-有效载荷"><a class="markdownIt-Anchor" href="#363-有效载荷"></a> 3.6.3 有效载荷</h5><p><code>PUBREL</code> 报文没有有效载荷。</p><p>正常抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubrec%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85%E5%9B%BE.png" srcset="/img/loading.gif" lazyload alt="pubrec报文抓包图.png"></p><hr><h4 id="37-pubcomp"><a class="markdownIt-Anchor" href="#37-pubcomp"></a> 3.7 PUBCOMP</h4><p>  <code>PUBCOMP</code> 报文是对 <code>PUBREL</code> 报文的响应。 它是 <code>QoS 2</code> 等级协议交换的第四个也是最后一个报文。</p><h5 id="371-固定报头"><a class="markdownIt-Anchor" href="#371-固定报头"></a> 3.7.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubcomp%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pubcomp报文固定报头.png"></p><ul><li>剩余长度字段： 表示可变报头的长度。 对 <code>PUBCOMP</code> 报文这个值等于 <code>2</code></li></ul><h5 id="372-可变报头"><a class="markdownIt-Anchor" href="#372-可变报头"></a> 3.7.2 可变报头</h5><p>可变报头包含与等待确认的 <code>PUBREL</code> 报文相同的报文标识符</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubcomp%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pubcomp报文可变报头.png"></p><h5 id="373-有效载荷"><a class="markdownIt-Anchor" href="#373-有效载荷"></a> 3.7.3 有效载荷</h5><p><code>PUBCOMP</code> 报文没有有效载荷</p><p>正常抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pubcomp%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="pubcomp报文抓包.png"></p><hr><h4 id="38-subscribe"><a class="markdownIt-Anchor" href="#38-subscribe"></a> 3.8 SUBSCRIBE</h4><p>  客户端向服务端发送 <code>SUBSCRIBE</code> 报文用于创建一个或多个订阅。 每个订阅注册客户端关心的一个或多个主题。 为了将应用消息转发给与那些订阅匹配的主题， 服务端发送 <code>PUBLISH</code> 报文给客户端。 <code>SUBSCRIBE</code>报文也（为每个订阅） 指定了最大的 <code>QoS</code> 等级， 服务端根据这个发送应用消息给客户端(实际服务端转发的<code>QOS</code>是订阅话题的<code>QOS</code>和消息推送客户端推送<code>QOS</code>中小的那个)</p><h5 id="381-固定报头"><a class="markdownIt-Anchor" href="#381-固定报头"></a> 3.8.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/subscribe%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="subscribe固定报头.png"></p><p><code>SUBSCRIBE</code> 控制报固定报头的第 <code>3,2,1,0</code> 位是保留位， 必须分别设置为 <code>0,0,1,0</code>。 服务端必须将其它的任何值都当做是不合法的并关闭网络连接</p><ul><li>剩余长度字段: 等于可变报头的长度（<code>2</code> 字节） 加上有效载荷的长度</li></ul><h5 id="382-可变报头"><a class="markdownIt-Anchor" href="#382-可变报头"></a> 3.8.2 可变报头</h5><p>可变报头包含客户端标识符。</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/subscribe%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="subscribe可变报头.png"></p><p>图示显示, 报文标识符是<code>10</code>。</p><h5 id="383-有效载荷"><a class="markdownIt-Anchor" href="#383-有效载荷"></a> 3.8.3 有效载荷</h5><p>  <code>SUBSCRIBE</code> 报文的有效载荷包含了一个主题过滤器列表， 它们表示客户端想要订阅的主题, 服务端应该支持包含通配符的主题过滤器。 如果服务端选择不支持包含通配符的主题过滤器， 必须拒绝任何包含通配符过滤器的订阅请求。</p><p>  每一个过滤器后面跟着一个字节， 这个字节被叫做 服务质量要求（<code>Requested QoS</code>） 。它给出了服务端向客户端发送应用消息所允许的最大 <code>QoS</code> 等级。<code>SUBSCRIBE</code> 报文的有效载荷必须包含至少一对主题过滤器 和 <code>QoS</code> 等级字段组合。没有有效载荷的 <code>SUBSCRIBE</code> 报文是违反协议的</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/subscribe%E6%8A%A5%E6%96%87%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E6%A0%BC%E5%BC%8F.png" srcset="/img/loading.gif" lazyload alt="subscribe报文有效载荷格式.png"></p><p>当前版本的协议没有用到服务质量要求（<code>Requested QoS</code>） 字节的高六位。 如果有效载荷中的任何位是非零值， 或者 <code>QoS</code> 不等于 <code>0,1</code> 或 <code>2</code>， 服务端必须认为 <code>SUBSCRIBE</code> 报文是不合法的并关闭网络连接</p><p><strong>示例</strong>:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/subscribe%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E9%9D%9E%E8%A7%84%E8%8C%83%E7%A4%BA%E4%BE%8B.png" srcset="/img/loading.gif" lazyload alt="subscribe有效载荷非规范示例.png"></p><p>数据格式如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/subscribe%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E5%AD%97%E8%8A%82%E6%A0%BC%E5%BC%8F%E7%A4%BA%E4%BE%8B.png" srcset="/img/loading.gif" lazyload alt="subscribe有效载荷字节格式示例.png"></p><h5 id="384-响应"><a class="markdownIt-Anchor" href="#384-响应"></a> 3.8.4 响应</h5><p>  服务端收到客户端发送的一个 <code>SUBSCRIBE</code> 报文时， 必须使用 <code>SUBACK</code> 报文响应, <code>SUBACK</code> 报文必须和等待确认的 <code>SUBSCRIBE</code> 报文有相同的报文标识符</p><p>  如果服务端收到一个 <code>SUBSCRIBE</code> 报文， 报文的主题过滤器与一个现存订阅的主题过滤器相同， 那么必须使用新的订阅彻底替换现存的订阅。新订阅的主题过滤器和之前订阅的相同， 但是它的最大 <code>QoS</code> 值可以不同。 与这个主题过滤器匹配的任何现存的保留消息必须被重发， 但是发布流程不能中断</p><p>  如果服务端收到包含多个主题过滤器的 <code>SUBSCRIBE</code> 报文， 它必须如同收到了一系列的多个 <code>SUBSCRIBE</code>报文一样处理那个， 除了需要将它们的响应合并到一个单独的 <code>SUBACK</code> 报文发送.</p><p>正常抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/subscribe%E8%AE%A2%E9%98%85%E8%AF%9D%E9%A2%98%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="subscribe订阅话题抓包.png"></p><p>可以一次订阅多个话题:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/subcribe%E8%AE%A2%E9%98%85%E5%A4%9A%E4%B8%AA%E8%AF%9D%E9%A2%98.png" srcset="/img/loading.gif" lazyload alt="subcribe订阅多个话题.png"></p><hr><h4 id="39-suback"><a class="markdownIt-Anchor" href="#39-suback"></a> 3.9 SUBACK</h4><p>  服务端发送 <code>SUBACK</code> 报文给客户端， 用于确认它已收到并且正在处理<code>SUBSCRIBE</code> 报文, <code>SUBACK</code> 报文包含一个返回码清单， 它们指定了 <code>SUBSCRIBE</code> 请求的每个订阅被授予的最大 <code>QoS</code> 等级。</p><h5 id="391-固定报头"><a class="markdownIt-Anchor" href="#391-固定报头"></a> 3.9.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/suback%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="suback固定报头.png"></p><ul><li>剩余长度字段: 等于可变报头的长度加上有效载荷的长度</li></ul><h5 id="392-可变报头"><a class="markdownIt-Anchor" href="#392-可变报头"></a> 3.9.2 可变报头</h5><p>可变报头包含等待确认的 <code>SUBSCRIBE</code> 报文的报文标识符</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/suback%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="suback报文可变报头.png"></p><h5 id="393-有效载荷"><a class="markdownIt-Anchor" href="#393-有效载荷"></a> 3.9.3 有效载荷</h5><p>  有效载荷包含一个返回码清单。 每个返回码对应等待确认的 <code>SUBSCRIBE</code> 报文中的一个主题过滤器。返回码的顺序必须和 <code>SUBSCRIBE</code> 报文中主题过滤器的顺序相同</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/suback%E6%8A%A5%E6%96%87%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E6%A0%BC%E5%BC%8F.png" srcset="/img/loading.gif" lazyload alt="suback报文有效载荷格式.png"></p><p>允许返回码值:</p><ul><li><code>0x00</code>: 最大<code>QOS 0</code></li><li><code>0X01</code>: 成功 - 最大<code>QOS 1</code></li><li><code>0X02</code>: 成功 - 最大<code>QOS 2</code></li><li><code>0X80</code>: <code>Failure</code> 失败</li></ul><p><code>0x00, 0x01, 0x02, 0x80</code> 之外的 <code>SUBACK</code> 返回码是保留的， 不能使用。</p><p>如果是一次订阅多个话题, 返回码也必须合并, 如下:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E7%9B%B4%E6%8E%A5%E6%A0%BC%E5%BC%8F%E9%9D%9E%E8%A7%84%E8%8C%83%E7%A4%BA%E4%BE%8B.png" srcset="/img/loading.gif" lazyload alt="有效载荷直接格式非规范示例.png"></p><p>相关抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/suback%E5%A4%9A%E4%B8%AA%E8%AE%A2%E9%98%85%E5%9B%9E%E5%A4%8D.png" srcset="/img/loading.gif" lazyload alt="suback多个订阅回复.png"></p><hr><h4 id="310-unsubscribe"><a class="markdownIt-Anchor" href="#310-unsubscribe"></a> 3.10 UNSUBSCRIBE</h4><p>  客户端发送 <code>UNSUBSCRIBE</code> 报文给服务端， 用于取消订阅主题</p><h5 id="3101-固定报头"><a class="markdownIt-Anchor" href="#3101-固定报头"></a> 3.10.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/unsubscribe%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="unsubscribe报文固定报头.png"></p><p><code>UNSUBSCRIBE</code> 报文固定报头的第 <code>3,2,1,0</code> 位是保留位且必须分别设置为 <code>0,0,1,0</code>。 服务端必须认为任何其它的值都是不合法的并关闭网络连接。</p><ul><li>剩余长度字段: 等于可变报头的长度加上有效载荷的长度</li></ul><h5 id="3102-可变报头"><a class="markdownIt-Anchor" href="#3102-可变报头"></a> 3.10.2 可变报头</h5><p>可变报头包含一个报文标识符</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/unsubscribe%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="unsubscribe报文可变报头.png"></p><h5 id="3103-有效载荷"><a class="markdownIt-Anchor" href="#3103-有效载荷"></a> 3.10.3 有效载荷</h5><p>  <code>UNSUBSCRIBE</code> 报文的有效载荷包含客户端想要取消订阅的主题过滤器列表。 <code>UNSUBSCRIBE</code> 报文中的主题过滤器必须是连续打包的。<code>UNSUBSCRIBE</code> 报文的有效载荷必须至少包含一个消息过滤器。 没有有效载荷的 <code>UNSUBSCRIBE</code> 报文是违反协议的。</p><p>示例:</p><ul><li>如果需要<code>unsubscribe</code>话题<code>a/b</code>, <code>c/d</code>, 那么字节格式如下:</li></ul><p><img src="/2023/04/25/linux/network/mqtt311/204122/unsubcribe%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E7%9B%B4%E6%8E%A5%E6%A0%BC%E5%BC%8F%E7%A4%BA%E4%BE%8B.png" srcset="/img/loading.gif" lazyload alt="unsubcribe有效载荷直接格式示例.png"></p><h5 id="3104-响应"><a class="markdownIt-Anchor" href="#3104-响应"></a> 3.10.4 响应</h5><p>  <code>UNSUBSCRIBE</code> 报文提供的主题过滤器（无论是否包含通配符） 必须与服务端持有的这个客户端的当前主题过滤器集合逐个字符比较。如果有任何过滤器完全匹配， 那么它（服务端） 自己的订阅将被删除， 否则不会有进一步的处理</p><p>如果服务端删除了一个订阅：</p><ul><li>它必须停止分发任何新消息给这个客户端</li><li>它必须完成分发任何已经开始往客户端发送的 <code>QoS 1</code> 和 <code>QoS 2</code> 的消息</li><li>它可以继续发送任何现存的准备分发给客户端的缓存消息</li></ul><p>抓包示例:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/unsubscribe%E5%8F%96%E6%B6%88%E5%A4%9A%E4%B8%AA%E8%AE%A2%E9%98%85%E8%AF%9D%E9%A2%98%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="unsubscribe取消多个订阅话题抓包.png"></p><p>注意这里是有两个<code>mqtt</code>固定头部的。</p><hr><h4 id="311-unsuback"><a class="markdownIt-Anchor" href="#311-unsuback"></a> 3.11 UNSUBACK</h4><p>  服务端发送 <code>UNSUBACK</code> 报文给客户端用于确认收到 <code>UNSUBSCRIBE</code> 报文。</p><h5 id="3111-固定报头"><a class="markdownIt-Anchor" href="#3111-固定报头"></a> 3.11.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/unsuback%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="unsuback固定报头.png"></p><ul><li>剩余长度字段： 表示可变报头的长度， 对 <code>UNSUBACK</code> 报文这个值等于 <code>2</code></li></ul><h5 id="3112-可变报头"><a class="markdownIt-Anchor" href="#3112-可变报头"></a> 3.11.2 可变报头</h5><p>可变报头包含等待确认的 <code>UNSUBSCRIBE</code> 报文的报文标识符。</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/unsuback%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="unsuback报文可变报头.png"></p><h5 id="3113-有效载荷"><a class="markdownIt-Anchor" href="#3113-有效载荷"></a> 3.11.3 有效载荷</h5><p><code>UNSUBACK</code> 报文没有有效载荷</p><p>相关抓包:<br><img src="/2023/04/25/linux/network/mqtt311/204122/unsuback%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="unsuback报文抓包.png"></p><hr><h4 id="312-pingreq"><a class="markdownIt-Anchor" href="#312-pingreq"></a> 3.12 PINGREQ</h4><p>  客户端发送 <code>PINGREQ</code> 报文给服务端的用于:</p><ul><li>在没有任何其它控制报文从客户端发给服务的时，告知服务端客户端还活着</li><li>请求服务端发送 响应确认它还活着</li><li>使用网络以确认网络连接没有断开</li></ul><p>保持连接（<code>Keep Alive</code>） 处理中用到这个报文</p><h5 id="3121-固定报头"><a class="markdownIt-Anchor" href="#3121-固定报头"></a> 3.12.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/pingreq%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pingreq报文固定报头.png"></p><h5 id="3122-可变报头"><a class="markdownIt-Anchor" href="#3122-可变报头"></a> 3.12.2 可变报头</h5><p><code>PINGREQ</code> 报文没有可变报头</p><h5 id="3123-有效载荷"><a class="markdownIt-Anchor" href="#3123-有效载荷"></a> 3.12.3 有效载荷</h5><p><code>PINGREQ</code> 报文没有有效载荷</p><h5 id="3124-响应"><a class="markdownIt-Anchor" href="#3124-响应"></a> 3.12.4 响应</h5><p>服务端必须发送 <code>PINGRESP</code> 报文响应客户端的 <code>PINGREQ</code> 报文</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pingreq%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="pingreq报文抓包.png"></p><hr><h4 id="313-pingresp"><a class="markdownIt-Anchor" href="#313-pingresp"></a> 3.13 PINGRESP</h4><p>  服务端发送 <code>PINGRESP</code> 报文响应客户端的 <code>PINGREQ</code> 报文。 表示服务端还活着。 保持连接（<code>Keep Alive</code>） 处理中用到这个报文。</p><h5 id="3131-固定报头"><a class="markdownIt-Anchor" href="#3131-固定报头"></a> 3.13.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/pingresp%E6%8A%A5%E6%96%87%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="pingresp报文固定报头.png"></p><h5 id="3132-可变报头"><a class="markdownIt-Anchor" href="#3132-可变报头"></a> 3.13.2 可变报头</h5><p><code>PINGRESP</code> 报文没有可变报头</p><h5 id="3133-有效载荷"><a class="markdownIt-Anchor" href="#3133-有效载荷"></a> 3.13.3 有效载荷</h5><p><code>PINGRESP</code> 报文没有有效载荷</p><p>数据抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/pingresp%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="pingresp报文抓包.png"></p><hr><h4 id="314-disconnect"><a class="markdownIt-Anchor" href="#314-disconnect"></a> 3.14 DISCONNECT</h4><p>  <code>DISCONNECT</code> 报文是客户端发给服务端的最后一个控制报文。表示客户端正常断开连接</p><h5 id="3141-固定报头"><a class="markdownIt-Anchor" href="#3141-固定报头"></a> 3.14.1 固定报头</h5><p><img src="/2023/04/25/linux/network/mqtt311/204122/disconnect%E5%9B%BA%E5%AE%9A%E6%8A%A5%E5%A4%B4.png" srcset="/img/loading.gif" lazyload alt="disconnect固定报头.png"></p><p>服务端必须验证所有的保留位都被设置为 <code>0</code>， 如果它们不为 <code>0</code> 必须断开连接</p><h5 id="3142-可变报头"><a class="markdownIt-Anchor" href="#3142-可变报头"></a> 3.14.2 可变报头</h5><p><code>DISCONNECT</code> 报文没有可变报头</p><h5 id="3143-有效载荷"><a class="markdownIt-Anchor" href="#3143-有效载荷"></a> 3.14.3 有效载荷</h5><p><code>DISCONNECT</code> 报文没有有效载荷</p><h5 id="3144-响应"><a class="markdownIt-Anchor" href="#3144-响应"></a> 3.14.4 响应</h5><p>客户端发送 <code>DISCONNECT</code> 报文之后：</p><ul><li>必须关闭网络连接</li><li>不能通过那个网络连接再发送任何控制报文</li></ul><p>服务端在收到 <code>DISCONNECT</code> 报文时:</p><ul><li>必须丢弃任何与当前连接关联的未发布的遗嘱消息</li><li>应该关闭网络连接， 如果客户端 还没有这么做</li></ul><p>相关抓包:</p><p><img src="/2023/04/25/linux/network/mqtt311/204122/disconnect%E6%8A%A5%E6%96%87%E6%8A%93%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="disconnect报文抓包.png"></p><hr><h3 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h3><ul><li><a target="_blank" rel="noopener" href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/">MQTT协议中文版</a></li><li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html">MQTT Version 3.1.1</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" class="category-chain-item">网络协议</a> <span>></span> <a href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/MQTT/" class="category-chain-item">MQTT</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a> <a href="/tags/TCPIP/">#TCPIP</a> <a href="/tags/MQTT/">#MQTT</a></div></div><div class="license-box my-3"><div class="license-title"><div>mqtt3.1.1协议详解</div><div>http://example.com/2023/04/25/linux/network/mqtt311/204122/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年4月25日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年3月5日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/05/05/plantuml/demo/205138/" title="plantuml相关语法测试"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">plantuml相关语法测试</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/04/18/linux/network/mqtt/223003/" title="mosquitto源码编译安装和使用"><span class="hidden-mobile">mosquitto源码编译安装和使用</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>