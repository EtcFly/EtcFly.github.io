<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="EtcFly"><meta name="keywords" content=""><meta name="description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介    TFTP是一种简单的同步文件传输协议, 于 1981 年首次标准化， 默认端口69. 由于其设计简单，TFTP可以使用很少代码来实现，这导致其在嵌入式设备上使用及其广泛。相反, 在pc机上, tftp已经很少使用，这主要归咎于"><meta property="og:type" content="article"><meta property="og:title" content="tftp协议分析"><meta property="og:url" content="http://example.com/2024/09/08/linux/tftserver/protocol/220626/"><meta property="og:site_name" content="仗剑走天涯"><meta property="og:description" content="版权归作者所有, 转载请保留该部分声明。本文作者：EtcFly原文地址：https:&#x2F;&#x2F;etcfly.top              简介    TFTP是一种简单的同步文件传输协议, 于 1981 年首次标准化， 默认端口69. 由于其设计简单，TFTP可以使用很少代码来实现，这导致其在嵌入式设备上使用及其广泛。相反, 在pc机上, tftp已经很少使用，这主要归咎于"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/linux.png"><meta property="article:published_time" content="2024-09-08T22:05:26.000Z"><meta property="article:modified_time" content="2024-11-04T12:54:27.597Z"><meta property="article:author" content="EtcFly"><meta property="article:tag" content="原创 - tftp"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/linux.png"><title>tftp协议分析 仗剑走天涯</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:4},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"3AEufnWAJdp8cFODp1DXvrQU-MdYXbMMI",app_key:"mGJiL6xVvYv21ygqfynJoCyO",server_url:null,path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Strive For Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="tftp协议分析"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-09-08 22:05" pubdate>2024年9月8日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6.7k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 56 分钟 </span><span id="vvdpost_container_page_pvuv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="vvdpost_value_page_pv">0</span> 次&nbsp&nbsp <i class="iconfont icon-users" aria-hidden="true"></i> <span id="vvdpost_value_page_uv">0</span> 人</span><script>console.log(window.location.pathname);var httpRequest=new XMLHttpRequest;httpRequest.open("POST","https://etcfly.top:14200/poststats",!0),httpRequest.setRequestHeader("Content-type","application/json"),httpRequest.send(JSON.stringify(window.location.pathname)),httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState&&200==httpRequest.status){var e=httpRequest.responseText,t=JSON.parse(e);console.log(t.pv);var o=document.querySelector("#vvdpost_container_page_pvuv");if(console.log(o),o){var n=document.querySelector("#vvdpost_value_page_pv");console.log(n);var s=document.querySelector("#vvdpost_value_page_uv");console.log(s),s&&s&&(n.innerText=t.pv,s.innerText=t.uv,o.style.display="inline")}}}</script></div></div></div></div></div></div><script async src="https://etcfly.top:14100/script.js" data-website-id="1a5c096d-21e5-4556-99b0-28c810c9c868"></script></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">tftp协议分析</h1><p class="note note-info">本文最后更新于：2024年11月4日 下午</p><div class="markdown-body"><div class="note note-success"><p>版权归作者所有, 转载请保留该部分声明。<br>本文作者：EtcFly<br>原文地址：<a target="_blank" rel="noopener" href="https://etcfly.top">https://etcfly.top</a></p></div><hr><h4 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h4><p>   TFTP是一种简单的同步文件传输协议, 于 1981 年首次标准化， 默认端口<code>69</code>. 由于其设计简单，TFTP可以使用很少代码来实现，这导致其在嵌入式设备上使用及其广泛。相反, 在pc机上, tftp已经很少使用，这主要归咎于tftp协议采用明文传输，安全性不高。这里讨论<code>tftp</code>协议主要是最近开发某些芯片平台固件时, 由于原厂烧录工具的低效，固在应用自己开发了一个tftp服务端，下面将对相关协议交互进行详细分析。</p><hr><h4 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h4><h5 id="rrqwrq"><a class="markdownIt-Anchor" href="#rrqwrq"></a> RRQ/WRQ</h5><p>  tftp协议目前对应最新的是<code>RFC 1350</code>, 目前主要支持如下操作:</p><ul><li>opcode operation<ul><li>1 Read request (RRQ)</li><li>2 Write request (WRQ)</li><li>3 Data (DATA)</li><li>4 Acknowledgment (ACK)</li><li>5 Error (ERROR)</li></ul></li></ul><p>这些操作对应不同的数据包格式, 其中<code>TFTP</code>最基础的协议格式如下, 定义了最基础的TFTP读/写报文格式:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">2</span> bytes     <span class="hljs-built_in">string</span>    <span class="hljs-number">1</span> byte     <span class="hljs-built_in">string</span>   <span class="hljs-number">1</span> byte<br>------------------------------------------------<br>| Opcode |  Filename  |   <span class="hljs-number">0</span>  |    Mode    |   <span class="hljs-number">0</span>  |<br>------------------------------------------------<br><br>           Figure <span class="hljs-number">5</span><span class="hljs-number">-1</span>: RRQ/WRQ packet<br></code></pre></td></tr></table></figure><p>这里<code>Opcode</code>值为</p><ul><li>1: RRQ(read)</li><li>2: WRQ(write)</li></ul><p>fileName: 需要传输的文件名, 采用<code>string</code>字符串<br>Mode: 约定传输的模式, 有三种</p><ul><li>netascii: 采用acsii传输, 主要用于传输文本文件。</li></ul><blockquote><p><strong>特点</strong>：Netascii 模式是一种文本传输模式，它将文本文件中的回车符（CR）和换行符（LF）转换为网络标准的换行符（CRLF）。<br><strong>用途</strong>：主要用于在不同操作系统之间传输文本文件，确保文本文件在接收端的换行符格式正确。<br><strong>适用范围</strong>：适用于传输 ASCII 文本文件，如配置文件、脚本等。</p></blockquote><ul><li>octet: 这种模式用于传输二进制文件，如图片、音频、视频文件等。</li></ul><blockquote><p><strong>特点</strong>：Octet 模式是一种二进制传输模式，直接将文件以原始的字节流进行传输，不做任何格式转换。<br><strong>用途</strong>：适用于传输二进制文件，如可执行文件、图片、音视频文件等，不对文件内容进行任何修改。<br><strong>适用范围</strong>：适用于二进制文件的传输，保留文件的原始格式和内容。</p></blockquote><ul><li>mail: 这种模式用于通过TFTP发送电子邮件</li></ul><blockquote><p><strong>特点</strong>：Mail 模式类似于 Netascii模式，但在传输文件时会将每行的空字符（NULL）转换为回车符（CR）和换行符（LF）。<br><strong>用途</strong>：用于传输邮件文本文件，确保邮件文件在接收端的换行符格式正确。<br><strong>适用范围</strong>：适用于邮件文本文件的传输，保留邮件文本的格式。</p></blockquote><p><strong>备注</strong>:</p><blockquote><p>如果是<code>WRQ</code>, 会携带<code>tsize=xxx</code>属性, <code>tsize</code>指示写入的文件大小, 如果是<code>RRQ</code>, <code>tsize=0</code></p></blockquote><p>这些字符串都是以<code>\0</code>结尾, 这样设计的主要原因是避免解析字符串的时候越界。以上属于比较基础的格式, 但是随着<code>TFTP</code>协议的使用, 开发者发现在不同设备之间传输数据时, 某些设备资源紧缺, 每一包数据不能太大, 而某些设备资源丰富, 如果数据包太小会导致传输效率下降, 因此有了一系列的扩展属性。扩展的报文格式兼容基本的格式。定义如下:</p><p>扩展格式:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">+---------+---~~---+---+---~~---+---+---~~---+---+---~~---+---+---------+---+---~~---+---+<br>|  opcode |filename| <span class="hljs-number">0</span> |  mode  | <span class="hljs-number">0</span> |  opt1  | <span class="hljs-number">0</span> | value1 | <span class="hljs-number">0</span> |  optN   | <span class="hljs-number">0</span> | valueN | <span class="hljs-number">0</span> |<br>+---------+---~~---+---+---~~---+---+---~~---+---+---~~---+---+---------+---+---~~---+---+<br>                                Figure <span class="hljs-number">5</span><span class="hljs-number">-2</span>: EXT RRQ/WRQ packet<br></code></pre></td></tr></table></figure><p>其中<code>opcode</code>, <code>filename</code>, <code>mode</code>定义一致, 但是在其后可以携带一系列的扩展属性。但是得保证总得数据包长度小于512 Byte。属性字段以<code>key/value</code>的形式附带在其后，并且都是<code>string</code>格式存在。</p><ul><li>opt1: 选项名, 不区分大小写的字符串</li><li>value1: 属性值</li></ul><h5 id="ack"><a class="markdownIt-Anchor" href="#ack"></a> ACK</h5><p>正常情况下, 当发送或者接受到<code>5-1</code>数据包时, 会对其进行响应。这里分为两种, 当接受到<code>WRQ</code>请求时, 如果请求合法, 需要以<code>ACK</code>数据包进行回复。<code>ACK</code>数据包如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-number">2</span> bytes     <span class="hljs-number">2</span> bytes<br> ---------------------<br>| Opcode |   Block #  |<br> ---------------------<br><br> Figure <span class="hljs-number">5</span><span class="hljs-number">-3</span>: ACK packet<br></code></pre></td></tr></table></figure><p>其中<code>opcode</code>值为4表示<code>ACK</code>, <code>Block</code>是需要确认的块号。如果是接受到<code>WRQ</code>请求(不携带扩展属性), 那么以<code>Block</code>值为0的 数据包回复。如果是接受到<code>DATA</code>数据包，确认的<code>Block</code>号应该为需要确认的<code>DATA</code>数据包的块号。当完成了确认号, 发起<code>WRQ</code>的一端会以块号为1发起<code>DATA</code>传输，以后每次传输的块号都以前一次对端确认的块号值+1，作为下一次数据的块号, 并携带对应的数据。<code>DATA</code>格式如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-number">2</span> bytes     <span class="hljs-number">2</span> bytes      n bytes<br> ----------------------------------<br>| Opcode |   Block #  |   Data     |<br> ----------------------------------<br><br>      Figure <span class="hljs-number">5</span><span class="hljs-number">-4</span>: DATA packet<br></code></pre></td></tr></table></figure><ul><li>opcode: 默认为3表示数据类型</li><li>Block Number: 块号</li><li>Data: 数据(如果数据非满数据包, 则认为是最后一包数据, 默认一包数据512Byte, 也就是(0-511)认为传输结束)</li></ul><h5 id="error"><a class="markdownIt-Anchor" href="#error"></a> ERROR</h5><p>当然, 数据交互过程中可能会出错, 或者对端不支持该操作, 那么还需要<code>ERROR</code>数据包, 格式如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-number">2</span> bytes     <span class="hljs-number">2</span> bytes      <span class="hljs-built_in">string</span>    <span class="hljs-number">1</span> byte<br>-----------------------------------------<br>| Opcode |  ErrorCode |   ErrMsg   |   <span class="hljs-number">0</span>  |<br>-----------------------------------------<br><br>        Figure <span class="hljs-number">5</span><span class="hljs-number">-5</span>: ERROR packet<br></code></pre></td></tr></table></figure><p>其中<code>opcode</code>值为5, errcode定义的错误码如下表:<br>错误代码:</p><table><thead><tr><th style="text-align:center">Value</th><th style="text-align:left">Meaning</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:left">Not defined, see error message (if any).</td></tr><tr><td style="text-align:center">1</td><td style="text-align:left">File not found.</td></tr><tr><td style="text-align:center">2</td><td style="text-align:left">Access violation.</td></tr><tr><td style="text-align:center">3</td><td style="text-align:left">Disk full or allocation exceeded.</td></tr><tr><td style="text-align:center">4</td><td style="text-align:left">Illegal TFTP operation.</td></tr><tr><td style="text-align:center">5</td><td style="text-align:left">Unknown transfer ID.</td></tr><tr><td style="text-align:center">6</td><td style="text-align:left">File already exists.</td></tr><tr><td style="text-align:center">7</td><td style="text-align:left">No such user.</td></tr><tr><td style="text-align:center">8</td><td style="text-align:left">terminate the transfer</td></tr></tbody></table><p>其中<code>8</code>是最新<code>OACK</code>协商过程中的错误包, 属于新增。<br>ErrMsg: 反馈的错误描述(协议允许对端返回出错原因描述)</p><h5 id="协商流程"><a class="markdownIt-Anchor" href="#协商流程"></a> 协商流程</h5><p>如下描述了不支持扩展属性情况下的数据交互流程, 分为读写两个部分：</p><p><strong>读请求交互</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">client                                                 server<br>-------------------------------------------------------------<br>|<span class="hljs-number">1</span>|foofile|<span class="hljs-number">0</span>|octet|<span class="hljs-number">0</span>|  --&gt;                              RRQ<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">1</span>| <span class="hljs-number">512</span> octets of data |    DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">1</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">2</span>| <span class="hljs-number">512</span> octets of data |    DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">2</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">3</span>| <span class="hljs-number">512</span> octets of data |    DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">3</span>|  --&gt;                                              ACK<br>.....<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">99</span>| <span class="hljs-number">219</span> octets of data |   DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">99</span>|  --&gt;                                             ACK  <span class="hljs-comment">//传输结束</span><br></code></pre></td></tr></table></figure><p>上图中1, 4表示opcode, 其后的数字1,2,3,99表示块号。当最后一块219Byte数据发送(&lt;512Byte), 标识传输结束。当过程中出错, 交互会变成如下:</p><p><strong>出错交互</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">client                                                 server<br>-------------------------------------------------------------<br>|<span class="hljs-number">1</span>|foofile|<span class="hljs-number">0</span>|octet|<span class="hljs-number">0</span>|  --&gt;                              RRQ<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">1</span>| <span class="hljs-number">512</span> octets of data |    DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">1</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">2</span>| <span class="hljs-number">512</span> octets of data |    DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">2</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">3</span>| <span class="hljs-number">512</span> octets of data |    DATA<br>|<span class="hljs-number">5</span>|<span class="hljs-number">3</span>|Disk full or allocation exceeded | --&gt;             ERROR<br></code></pre></td></tr></table></figure><p>最后一包显示客户端磁盘满异常，传输结束。</p><p><strong>写请求交互</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">client                                                 server<br>-------------------------------------------------------------<br>|<span class="hljs-number">2</span>|barfile|<span class="hljs-number">0</span>|octet|<span class="hljs-number">0</span>|  --&gt;                              WRQ<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">0</span>|   ACK<br>|<span class="hljs-number">3</span>|<span class="hljs-number">1</span>| <span class="hljs-number">512</span> octets of data |  --&gt;                         DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">1</span>|   ACK<br>|<span class="hljs-number">3</span>|<span class="hljs-number">2</span>| <span class="hljs-number">512</span> octets of data |  --&gt;                         DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">2</span>|   ACK<br>|<span class="hljs-number">3</span>|<span class="hljs-number">3</span>| <span class="hljs-number">512</span> octets of data |  --&gt;                         DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">3</span>|   ACK<br>....<br>|<span class="hljs-number">3</span>|<span class="hljs-number">99</span>| <span class="hljs-number">199</span> octets of data |  --&gt;                        DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">99</span>|  ACK<br></code></pre></td></tr></table></figure><p>最后一包由于小于默认512Byte, 传输结束。</p><hr><h5 id="oack"><a class="markdownIt-Anchor" href="#oack"></a> OACK</h5><p>以上就是基础部分的协议内容, 针对基础协议部分, 在<code>RFC2348、RFC2347、RFC2349、RFC7440</code>中新增了扩展属性协商的内容, 并定义了新的属性协商响应包(<code>OACK</code>), 格式如下:</p><p>OACK格式:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">+----------+---~~---+---+---~~---+---+---~~---+---+---~~---+---+<br>|  opcode  |  opt1  | <span class="hljs-number">0</span> | value1 | <span class="hljs-number">0</span> |  optN  | <span class="hljs-number">0</span> | valueN | <span class="hljs-number">0</span> |<br>+----------+---~~---+---+---~~---+---+---~~---+---+---~~---+---+<br>````<br>* opc: <span class="hljs-number">6</span> 表示选项确认<br>* opt1: 第一个选项的确认, 从原始请求中拷贝过来<br>* value1: 服务端回应的协商值。<br><br>&amp;emsp;&amp;emsp;当服务的不支持扩展属性时, 将忽略相关的扩展属性, 直接回复`ACK`/`DATA`包。交互流程就是基础的交互流程。当服务的本身支持扩展属性, 服务端应该忽略不支持的属性(回复的`OACK`包中不携带相关属性), 另外, 服务的不应该回复客户端请求包中不包含的属性。当服务的认为相关属性合法后, 会返回支持的属性和值。另外，当服务检测到非法的操作或者不合理的属性值时，可以回复错误码<span class="hljs-number">8</span>的`ERROR`包。<br><br>目前最新支持的属性值列表:<br>* `blksize`:协商传输块大小(范围<span class="hljs-number">8</span><span class="hljs-number">-65464</span>)，没有协商默认<span class="hljs-number">512</span><br>* `timeout`: 协商超时时间, 单位s(timeout=<span class="hljs-number">1</span>, 表示<span class="hljs-number">1</span>s)<br>* `tsize`: 传输文件大小(`The Transfer Size`), 对于读, 该值为<span class="hljs-number">0</span>(tsize=<span class="hljs-number">0</span>), 如果文件过大, 可能会回复`ERROR`数据包<br>* `windowsize` : 有效值为(<span class="hljs-number">1</span><span class="hljs-number">-65535</span>), 指示连续发送的块数(最后一包发送完需要等待对端对最后一包的确认)务端回复值必须小于等于客户端请求值<br><br>##### 扩展协商请求流程<br>**读请求:**<br>```c<br>client                                                 server<br>--------------------------------------------------------------<br>|<span class="hljs-number">1</span>|foofile|<span class="hljs-number">0</span>|octet|<span class="hljs-number">0</span>|blksize|<span class="hljs-number">0</span>|<span class="hljs-number">1432</span>|<span class="hljs-number">0</span>|  --&gt;             RRQ<br>                            &lt;--  |<span class="hljs-number">6</span>|blksize|<span class="hljs-number">0</span>|<span class="hljs-number">1432</span>|<span class="hljs-number">0</span>|   OACK<br>|<span class="hljs-number">4</span>|<span class="hljs-number">0</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">1</span>| <span class="hljs-number">1432</span> octets of data |   DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">1</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">2</span>| <span class="hljs-number">1432</span> octets of data |   DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">2</span>|  --&gt;                                              ACK<br>                     &lt;--  |<span class="hljs-number">3</span>|<span class="hljs-number">3</span>|&lt;<span class="hljs-number">1432</span> octets of data |   DATA<br>|<span class="hljs-number">4</span>|<span class="hljs-number">3</span>|  --&gt;                                              ACK<br></code></pre></td></tr></table></figure><p><strong>写请求</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">client                                                 server<br>--------------------------------------------------------------<br>|<span class="hljs-number">2</span>|barfile|<span class="hljs-number">0</span>|octet|<span class="hljs-number">0</span>|blksize|<span class="hljs-number">0</span>|<span class="hljs-number">2048</span>|<span class="hljs-number">0</span>|  --&gt;             WRQ<br>                            &lt;--  |<span class="hljs-number">6</span>|blksize|<span class="hljs-number">0</span>|<span class="hljs-number">2048</span>|<span class="hljs-number">0</span>|   OACK<br>|<span class="hljs-number">3</span>|<span class="hljs-number">1</span>| <span class="hljs-number">2048</span> octets of data |  --&gt;                        DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">1</span>|   ACK<br>|<span class="hljs-number">3</span>|<span class="hljs-number">2</span>| <span class="hljs-number">2048</span> octets of data |  --&gt;                        DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">2</span>|   ACK<br>|<span class="hljs-number">3</span>|<span class="hljs-number">3</span>|&lt;<span class="hljs-number">2048</span> octets of data |  --&gt;                        DATA<br>                                           &lt;--  |<span class="hljs-number">4</span>|<span class="hljs-number">3</span>|   ACK<br></code></pre></td></tr></table></figure><p>除了协商块大小, 超时时间等以外, <code>TFTP</code>还支持窗口的协商用于加速传输的速率，适配不同设备之间的流控。假设窗口协商为4，如下是窗口交互流程。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">[ DRCV ]      &lt;---traffic---&gt;      [ DSND ]<br>  ACK#      -&gt;               &lt;-   Data Block<span class="hljs-meta">#   window block#</span><br>                     ...<br>                     &lt;-           |DB n+<span class="hljs-number">01</span>|          <span class="hljs-number">1</span><br>                     &lt;-           |DB n+<span class="hljs-number">02</span>|          <span class="hljs-number">2</span><br>                     &lt;-           |DB n+<span class="hljs-number">03</span>|          <span class="hljs-number">3</span><br>                     &lt;-           |DB n+<span class="hljs-number">04</span>|          <span class="hljs-number">4</span><br>|ACK n+<span class="hljs-number">04</span>|           -&gt;<br>                     &lt;-           |DB n+<span class="hljs-number">05</span>|          <span class="hljs-number">1</span><br>              Error |&lt;-           |DB n+<span class="hljs-number">06</span>|          <span class="hljs-number">2</span><br>                     &lt;-           |DB n+<span class="hljs-number">07</span>|          <span class="hljs-number">3</span><br>|ACK n+<span class="hljs-number">05</span>|           -&gt;<br>                     &lt;-           |DB n+<span class="hljs-number">06</span>|          <span class="hljs-number">1</span><br>                     &lt;-           |DB n+<span class="hljs-number">07</span>|          <span class="hljs-number">2</span><br>                     &lt;-           |DB n+<span class="hljs-number">08</span>|          <span class="hljs-number">3</span><br>                     &lt;-           |DB n+<span class="hljs-number">09</span>|          <span class="hljs-number">4</span><br>|ACK n+<span class="hljs-number">09</span>|           -&gt;<br>                     &lt;-           |DB n+<span class="hljs-number">10</span>|          <span class="hljs-number">1</span><br>              Error |&lt;-           |DB n+<span class="hljs-number">11</span>|          <span class="hljs-number">2</span><br>                     &lt;-           |DB n+<span class="hljs-number">12</span>|          <span class="hljs-number">3</span><br>|ACK n+<span class="hljs-number">10</span>|           -&gt;| Error<br>                     &lt;-           |DB n+<span class="hljs-number">13</span>|          <span class="hljs-number">4</span><br>                                 - timeout -<br>                     &lt;-           |DB n+<span class="hljs-number">10</span>|          <span class="hljs-number">1</span><br>                     &lt;-           |DB n+<span class="hljs-number">11</span>|          <span class="hljs-number">2</span><br>                     &lt;-           |DB n+<span class="hljs-number">12</span>|          <span class="hljs-number">3</span><br>                     &lt;-           |DB n+<span class="hljs-number">13</span>|          <span class="hljs-number">4</span><br>|ACK n+<span class="hljs-number">13</span>|           -&gt;<br>                     ...<br><br>        Section of a Windowsize = <span class="hljs-number">4</span> TFTP Transfer<br>           Including Errors and Error Recovery<br></code></pre></td></tr></table></figure><p>还需要注意一点, 一般服务端会绑定到知名端口<code>69</code>上, 客户端会过来请求。这时候服务端会新开一路<code>socket</code>进行交互, 确保服务器可以并发执行多路<code>tftp</code>传输。如下:</p><p><strong>写请求</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">client                                                 server<br>--------------------------------------------------------------<br>srcPort:<span class="hljs-number">5280</span> dstPort:<span class="hljs-number">69</span>                 --&gt;             WRQ<br>                       &lt;--  srcPort:<span class="hljs-number">5282</span> dstPort:<span class="hljs-number">5280</span>   ACK  #使用新端口<span class="hljs-number">5282</span>回复<br>srcPort:<span class="hljs-number">5280</span> dstPort:<span class="hljs-number">5282</span>               --&gt;             DATA<br>                       &lt;--  srcPort:<span class="hljs-number">5282</span> dstPort:<span class="hljs-number">5280</span>   ACK<br>srcPort:<span class="hljs-number">5280</span> dstPort:<span class="hljs-number">5282</span>               --&gt;             DATA<br>                       &lt;--  srcPort:<span class="hljs-number">5282</span> dstPort:<span class="hljs-number">5280</span>   ACK<br>srcPort:<span class="hljs-number">5280</span> dstPort:<span class="hljs-number">5282</span>               --&gt;             DATA<br>                       &lt;--  srcPort:<span class="hljs-number">5282</span> dstPort:<span class="hljs-number">5280</span>   ACK<br></code></pre></td></tr></table></figure><p>备注：</p><ul><li>服务端回复客户端协商请求数据包中，不得包含请求数据包中没有的协商属性</li><li>服务端不支持的属性, 应该在OACK包中省略，不应该发送ERROR数据包</li><li>如果协商中客户端支持的属性值是无效的, 服务端可以简单忽略或者产生一个错误码为8的ERROR数据包</li></ul><hr><h4 id="参考文档"><a class="markdownIt-Anchor" href="#参考文档"></a> 参考文档</h4><ul><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc1350">RFC 1350</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2348">RFC 2348</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2347">RFC 2347</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2349">RFC 2349</a></li><li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7440">RFC 7440</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" class="category-chain-item">网络协议</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%8E%9F%E5%88%9B-tftp/">#原创 - tftp</a></div></div><div class="license-box my-3"><div class="license-title"><div>tftp协议分析</div><div>http://example.com/2024/09/08/linux/tftserver/protocol/220626/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>EtcFly</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年9月8日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年11月4日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2024/09/08/openwrt/wireguard/213000/" title="使用wireguard组虚拟局域网"><span class="hidden-mobile">使用wireguard组虚拟局域网</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://lib.baomitu.com/waline/2.14.1/waline.min.css"),Fluid.utils.createScript("https://lib.baomitu.com/waline/2.14.1/waline.min.js",(function(){var i=Object.assign({serverURL:"https://etcfly.top:14000/",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://unpkg.com/@waline/emojis@1.1.0/qq"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/EtcFly" target="_blank" rel="nofollow noopener"><span>Copyright</span></a> <i class="iconfont icon-copyright"></i> <a href="https://etcfly.top:14100/share/yqTLFDlP/%E4%BB%97%E5%89%91%E8%B5%B0%E5%A4%A9%E6%B6%AF" target="_blank" rel="nofollow noopener"><span>2018-2024 EtcFly</span></a><div style="font-size:.85rem"><span>总访问量 <span style="color:#000" id="PVstatic">0</span> 次&nbsp</span> <span>总访客数 <span style="color:#000" id="UVstatic">0</span> 人&nbsp</span> <span>当前在线 <span style="color:#000" id="ACTstatic">0</span> 人&nbsp</span><script src="https://etcfly.top:14200/statistics" defer></script></div><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="js/duration.js"></script></div></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener"></a> </span><span><a href="http://beian.miit.gov.cn/2023000858" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" alt="police-icon"> <span>浙ICP备2023000858号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script><script src="/js/star.js"></script><script src="/js/ribbon.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>